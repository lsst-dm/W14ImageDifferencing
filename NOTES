
Installing and using PhoSim are relatively easy.  There are instructions here:
https://dev.lsstcorp.org/trac/wiki/IS_phosim_usability

Star_SEDS.dat contains the SEDs that go into the Galactic model.  Draw from these.

The files used for the W13 sims are:
/lsst/home/aconnolly/phosim/randomStars.2.seeing.0.6.trim
/lsst/home/aconnolly/phosim/randomStars.2.seeing.0.88.trim
/lsst/home/aconnolly/phosim/randomStars.2.seeing.1.2.trim
/lsst/home/aconnolly/phosim/randomStars.2.trim

NOTE: these are actually not at zero airmass!
  ZENITH  =        20.2906458698 / Zenith Angle (degrees)

I will want to use these to remake the sims anyways...
Note that the files for this can be found at:

  /lsst/home/aconnolly/imsim/starSED/

This needs to be CAT_SHARE_DATA.  At NCSA all installed at

  /nfs/lsst/home/becker/LSST/sims

##################
########## SIMS0
##################

Running the first set of sims (redoing W13) at
/nfs/lsst/home/becker/Winter2014/sims0.  Coped files from AJC and
modified.  Notes on fields:

 Exposure time is SIM_VISTIME
 Opsim_obshistid is the visit number
 Opsim_rawseeing is the requested seeing in arcseconds

./phosim examples/star -c examples/nobackground 

 star is a trim file
 nobackground is a control file.  need both

Which control file did AJC use?  I will start with

  /lsst/home/aconnolly/phosim/examples/clean.params.nobackground

for now

# Errors
# RuntimeError: randomStars.2.seeing.0.6.out does not exist.
> mkdir randomStars.2.seeing.0.6.out

# RuntimeError: randomStars.2.seeing.0.6.work does not exist.
> mkdir randomStars.2.seeing.0.6.work

# IOError: [Errno 2] No such file or directory: 'clean.params.nobackground'
>  -c clean.params.nobackground

python $PHOSIM_DIR/phosim.py randomStars.2.seeing.0.6.trim -w randomStars.2.seeing.0.6.work -o randomStars.2.seeing.0.6.out -c $PWD/clean.params.nobackground

# Can't find SED file: /nfs/lsst/home/becker/LSST/DMS/phosim/data/SEDs/starSED/kurucz/km50_5000.fits_g20_5140.gz
# RuntimeError: Error running /nfs/lsst/home/becker/LSST/DMS/phosim/bin/raytrace < raytrace_6866601_R13_S20_E001.pars
My dirs /nfs/lsst/home/becker/LSST/DMS/phosim/data/SEDs/starSED are incomplete
Use AJCs

pushd /nfs/lsst/home/becker/LSST/DMS/phosim/data/SEDs/starSED
mv kurucz kurucz_bad
mv mlt mlt_bad
mv wDs wDs_bad
mv gizis_SED gizis_SED_old
ln -s /lsst/home/aconnolly/phosim/data/SEDs/starSED/* .

# Works, but its running all the sensors back to back (6 hours apiece!)
Want to parallelize on sensor


-s R22_S00 
# Got raft but not sensor
------------------------------------------------------------------------------------------
Trim Catalog
------------------------------------------------------------------------------------------
Found 1027 source(s) for chip R22_S00.
Found 997 source(s) for chip R22_S01.
Found 1035 source(s) for chip R22_S02.
Found 1050 source(s) for chip R22_S10.
Found 1015 source(s) for chip R22_S11.
Found 999 source(s) for chip R22_S12.
Found 924 source(s) for chip R22_S20.
Found 1052 source(s) for chip R22_S21.
Found 968 source(s) for chip R22_S22.

It will guess how many photons its going to produce, and then print out every 10th of the way.
Per sensor and per snap

# OSError: [Errno 2] No such file or directory: 'randomStars.2.seeing.0.6.work'
> ?!


python $PHOSIM_DIR/phosim.py $PWD/randomStars.2.seeing.0.6.trim -w $PWD/randomStars.2.seeing.0.6.work -o $PWD/randomStars.2.seeing.0.6.out -c $PWD/clean.params.nobackground -s R22_S00

# OK, this worked, but had no background (see name of control file)

Got clean.params.beta from AJC:
zenith_v 23.0
backbeta 4
qevariation 0.0
raydensity 0.0
airglowvariation 0
cleartracking
clearperturbations
clearclouds
saturation 0
blooming 0

Now make a script to run on lsst-dev
 makeCommands.py
It needs to make the output dirs.  And it looks like I need a separate work/out dir for each process.  Make that also...


SIM_VISTIME 603.0 
means 300, 3, 300

For 1 snap (test me with shorter exptime)
SIM_VISTIME 300.0 
SIM_NSNAP 1


To move stuff around, use:
https://dev.lsstcorp.org/cgit/LSST/DMS/daf_replicate.git/tree/bin 	vdist_pt1_1.py

wget https://dev.lsstcorp.org/cgit/LSST/DMS/daf_replicate.git/plain/bin/vdist_pt1_1.py
# edit it
foreach i (*.out)
  cd $i
  python ../../vdist_pt1_1.py ../../inputs0 */*E000.fits.gz
  cd ../
  end

cd inputs0
setup obs_lsstSim -t v7_3
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .

# Note that I had to do some serious editing of vdist_pt1_1.py to get
  the output filename formats correct.  

# Registry built!

Don't forget the mapper...

echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> _mapper
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866603 raft=2,2 sensor=1,1 snap=0
# does not work?
# data exist
sqlite> select * from raw where visit=6866603 and raft="2,2" and sensor="1,1" and snap=0;

Ah, we made sure the raw/ images were in the right format by running
genInputRegistry.py.  But since we are processing eimage/, are image
names may be in the wrong format.  Which they appear to be.  I think
its the extra "0" in the directory names.

cd eimage/
mv v06866601-fi v6866601-fi
cd ../
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601 raft=2,2 sensor=1,1 snap=0
# BOOM!
RuntimeError: astrometry_net_data is not setup

Oops...  I will need to generate a astrometry_net_data product from
the trim catalogs since I will be changing the SEDs.

For now, you can use the astrometry.net data in /lsst8/krughoff/diffim_data.

setup -k -r /lsst8/krughoff/diffim_data/astrometry_net_data

#########3
ssh lsst-dev
cd Winter2014/inputs0/
setupLSST 
setup obs_lsstSim -t v7_3
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601^6866602^6866603^88868666 -j 10

##########
Boom! 
Now have a look at the image subtraction; use a nominal good configuration from W13

# original
setup -k -r /lsst8/krughoff/diffim_data/astrometry_net_data ;$PIPE_TASKS_DIR/bin/imageDifference.py /nfs/lsst8/krughoff/diffim_data/sparse_diffim_output_masked/ --id visit=6866601^6866602^6866603 --output=production10_sparse/borderMask0_order5_doPreConvolveFalse_alardDegGauss5_alardNGauss3 --configfile imageDifferenceConfig.py --config winter2013borderMask=0 diaSourceMatchRadius=2.0 doAddCalexpBackground=False useWinter2013Hacks=True winter2013templateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" >& production10_sparse/borderMask0_order5_doPreConvolveFalse_alardDegGauss5_alardNGauss3/stdout &

# modified
# shoot, i'll need to use my 2822 since it didn't get merged back to master
pushd ~/LSST/DMS/pipe_tasks/
git checkout tickets/2822
git pull
setup -k -r .
scons opt=3

pushd ~/LSST/DMS/ip_diffim/
git checkout tickets/2822
git pull
setup -k -r .
scons opt=3

cp ~/sparse_diffim/imageDifferenceConfig.py .

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs0 --id visit=6866601 --output=/nfs/lsst/home/becker/Winter2014/outputs0 --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9

######### Compare images

ds9 inputs0/calexp/v6866601-fi/R22/S11.fits /nfs/lsst8/krughoff/diffim_data/sparse_diffim_output_v7_2/calexp/v6866601-fi/R22/S11.fits 

# Different!   Big diff is:


< CREATOR = 'PHOSIM  '                                                            
< VERSION = 'ddd0d3460ab3425642ee4bee946a77ba9383caa4'                            
< BRANCH  = 'v3.3.2-6-gddd0d34'                                                   
< DATE    = '2013-11-22T01:56:21' / file creation date (YYYY-MM-DDThh:mm:ss UT)   
---
> CREATOR = 'LSST IMAGE SIMULATOR'                                                
> VERSION = 'a0621a928086b4f0407b757d316ecc04f122fc21'                            
> BRANCH  = 'v3.2.2  '                                                            
> DATE    = '2013-01-25T22:02:08' / file creation date (YYYY-MM-DDThh:mm:ss UT)   

pushd ~/LSST/DMS/phosim/

get v3.2.2
wget https://dev.lsstcorp.org/cgit/LSST/sims/phosim.git/snapshot/phosim-3.2.2.tar.gz
hmm this version is very different

ln -s $PHOSIM_DIR/default_instcat 

##################
########## SIMS1
##################

[becker@lsst-dev sims1]$ /lsst/home/becker/LSST/DMS/phosim-3.2.2/bin/atmosphere < randomStars.2.seeing.0.6.work/R22_S00/obs_6866601.pars 
------------------------------------------------------------------------------------------
Atmosphere Creator
------------------------------------------------------------------------------------------
Segmentation fault


cd $PHOSIM_DIR/data/SEDs/
ln -s ../../../phosim/data/SEDs/* .

####################

python $PHOSIM_DIR/phosim /lsst/home/becker/Winter2014/sims1/randomStars.2.seeing.0.6.trim -w /lsst/home/becker/Winter2014/sims1/randomStars.2.seeing.0.6.work/R22_S00 -o /lsst/home/becker/Winter2014/sims1/randomStars.2.seeing.0.6.out/R22_S00 -c /lsst/home/becker/Winter2014/sims1/clean.params.beta -s R22_S00 -b $PHOSIM_DIR/bin/ -d $PHOSIM_DIR/data/


# Grr, have to use 3.3.2 package
# Redo in /nfs/lsst/home/becker/Winter2014/sims1

ds9 randomStars.2.seeing.0.6.out/R22_S00/lsst_e_6866601_f3_R22_S00_E000.fits.gz  /nfs/lsst8/krughoff/diffim_data/sparse_diffim_output_v7_2/_parent/eimage/v6866601-fi/E000/R22/eimage_6866601_R22_S00_E000.fits.gz

#####

3.3.2 still has the damn borders...

Need to revert all the way to 3.2.2 and deal with the segfaults

##################
########## SIMS2
##################

# Grrr apparently I have to run it in the sims dir!!!

cd ~/LSST/DMS/phosim-3.2.2/

python phosim ~/Winter2014/sims2/randomStars.2.seeing.0.6.trim -p 5 -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -o randomStars.2.seeing.0.6.out -w randomStars.2.seeing.0.6.work &

python phosim ~/Winter2014/sims2/randomStars.2.seeing.0.88.trim -p 5 -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -o randomStars.2.seeing.0.88.out -w randomStars.2.seeing.0.88.work &

python phosim ~/Winter2014/sims2/randomStars.2.seeing.1.2.trim -p 5 -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -o randomStars.2.seeing.1.2.out -w randomStars.2.seeing.1.2.work &

python phosim ~/Winter2014/sims2/randomStars.2.template.trim -p 16 -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -o randomStars.2.template.out -w randomStars.2.template.work &


These images have messed up backgrounds.  Something is clearly wrong here...

####

According to the ticket I filed with John, the borders in 3.2.2 can be
turned off with "fieldanisotropy 0" in the command file.  Sigh, I
guess I try this next.

##################
########## SIMS3
##################


cd sims3
 doit
cd ../
mv vdist_pt1_1.py rename_images.py
mkdir 
inputs3
cd sims3/
foreach i (*.out)
  cd $i
  python ../../rename_images.py ../../inputs3 */*E000.fits.gz
  cd ../
  end
cd ../
cd inputs3
setup obs_lsstSim -t v7_3
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .
  ./raw/v88868666-fi ... started
  ./raw/v88868666-fi/E000/R22 ... 112 processed, 0 skipped, 0 unrecognized
  ./raw/v88868666-fi ... completed
  ./raw/v06866602-fi ... started
  ./raw/v06866602-fi/E000/R22 ... 144 processed, 0 skipped, 0 unrecognized
  ./raw/v06866602-fi ... completed
  ./raw/v06866601-fi ... started
  ./raw/v06866601-fi/E000/R22 ... 144 processed, 0 skipped, 0 unrecognized
  ./raw/v06866601-fi ... completed
  ./raw/v06866603-fi ... started
  ./raw/v06866603-fi/E000/R22 ... 144 processed, 0 skipped, 0 unrecognized
  ./raw/v06866603-fi ... completed

  # might be missing some data in 88868666 but lets not worry about it for now

echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> _mapper
cd eimage/
mv v06866601-fi v6866601-fi
mv v06866602-fi v6866602-fi
mv v06866603-fi v6866603-fi
cd ../
setup -k -r /lsst8/krughoff/diffim_data/astrometry_net_data
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601  raft=2,2 sensor=1,1 snap=0
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866602  raft=2,2 sensor=1,1 snap=0
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866603  raft=2,2 sensor=1,1 snap=0
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=88868666 raft=2,2 sensor=1,1 snap=0


# until I get 2822 tagged
setup -k -r ~/LSST/DMS/obs_lsstSim/
setup -k -r ~/LSST/DMS/pipe_tasks/
setup -k -r ~/LSST/DMS/ip_diffim


cd /nfs/lsst/home/becker/Winter2014/
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs3 --id visit=6866601 --output=/nfs/lsst/home/becker/Winter2014/outputs3 --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9

If I hit up arrow, I find

  AssertionError: config is of type lsst.pex.config.config.Config instead of lsst.pipe.tasks.imageDifference.Winter2013ImageDifferenceConfig

Solution is to clobber the config:

  --clobber-config

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs3 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9 --clobber-config
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs3 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9 --clobber-config
 
# Data output dirs are at:
/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveFalse
/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveTrue

# Compare
ds9 ~/sparse_diffim/production10_sparse/borderMask0_order5_doPreConvolveTrue_alardDegGauss5_alardNGauss3/deepDiff/v6866603-fi/R22/diffexp-S11.fits outputs3_doPreConvolveTrue/deepDiff/v6866603-fi/R22/diffexp-S11.fits


#######################

Validating the results on darkstar
Use 

/astro/users/acbecker/python/LSST/winter2013_countDiaSources.py

I need to add the _mapper to each directory:
echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> outputs3_doPreConvolveFalse/_mapper
echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> outputs3_doPreConvolveTrue/_mapper

python winter2013_countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1

Unfortunately, pipe_base has changed so datasetType="deepDiff_diaSrc"
does not work anymore.  I need to track this down...

# Add:
        parser.add_id_argument(name="--id", datasetType="deepDiff_diaSrc", 
                               help="data ID, e.g. --id visit=6866601 raft=2,2 sensor=1,1", level="sensor")

# However, 
  RuntimeError: No registry for lookup

rm outputs3_doPreConvolve*/_parent
scp becker@lsst5.ncsa.uiuc.edu:/nfs/lsst/home/becker/Winter2014/outputs3/_parent/registry.sqlite3 .
cd outputs3_doPreConvolveFalse/; ln -s ../ _parent; cd ../
cd outputs3_doPreConvolveTrue/; ln -s ../ _parent; cd ../

#
python winter2013_countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1


#####

FINALLY, able to compare R22S11

Before:
 6866601
   False 23 0 23
   True 10 0 10
 6866602
   False 8 0 8
   True 7 0 7
 6866603
   False 7 0 7
   True 3 0 3

After:
 6866601
  False 68676 595 67451
  True 25 7 18
 6866602
  False 8 0 8
  True 8 0 8
 6866603
  False 5 0 5
  True 11 5 5


Ruh roh...  Make sure its not the software.  Re-run the W13 data
#########

$OBS_LSSTSIM_DIR/bin/processEimage.py /nfs/lsst8/krughoff/diffim_data/sparse_diffim_data --id visit=6866601  raft=2,2 sensor=1,1 snap=0 --output=inputs_W13
$OBS_LSSTSIM_DIR/bin/processEimage.py /nfs/lsst8/krughoff/diffim_data/sparse_diffim_data --id visit=6866602  raft=2,2 sensor=1,1 snap=0 --output=inputs_W13
$OBS_LSSTSIM_DIR/bin/processEimage.py /nfs/lsst8/krughoff/diffim_data/sparse_diffim_data --id visit=6866603  raft=2,2 sensor=1,1 snap=0 --output=inputs_W13
$OBS_LSSTSIM_DIR/bin/processEimage.py /nfs/lsst8/krughoff/diffim_data/sparse_diffim_data --id visit=88868666 raft=2,2 sensor=1,1 snap=0 --output=inputs_W13

AttributeError: 'module' object has no attribute 'SOURCE_IO_NO_HEAVY_FOOTPRINTS'
# soln temporary edit to /lsst/home/becker/LSST/DMS/pipe_tasks/python/lsst/pipe/tasks/processImage.py

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs_W13 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs_W13_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9 --clobber-config

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs_W13 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs_W13_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9 --clobber-config

Re-reduction of W13 data with v7_2 stack:
 6866601
  False 72 11 58
  True 26 14 12
 6866602
  False 26 15 10
  True 29 15 13
 6866603
  False 12 0 10
  True 19 6 10


######  OK, go into the metatdata:

python getMetadata.py

# Alard Lupton configuration, basically the same

AL W13 0 6866601          (3, 3, 3)   3   (1.0346439501149352, 1.6359157248384133, 3.0164795507064537)   21
AL W13 0 6866602          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W13 0 6866603          (5, 2, 2)   3   (0.9640382144169239, 1.9280764288338479, 3.8561528576676958)   23
AL W13 1 6866601          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W13 1 6866602          (5, 2, 2)   3   (1.05426653096716, 2.10853306193432, 4.21706612386864)         25
AL W13 1 6866603          (5, 2, 2)   3   (1.7196911219080573, 3.4393822438161146, 6.878764487632229)    35

AL W14 of W13 0 6866601   (3, 3, 3)   3   (1.0391950633819946, 1.6431116667450725, 3.029748211970562)    21
AL W14 of W13 0 6866602   (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 of W13 0 6866603   (5, 2, 2)   3   (0.9743323439412189, 1.9486646878824379, 3.8973293757648757)   23
AL W14 of W13 1 6866601   (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 of W13 1 6866602   (5, 2, 2)   3   (1.0558307509687426, 2.111661501937485, 4.22332300387497)      25
AL W14 of W13 1 6866603   (5, 2, 2)   3   (1.7326271689296666, 3.4652543378593332, 6.9305086757186665)   35

# The WCS RMS basically the same:

SIP_RMS W13        0 6866601 0.0186791582901
SIP_RMS W13        0 6866602 0.0248329278293
SIP_RMS W13        0 6866603 0.0319371189512
SIP_RMS W13        1 6866601 0.0186791582901
SIP_RMS W13        1 6866602 0.0248329278293
SIP_RMS W13        1 6866603 0.0319371189512

SIP_RMS W14 of W13 0 6866601 0.0186232749509
SIP_RMS W14 of W13 0 6866602 0.024978827538
SIP_RMS W14 of W13 0 6866603 0.0320761094344
SIP_RMS W14 of W13 1 6866601 0.0186232749509
SIP_RMS W14 of W13 1 6866602 0.024978827538
SIP_RMS W14 of W13 1 6866603 0.0320761094344

# Log at log outputs
/nfs/lsst8/becker/sparse_diffim/production10_sparse/borderMask0_order5_doPreConvolveTrue_alardDegGauss5_alardNGauss3/stdout

imageDifference: Processing {'filter': 'i', 'raft': '2,2', 'sensor': '1,1', 'visit': 6866603}
imageDifference WARNING: USING WINTER2013 HACK: DEEP CALEXP AS TEMPLATE
imageDifference: Source selection via src product
imageDifference: Selected 647 / 827 sources for Psf matching (162 for control sample)
imageDifference: Registering images
imageDifference.register: Matching within 1.0 arcsec: 796 matches
imageDifference.register: Registration WCS: final WCS RMS=0.031937 pixels from 774 matches
imageDifference: Subtracting images
imageDifference.subtract: Template Wcs : 1.389584,-0.166863 -> 1.392097,-0.171814
imageDifference.subtract: Science Wcs : 1.389584,-0.166863 -> 1.392097,-0.171814
imageDifference.subtract: Growing 647 kernel candidate stars by 35 pixels
imageDifference.subtract: Selected 618 / 647 sources for KernelCandidacy
imageDifference.subtract: Matching Psf FWHM 4.94 -> 9.48 pix
imageDifference.subtract: Final spatial kernel sum 0.050
imageDifference.subtract: Spatial model condition number 7.269e+09
imageDifference.subtract: Doing stats of kernel candidates used in the spatial fit.
imageDifference.subtract: 618 candidates total, 0 rejected, 617 used
imageDifference.subtract: Spatial kernel model well constrained; 617 candidates, 21 terms, 33 bases
imageDifference.subtract: Spatial background model appears well constrained; 617 candidates, 3 terms
imageDifference: Running diaSource detection
imageDifference.detection: Detected 0 positive sources to 5 sigma.
imageDifference.detection: Detected 3 negative sources to 5 sigma
imageDifference: Merging detections into 3 sources
imageDifference: Running diaSource measurement
imageDifference.dipolemeasurement: Measuring 3 sources
imageDifference: Running diaSource measurement
imageDifference.dipolemeasurement: Measuring 3 sources
imageDifference.dipolemeasurement: Applying aperture correction to 3 sources
imageDifference.dipolemeasurement: Classifying 3 sources
imageDifference: Matched 0 / 3 diaSources to sources
meas.astrom WARNING: No matches found between input sources and reference catalogue.
imageDifference WARNING: No diaSource matches with reference catalog
imageDifference: Evaluating metrics and control sample
imageDifference: Growing 162 kernel candidate stars by 35 pixels
imageDifference: Selected 152 / 162 sources for KernelCandidacy

# VS

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs_W13 --id visit=6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs_W13_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" -j 9 --clobber-config

winter2013ImageDifference: Processing {'filter': 'i', 'raft': '2,2', 'sensor': '1,1', 'visit': 6866603}
winter2013ImageDifference WARNING: USING WINTER2013 : DEEP CALEXP AS TEMPLATE
winter2013ImageDifference: Source selection via src product
lsst.ip.diffim.DiaCatalogSourceSelector WARNING: Cannot cut on color info; fields 'g' and 'r' do not exist
winter2013ImageDifference: Selected 162 / 830 sources for Psf matching (162 for control sample)
winter2013ImageDifference: Registering images
winter2013ImageDifference.register: Matching within 1.0 arcsec: 798 matches
winter2013ImageDifference.register: Registration WCS: final WCS RMS=0.032076 pixels from 770 matches
winter2013ImageDifference: Subtracting images
winter2013ImageDifference.subtract: Template Wcs : 1.389584,-0.166863 -> 1.392097,-0.171814
winter2013ImageDifference.subtract: Science Wcs : 1.389584,-0.166863 -> 1.392097,-0.171814
winter2013ImageDifference.subtract: Growing 162 kernel candidate stars by 35 pixels
winter2013ImageDifference.subtract: Selected 155 / 162 sources for KernelCandidacy
winter2013ImageDifference.subtract: Matching Psf FWHM 4.95 -> 9.54 pix
winter2013ImageDifference.subtract: Final spatial kernel sum 0.050
winter2013ImageDifference.subtract: Spatial model condition number 9.816e+09
winter2013ImageDifference.subtract: Doing stats of kernel candidates used in the spatial fit.
winter2013ImageDifference.subtract: 155 candidates total, 0 rejected, 155 used
winter2013ImageDifference.subtract: Spatial kernel model well constrained; 155 candidates, 21 terms, 33 bases
winter2013ImageDifference.subtract: Spatial background model appears well constrained; 155 candidates, 3 terms
winter2013ImageDifference: Running diaSource detection
winter2013ImageDifference.detection: Detected 11 positive sources to 5 sigma.
winter2013ImageDifference.detection: Detected 11 negative sources to 5 sigma
winter2013ImageDifference: Merging detections into 22 sources
winter2013ImageDifference: Running diaSource measurement
winter2013ImageDifference.dipoleMeasurement: Measuring 22 sources
winter2013ImageDifference.dipoleMeasurement: Classifying 22 sources
winter2013ImageDifference: Matched 6 / 22 diaSources to sources
winter2013ImageDifference: Matched 6 / 22 diaSources to reference catalog
winter2013ImageDifference: Evaluating metrics and control sample
winter2013ImageDifference: Growing 162 kernel candidate stars by 35 pixels
winter2013ImageDifference: Selected 155 / 162 sources for KernelCandidacy

# BIG DIFF:

imageDifference: Selected 647 / 827 sources for Psf matching (162 for control sample)
 vs
winter2013ImageDifference: Selected 162 / 830 sources for Psf matching (162 for control sample)

So something going wrong with control sample. One of Paul's wacky one-line fixes was wrong:

   kernelSources = [k for i,k in enumerate(kernelSources) if not i % self.config.controlStepSize]

should be

   kernelSources = [k for i,k in enumerate(kernelSources) if i % self.config.controlStepSize]

FIXED.

RERAN

###############

New:
6866601
  False 69850 580 68630
  True 17 0 17
6866602
  False 6 0 6
  True 6 0 6
6866603
  False 3 0 3
  True 3 0 3

Orig:
6866601
  False 23 0 23
  True 10 0 10
6866602
  False 8 0 8
  True 7 0 7
6866603
  False 7 0 7
  True 3 0 3


Rerun of W13:
6866601
  False 19 0 19
  True 10 0 10
6866602
  False 9 0 8
  True 7 0 6
6866603
  False 7 0 7
  True 3 0 3

These basically vaidate the W14 sims, although the good seeing data
clearly have some issues.  Get new sims running over the christmas break

# Good seeing data:

Look again at the AL sizes:         
                          DegGauss NGauss SigGauss                                                  KernelSize

AL W13 0 6866601          (3, 3, 3)   3   (1.0346439501149352, 1.6359157248384133, 3.0164795507064537)   21
AL W13 0 6866602          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W13 0 6866603          (5, 2, 2)   3   (0.9640382144169239, 1.9280764288338479, 3.8561528576676958)   23
AL W13 1 6866601          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W13 1 6866602          (5, 2, 2)   3   (1.05426653096716, 2.10853306193432, 4.21706612386864)         25
AL W13 1 6866603          (5, 2, 2)   3   (1.7196911219080573, 3.4393822438161146, 6.878764487632229)    35

AL W14 of W13 0 6866601   (3, 3, 3)   3   (1.0391950633819946, 1.6431116667450725, 3.029748211970562)    21
AL W14 of W13 0 6866602   (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 of W13 0 6866603   (5, 2, 2)   3   (0.9743323439412189, 1.9486646878824379, 3.8973293757648757)   23
AL W14 of W13 1 6866601   (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 of W13 1 6866602   (5, 2, 2)   3   (1.0558307509687426, 2.111661501937485, 4.22332300387497)      25
AL W14 of W13 1 6866603   (5, 2, 2)   3   (1.7326271689296666, 3.4652543378593332, 6.9305086757186665)   35

AL W14 0 6866601          (3, 3, 3)   3   (1.9583640625034533, 3.0964454626656313, 5.709563320525726)    33 [*] 
AL W14 0 6866602          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 0 6866603          (5, 2, 2)   3   (0.8668032144801899, 1.7336064289603799, 3.4672128579207597)   21 [*]
AL W14 1 6866601          (5, 2, 2)   3   (0.7, 1.4, 2.8)                                                21
AL W14 1 6866602          (5, 2, 2)   3   (1.0077872240988166, 2.015574448197633, 4.031148896395266)     25
AL W14 1 6866603          (5, 2, 2)   3   (1.577239573540838, 3.154479147081676, 6.308958294163352)      35

Getting different gaussian sizes with the new data.  Leading to different size kernels...

Track it down...

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs_W13 --id visit=6866601 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs_W13_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config

(Pdb) print targetFwhmPix, referenceFwhmPix, basisDegGauss
4.94702772684 3.53501294547 None
(Pdb)  targetSigma    = targetFwhmPix / sigma2fwhm
(Pdb) referenceSigma = referenceFwhmPix / sigma2fwhm
(Pdb) kernelSigma = np.sqrt(targetSigma**2 - referenceSigma**2)
(Pdb) print kernelSigma
1.46964375259

###

(Pdb) print targetFwhmPix, referenceFwhmPix, basisDegGauss
4.67415834003 3.34878368918 None
(Pdb)     targetSigma    = targetFwhmPix / sigma2fwhm
(Pdb)     referenceSigma = referenceFwhmPix / sigma2fwhm
(Pdb) kernelSigma = np.sqrt(targetSigma**2 - referenceSigma**2)
(Pdb) print kernelSigma
1.38477250863

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs3 --id visit=6866601 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config

###

So maybe this is just a difference in PSF FWHM?

ds9 /lsst/home/becker/sparse_diffim/production10_sparse/borderMask0_order5_doPreConvolveFalse_alardDegGauss5_alardNGauss3/deepDiff/v6866601-fi/R22/diffexp-S11.fits /nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveFalse/deepDiff/v6866601-fi/R22/diffexp-S11.fits  &

ds9 /lsst/home/becker/sparse_diffim/production10_sparse/borderMask0_order5_doPreConvolveTrue_alardDegGauss5_alardNGauss3/deepDiff/v6866601-fi/R22/diffexp-S11.fits /nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveTrue/deepDiff/v6866601-fi/R22/diffexp-S11.fits &

# Compare Psfs in sims3 to the actual W13 images
python psfSims.py
88868666 (2.9708217701797941, -0.90226511693166078, 0.5941643540359588) vs new (2.8070390495831492, 1.5361212420460129, 0.56140780991662986)
6866601 (2.1225226439401093, -1.0052565694085889, 0.42450452878802186) vs new (2.0111389692939103, -1.3830145817656698, 0.4022277938587821)
6866602 (2.9782904413582707, -0.88339653909964322, 0.59565808827165412) vs new (2.8288520874099796, 0.38638362896011058, 0.56577041748199597)
6866603 (4.0522824154960375, -1.0496423137259874, 0.81045648309920759) vs new (3.7268387769974196, 0.58588650638106177, 0.74536775539948397)

But this comes from IXX, etc.  Not clear how this maps to sigma/FWHM.  Here are FWHM from adaptive second moments

#         FWHM               In arcsec                                                              Spec
---------------------------------------------------------------------------------------------------------
88868666 (4.952654636133401,  0.99053092722668024) vs new (4.6788783599351298, 0.93577567198702605)  0.88"
6866601  (3.5371799214415871, 0.70743598428831744) vs new (3.3511901325143629, 0.67023802650287267)  0.6"
6866602  (4.9645199105545794, 0.99290398211091591) vs new (4.7165206204667589, 0.94330412409335185)  0.88"
6866603  (6.7467488466458434, 1.3493497693291687)  vs new (6.210880153196336,  1.2421760306392673)   1.2"


OK, so everything looks OK.  I see 3 things at work here:

 * The deconvolution parameters are extremely sensitive to the inputs (AL W14 0 6866601)
 * The minimum gaussian size might be too small (AL W14 1 6866601) and the better seeing data hit against this.
 * Actually get more false postives since the seeing is better
 
Try another run with smaller minimum sizes?

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs3 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveTrue_test --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" subtract.kernel.active.alardMinSig=0.6 -j 9 --clobber-config

# Don't forget to copy _mapper in there...
python winter2013_countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1
 True 17 0 17
# and
python getMetadata.py 
 AL W14 small 0 6866601   (5, 2, 2)   3   (0.6, 1.2, 2.4)   21
# Still too small!

# Down to 0.5 pixels
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py /nfs/lsst/home/becker/Winter2014/inputs3 --id visit=6866601^6866602^6866603 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs3_doPreConvolveTrue_test --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=88868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" subtract.kernel.active.alardMinSig=0.5 -j 9 --clobber-config

# TOO SMALL!
 True 40 16 24
 AL W14 small 0 6866601   (5, 2, 2)   3   (0.5, 1.0, 2.0)   21

##################
########## SIMS4
##################

Lets take these input trim files, and we'll add in the SEDs that we
did the DCR analysis with.  The majority of objets will be G0V stars,
with say 10% blue (A0V) and 10% red (M2.0V) stars.  SEDs are:

A0V: kp01_9750.fits_g45_9830.gz
G0V: km20_6000.fits_g30_6020.gz
M2V: m2.0Full.dat

I'll do a set of sims that are actually at 0 airmass 
  Unrefracted_Altitude 90.0
and then ones at airmass 1.06
  Unrefracted_Altitude 69.7093541302
and then ones at airmass 1.5
  Unrefracted_Altitude 48.0

Script makeNewTrims.py

There are 22000 objects in each trim file
We want 2200 A0V and 2200 M2V and 17600 G0V

if (oid % 10) == 0:
    star = A0V
elif (oid % 10) == 5:
    star = M2V
else:
    star = G0V

python makeNewTrims.py sims3/randomStars.2.seeing.1.2.trim > sims4/randomStars.2.seeing.1.2.trim

[becker@lsst5 ~/Winter2014]$ grep kp01_9750.fits_g45_9830.gz sims4/randomStars.2.seeing.1.2.trim | wc -l
2200
[becker@lsst5 ~/Winter2014]$ grep km20_6000.fits_g30_6020.gz sims4/randomStars.2.seeing.1.2.trim | wc -l
17600
[becker@lsst5 ~/Winter2014]$ grep m2.0Full.dat sims4/randomStars.2.seeing.1.2.trim | wc -l
2200

python makeNewTrims.py  sims3/randomStars.2.seeing.0.6.trim > sims4/randomStars.2.seeing.0.6.trim
python makeNewTrims.py sims3/randomStars.2.seeing.0.88.trim > sims4/randomStars.2.seeing.0.88.trim
python makeNewTrims.py sims3/randomStars.2.template.trim > sims4/randomStars.2.template.trim

cp ../sims3/SOURCE_ME .
cp ../sims3/SETUP .
cp ../sims3/clean.params.beta .
cp ../sims3/makeCommands.py .
# Have to run this to make the output dirs
python makeCommands.py 
source SETUP 
source SOURCE_ME

#########
Can't find SED file: /lsst/home/becker/LSST/DMS/phosim-3.3.2/data/SEDs/starSED/mlt/m2.0Full.dat

Oops, should be .dat.gz

Running.  

In v3.3.2 eimages are    lsst_e_6866602_f3_R22_S00_E000.fits.gz 
          amp images are lsst_a_6866601_f3_R22_S00_C01_E000.fits.gz

mkdir inputs4
cd sims4/
foreach i (*.out)
 cd $i
 python ../../rename_images.py ../../inputs4 */*E000.fits.gz
 cd ../
 end
cd ../inputs4

setup obs_lsstSim -t v7_3  # NOTE THAT I HAVE TO RE-SET UP MY TICKET PACKAGES
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .

setup -k -r ~/LSST/DMS/pipe_tasks/
setup -k -r ~/LSST/DMS/ip_diffim/
setup -k -r ~/LSST/DMS/obs_lsstSim/

echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> _mapper
setup -k -r /lsst8/krughoff/diffim_data/astrometry_net_data

$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601^6866602^6866603^88868666 -j 10

#  RuntimeError: Unable to match sources with catalog.
Duh have to make a new index file

Information is in:
  /lsst2/krughoff/astrometry_net_data/imsim-2012-06-20-0/
  /lsst2/krughoff/astrometry_net_data/imsim-2012-06-20-0/README_simon

Start with a trim_to_ref.py script and go from there.
python python/trim_to_ref.py randomStars.2.seeing.0.6.trim > randomStars.2.seeing.0.6.ref
setup -r /lsst/home/krughoff/lsst/lsst_devel/Linux64/astrometry.net-0.38/astrometry
text2fits.py randomStars.2.seeing.0.6.ref randomStars.2.seeing.0.6.fits
fitscopy randomStars.2.seeing.0.6.fits"[col id;ra=raj2000;dec=decj2000;u=uderived;g=gderived;r=rderived;i=iderived;z=zderived;y=yderived;starnotgal=isstar;mura=propermotionra;mudec=propermotiondec;parallax;variable=varclass]" foo.fits
setenv P 1206200
build-index -i foo.fits -o index-${P}00.fits -I ${P}00 -P 0 -S r -n 100 -L 20 -E -j 0.4 -r 1
build-index -1 index-${P}00.fits -o index-${P}01.fits -I ${P}01 -P 1 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}02.fits -I ${P}02 -P 2 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}03.fits -I ${P}03 -P 3 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}04.fits -I ${P}04 -P 4 -S r -L 20 -E -M -j 0.4 
ls index-1206200* | awk '{printf("modhead %s+7 REFCAT 'imsim-stars-2012-06-20_gals-2012-06-20'\n",$1)}' | sh     

# Some of these steps seem unncessary; adjust trim_to_ref.py to avoid
# having to run fitscopy
python python/trim_to_ref.py /tmp/randomStars.2.seeing.0.6.trim > /tmp/randomStars.2.seeing.0.6.ref
text2fits.py randomStars.2.seeing.0.6.ref randomStars.2.seeing.0.6.fits
build-index -i randomStars.2.seeing.0.6.fits -o index-${P}00.fits -I ${P}00 -P 0 -S r -n 100 -L 20 -E -j 0.4 -r 1
build-index -1 index-${P}00.fits -o index-${P}01.fits -I ${P}01 -P 1 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}02.fits -I ${P}02 -P 2 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}03.fits -I ${P}03 -P 3 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}04.fits -I ${P}04 -P 4 -S r -L 20 -E -M -j 0.4 
ls index-1206200* | awk '{printf("modhead %s+7 REFCAT 'randomStars.2.seeing.0.6'\n",$1)}' | sh     

# And try it out...
mkdir astrometry_net_data
mkdir astrometry_net_data/ups
touch astrometry_net_data/ups/astrometry_net_data.table 
setup -k -r astrometry_net_data
cd ../inputs4/
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601^6866602^6866603^88868666 -j 10

# IOError: [Errno 2] No such file or directory: '/nfs/lsst/home/becker/Winter2014/astrometry_net_data/andConfig.py'
cp /lsst8/krughoff/diffim_data/astrometry_net_data/andConfig.py  ../astrometry_net_data/

# ALSO A NOTE: 1206200 is supposed to correspond to the date; change next time

#processEimage.calibrate.astrometry WARNING: No CCD associated with exposure; assuming null distortion
#processEimage.calibrate.astrometry: Null distortion correction
#processEimage.calibrate.astrometry: Solving astrometry
#processEimage.calibrate.astrometry WARNING: Unable to find any index files
#processEimage.calibrate.astrometry WARNING: Did not get an astrometric solution from Astrometry.net
# DUH
mv ../index-12062000* ../astrometry_net_data/

# Still same errors
OK, this has to do with the andConfig.py script, which lists the index files.  Redo with correct dates.
setenv P 1401080
build-index -i randomStars.2.seeing.0.6.fits -o index-${P}00.fits -I ${P}00 -P 0 -S r -n 100 -L 20 -E -j 0.4 -r 1
build-index -1 index-${P}00.fits -o index-${P}01.fits -I ${P}01 -P 1 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}02.fits -I ${P}02 -P 2 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}03.fits -I ${P}03 -P 3 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}04.fits -I ${P}04 -P 4 -S r -L 20 -E -M -j 0.4 
ls index-1401080* | awk '{printf("modhead %s+7 REFCAT 'randomStars.2.seeing.0.6'\n",$1)}' | sh     

# 0: Message: Unable to read data for i_err from /nfs/lsst/home/becker/Winter2014/astrometry_net_data/index-140108000.fits
Hmm, so I am missing some info...  I should just be able to put this in the original script, yes?

There is info on this in $MEAS_ASTROM_DIR/python/lsst/meas/astrom/config.py

Kinda works; fails but not for any obvious reason, hoping its that the
SEDs are wrong.  Continue on this path down below for SIMS5.


# ALSO, I will probably need to adjust the magnitudes of the sources
  sice I did not take into account their relative brightnesses in
  I-band.  Do this while waiting for Simon to make astrometry.net
  script. [I actually made the script above]

##################
########## SIMS5
##################

From DCR.py, the flux in the i-band (bandpass 2 there)
                                  2.5 log10(f/fG0V)
FLUX 2 0 543443285879.0    A0V   -0.783  # make this much brighter
FLUX 2 1 1.11848298486e+12 G0V     0.0
FLUX 2 2 6.77216202646e+12 M2V    1.955  # make this much fainter

python makeNewTrims.py sims3/randomStars.2.seeing.1.2.trim > sims5/randomStars.2.seeing.1.2.trim

# Check fainter M
[becker@lsst-dev ~/Winter2014]$ grep "object 15 " sims[3,5]/randomStars.2.seeing.1.2.trim
sims3/randomStars.2.seeing.1.2.trim:object 15    80.030254   -9.5286406 19.690825 starSED/kurucz/km50_5000.fits_g20_5140.gz 0. 0. 0. 0. 0. 0. star none none
sims5/randomStars.2.seeing.1.2.trim:object 15    80.030254   -9.5286406 21.64583 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none

# Check same G
[becker@lsst-dev ~/Winter2014]$ grep "object 16 " sims[3,5]/randomStars.2.seeing.1.2.trim
sims3/randomStars.2.seeing.1.2.trim:object 16     79.30348   -9.8977345 19.120024 starSED/kurucz/km50_5000.fits_g20_5140.gz 0. 0. 0. 0. 0. 0. star none none
sims5/randomStars.2.seeing.1.2.trim:object 16     79.30348   -9.8977345 19.120024 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none

# Check brighter A
[becker@lsst-dev ~/Winter2014]$ grep "object 20 " sims[3,5]/randomStars.2.seeing.1.2.trim
sims3/randomStars.2.seeing.1.2.trim:object 20    79.498173   -9.5676676 19.467401 starSED/kurucz/km50_5000.fits_g20_5140.gz 0. 0. 0. 0. 0. 0. star none none
sims5/randomStars.2.seeing.1.2.trim:object 20    79.498173   -9.5676676 18.68440 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none

# OK!

python makeNewTrims.py sims3/randomStars.2.seeing.0.6.trim  > sims5/randomStars.2.seeing.0.6.trim
python makeNewTrims.py sims3/randomStars.2.seeing.0.88.trim > sims5/randomStars.2.seeing.0.88.trim
python makeNewTrims.py sims3/randomStars.2.template.trim    > sims5/randomStars.2.template.trim


# Ran the sims, lets turn into input images and try the astrometry!
mkdir inputs5
cd sims5/
foreach i (*.out)
 cd $i
 python ../../python/rename_images.py ../../inputs5 */*E000.fits.gz
 cd ../ 
 end
cd ../inputs5
setup pysqlite
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .
echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> _mapper
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601^6866602^6866603^88868666

# BOOM!
  processEimage.calibrate.astrometry: Got astrometric solution from Astrometry.net

$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=6866601^6866602^6866603^88868666 -j 10

# Works!  First thigns first.  Compare the positions of objects in the
  images, vs. their colors.  While this happes, run these sims in
  different filters.

######### Astrometry

When matching the sources to the reference catalog via:
  astrometer.useKnownWcs(srcA, exposure=expA).matches 
the refernce schema by default only has the magntiude of yoru expsure in it.  But I need all
magnitudes to determine the source color.  I have hacked this together for now by 

from lsst.meas.photocal.colorterms import Colorterm
class MyColorTerm(object):
    def get(self):
        return True
Colorterm._activeColorterms = {}
Colorterm._activeColorterms["i"] = MyColorTerm()

This allows the following to set allFluxes=True in

  https://dev.lsstcorp.org/cgit/LSST/DMS/meas_astrom.git/tree/python/lsst/meas/astrom/astrom.py#n220

I really should file a ticket to make this an argument to
useKnownWcs!!!  Once I figure what is going on, I will. 

Making this go, I find that *all* the source magnitudes are set to the
same value, namely the magnitude in the r-band.  This comes into play at:

https://dev.lsstcorp.org/cgit/LSST/DMS/meas_astrom.git/tree/python/lsst/meas/astrom/astrom.py#n805

I have verified that the cat returned from solver.getCatalog has these
numbers the same by default, meaning I have to dig down a level.
Looks like solver comes from

https://dev.lsstcorp.org/cgit/LSST/DMS/meas_astrom.git/tree/python/lsst/meas/astrom/astrom.py#n908

I.e. from astrometry_net.  Great...  Getting deeper...

http://trac.astrometry.net/browser/trunk/src/astrometry/blind/solver.c


Grab the source code and roll my own:

wget http://astrometry.net/downloads/OLD/astrometry.net-0.30.tar.gz
./configure --prefix=$PWD/../0.30
make
make install INSTALL_DIR=$PWD/../0.30
setup -k -r ~/LSST/DMS/astrometry.net/0.30/

 # yields illegal instruction; perhaps I need to rebuild meas_astrom

scons opt=3
  Failed to load required dependencies: "astrometry_net"

eups list | grep astrom
astrometry_net        LOCAL:/lsst/home/becker/LSST/DMS/astrometry.net/0.30 	setup

Maybe I need to call the dir astrometry_net?
unsetup astrometry_net 
mv astrometry.net/ astrometry_net/
setup -k -r astrometry_net/0.30/
cd $MEAS_ASTROM_DIR/
scons opt=3
 Failed to load required dependencies: "astrometry_net"
 # WTF!?
Weird...  I notice in /lsst/DC3/stacks/gcc445-RH6/28nov2011/Linux64/external/astrometry_net/0.30/ups/ there is also a astrometry_net.cfg
Copy this over

unsetup astrometry_net
cp /lsst/DC3/stacks/gcc445-RH6/28nov2011/Linux64/external/astrometry_net/0.30/ups/astrometry_net.cfg ~/LSST/DMS/astrometry_net/0.30/ups/
setup -k -r ~/LSST/DMS/astrometry_net/0.30/
scons opt=3
# WORKED!

# Back to bedugging...  bedugging?  debugging...
python python/compareDcrFromSims.py

# WHAT IS THIS!?
Illegal instruction

And ARG, this was pointed at the wrong astrometry_net data dir:

[becker@lsst5 astrometry_net_data]$ echo $ASTROMETRY_NET_DATA_DIR/
/lsst8/krughoff/diffim_data/astrometry_net_data/

setup -k -r  /nfs/lsst/home/becker/Winter2014/astrometry_net_data

and I get

(Pdb) print cat[0].get("i"), cat[0].get("r"), cat[0].get("g")         
1.77499915497e-08 1.61647059959e-08 1.21904116587e-08

Sigh.  Well OK then.  Onwards...


I filed ticket #3106 on making it easier to get all magnitudes out of
the astrometry.net index files.  Can work-around for now.


##################
########## SIMS5gr
##################
Opsim_filter 3 # i-band
Opsim_filter 2 # r-band
Opsim_filter 1 # g-band

sims5gr/
foreach i (*.out)
 cd $i
 python ../../python/rename_images.py ../../inputs5 */*E000.fits.gz
 cd ../ 
 end
cd ../inputs5
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .
pysqlite2.dbapi2.IntegrityError: column visit is not unique

 # OK, so rename the vists then...
[becker@lsst5 eimage]$ mv v6866601-fg v4866601-fg
[becker@lsst5 eimage]$ mv v6866602-fg v4866602-fg
[becker@lsst5 eimage]$ mv v6866603-fg v4866603-fg
[becker@lsst5 eimage]$ mv v88868666-fg v48868666-fg

[becker@lsst5 eimage]$ mv v6866601-fr v5866601-fr
[becker@lsst5 eimage]$ mv v6866602-fr v5866602-fr
[becker@lsst5 eimage]$ mv v6866603-fr v4866603-fr
[becker@lsst5 eimage]$ mv v4866603-fr v5866603-fr
[becker@lsst5 eimage]$ mv v88868666-fr v58868666-fr

And while I'm at it...
[becker@lsst5 eimage]$ mv v88868666-fi v68868666-fi

But ack it looks in raw/ not eimage...  Redo above commands in raw/

  Warning: Unrecognized file: ./raw/v48868666-fg/E000/R22/S10/imsim_88868666_R22_S10_C04_E000.fits.gz

Double damn.  Have to rename the .fits files too...

foreach i (4866601 4866602 4866603)
    foreach j (`find raw/v$i* eimage/v$i* -name "*fits*"`)
       set jj = `echo $j | sed 's/_6/_4/'`
       mv $j $jj
    end
end

foreach i (48868666)
    foreach j (`find raw/v$i* eimage/v$i* -name "*fits*"`)
       set jj = `echo $j | sed 's/_8/_4/'`
       mv $j $jj
    end
end

foreach i (5866601 5866602 5866603)
    foreach j (`find raw/v$i* eimage/v$i* -name "*fits*"`)
       set jj = `echo $j | sed 's/_6/_5/'`
       mv $j $jj
    end
end

foreach i (58868666)
    foreach j (`find raw/v$i* eimage/v$i* -name "*fits*"`)
       set jj = `echo $j | sed 's/_8/_5/'`
       mv $j $jj
    end
end

foreach i (68868666)
    foreach j (`find raw/v$i* eimage/v$i* -name "*fits*"`)
       set jj = `echo $j | sed 's/_8/_6/'`
       mv $j $jj
    end
end


$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=4866601^4866602^4866603^48868666^5866601^5866602^5866603^58868666^6866601^6866602^6866603^68868666 -j 10


##################
########## DCR scripts
##################

Running compareDcrFromSims.py to make quiver diagrams of astrometric
offsets.  This is nice and all, but need to compare to parallactic
angle.  This appears to be in catalogs_measures.  Moving here next. 

We need to 

setup -k -r ~/LSST/sims/throughputs

and then for the next 2

setenv CAT_SHARE_DATA /nfs/lsst/home/becker/LSST/sims
setenv SIMS_DATA_DIR  /nfs/lsst/home/becker/LSST/sims
setup -k -r ~/LSST/sims/catalogs/generation/
setup -k -r ~/LSST/sims/catalogs/measures/

cd $CATALOGS_MEASURES_DIR/
git pull
# Looks like 4d31435abdb0435c190ac2b9e9b7ae4fc95b3a21 has the telescope rotation changes; first need parallactic angle operations

#####

Definitions:

  rotSkyPos = (rotTelPos - parallactic angle + 180) % 360

For rotSkyPos = 180, North is negative y-direction, South is positive
y-direction.  So rotSkyPos = 0, North is "up" and South is "down" in a
calexp. 

Calexp header:

ROTANG  =        251.068956606 / Rotation Angle (rotSkyPos) (degrees)
SPIDANG =        81.0425850684 / Angle of Spider (rotTelPos)

So the parallactic angle = 9.9736284624 degrees. 

Note that .fits files are typically viewed in a "North up, East left"
orientation so I'm not 100% clear which coordinate definition is
correct (W<->E), or which way to rotate the angles (clockwise or
counterclockwise). 

My gut feeling is assuming a 

   N
  W E
   S

definition and the angle should be rotated clockwise from North, so in
the first quadrant, 9.97 degrees from vertical.  I.e. rotating 9.97
degrees from North to the East.


# Summary after talking with Simon:
 
rotSkyPos sets the orientation of ra, decl; effectively a rotation of
the Pole away from Zenith.  If I want to keep the stars in the same
relative positions on the chip, keep rotSkyPos the same in all sims at
all airmasses.  I need to use
lsst.sims.catalogs.measures.example_utils to generate a physical
rotTelPos for a given rotSkyPos.  So rotSkyPos technically reflects a
rotation of the catalog itself, to account for the fact the phoSim
does not explicitly use (alt,az,latitude) which are typically used to
determine the (Pole,Zenith,field) triangle.  This is a rotation
relative to the camera coordinate system.

When rotTelPos = 0, the y-axis points to the zenith, and DCR is solely
along the y-axis.  If rotTelPos is X degrees, the direction of DCR is
along a counterclockwise rotation w.r.t. the y-axis by X degrees.
E.g. positive rotTelPos < 90 degrees puts DCR through the second and
fourth quadrant.  This is considered a rotation relative to the
telescope coordinate system.  This number is all that is needed to
determine the direction of DCR.  And the trick to this whole problem
is keeping the positions of the stars consistent using rotSkyPos, and
using Simon's script to generate the appropriate rotTelPos, thereby
giving me DCR at several orientations on stars at the same x,y
coordintes.

[*] To the best of Simon's recollection


# Gordon's statements on his DCR studies:

Q: OK, thanks!  Will read through the Kaczmarczik paper.  I do notice
that the LSST data only look marginally similar to the SDSS
data. Would you say that your analysis only validates that there is
*some* component of DCR in the sims, or that it also validates that it
hews close enough to reality that you would design LSST software to
it?

A: It is hard to say.  Before there was no DCR effect at all.  What
I've been able to do says that there is at least some now.  And the
direction/magnitude of things is encouraging.  I can see if falling
and rising at the right redshifts.  But I haven't been able to do
enough to say that it is a fully accurate representation of the sky.
I'd really need u-band data for that.

##################
########## SIMS6
##################

# Looking at the script to generate the sim metadata: Its in

  example_utils/observationMetadataUtils.py  

We have:

  def getRotSkyPos(azRad, decRad, latRad, rotTelRad):
  def getRotTelPos(azRad, decRad, latRad, rotSkyRad):
  def makeObsParamsAzAltTel(azRad, altRad, mjd, band, rotTelRad=0., longRad=-1.2320792, latRad=-0.517781017, **kwargs):
  def makeObsParamsAzAltSky(azRad, altRad, mjd, band, rotSkyRad=math.pi, longRad=-1.2320792, latRad=-0.517781017, **kwargs):
  def makeObsParamsRaDecTel(raRad, decRad, mjd, band, rotTelRad=0., longRad=-1.2320792, latRad=-0.517781017, **kwargs):
  def makeObsParamsRaDecSky(raRad, decRad, mjd, band, rotSkyRad=math.pi, longRad=-1.2320792, latRad=-0.517781017, **kwargs):

I think what I want to do is set raRad, decRad and band, iterate over MJD say every half hour, and set rotSkyPos to 

  Opsim_rotskypos 251.068956606 

This should ensure that the stars end up in the same position on the
chip, and the script will report back the appropriate Opsim_rottelpos
along which I should expect DCR.  Note that the previous phoSim values
for the necessary attributes are:

 Opsim_expmjd 51130.2617188 
 Unrefracted_RA 79.6892650466 
 Unrefracted_Dec -9.70229566883 

Put this script in python/generateTrimFilesDcr.py

Somehow I am getting a segfault on:

  import lsst.sims.catalogs.measures.example_utils as utils

Somehow this seems to be a numpy/scipy problem:

 #0  0x00007f8216f4e9a0 in PyArray_API () from /local/acbecker/winter2012/Linux64/external/numpy/1.6.2+1/lib/python/numpy/core/multiarray.so
 #1  0x00007f8211ea605b in _import_array () at /local/acbecker/winter2012/Linux64/external/numpy/1.6.2+1/lib/python/numpy/core/include/numpy/__multiarray_api.h:1571
 #2  initspecfun () at build/src.linux-x86_64-2.7/scipy/special/specfunmodule.c:5820
 #3  0x00007f821e5ff395 in _PyImport_LoadDynamicModule (name=0x7ffffdb5e140 "scipy.special.specfun", 
     pathname=0x7ffffdb5d070 "/local/acbecker/winter2012/Linux64/external/scipy/0.10.1+1/lib/python/scipy/special/specfun.so", fp=<value optimized out>)
     at ./Python/importdl.c:53

We have seen this before.  You need to put "import scipy" as the very
first line of the script to avoid symbol collision.  Done.

I find for this field:
    # Max altitude is at: 51130.2728299 (1.2223472022241457, dtype('float64'))
    # 51130.2728299 70.0353357871

So this field doesn't even go through zenith...  Complication.  I need
to put dec at the latitude of the telescope, yes?  Yes.

  decRad    = -0.517781017 

works.

  51130.2728299 89.8994905241

Need to make sure that I don't hit any peculiarities of phoSim that
kick in near zenith.  According to Simon this is not an issue.  So
we'll just do this.  The dec of the stars needs to be centered at
-0.517781017 * 180. / np.pi = -29.6666669861 degrees, from
-9.70229566883, so I should subtract -19.96437131727 from all the
decs in the new trim files.

Lets select times where the field is at 30 degrees and 50 degrees from
Zenith.  1.15 and 1.55 airmasses, respectively.

51130.0783855 30.1503015577
51130.1443577 50.0835971622
51130.2728299 89.8994905241
51130.4006077 50.1000418597
51130.4665799 30.166183362

#### NOTE this is actually not zenith distance, but altitude.  Shoot,
    may have to regenerate.  Yes, need to:
[becker@lsst5 sims7]$ imhead *.out/lsst_e_*_R22_S22_E000.fits.gz -K AIRMASS
1000002.out/lsst_e_1000002_f1_R22_S22_E000.fits.gz: 1.99056519240762 
1001001.out/lsst_e_1001001_f1_R22_S22_E000.fits.gz: 1.30380316360095 
1001002.out/lsst_e_1001002_f1_R22_S22_E000.fits.gz: 1.30380316360095 
1003003.out/lsst_e_1003003_f1_R22_S22_E000.fits.gz: 1.30349037366445 
2001000.out/lsst_e_2001000_f2_R22_S22_E000.fits.gz: 1.30380316360095 
2001002.out/lsst_e_2001002_f2_R22_S22_E000.fits.gz: 1.30380316360095 
2002002.out/lsst_e_2002002_f2_R22_S22_E000.fits.gz: 1.00000112099011 
3000002.out/lsst_e_3000002_f3_R22_S22_E000.fits.gz: 1.99056519240762 
3002003.out/lsst_e_3002003_f3_R22_S22_E000.fits.gz: 1.00000112099011 


Will have to rewrite trim file headers, along with the object lines'
Decs.  Simon does not believe that the order of header fields matters.
Will find out.  Also, removing 'Opsim_azimuth' and 'Opsim_altitude'
from the trim file, seem to be unnecessarily redundant with
"Unrefracted_Altitude", "Unrefracted_Azimuth"


NOTE: This page

  https://dev.lsstcorp.org/trac/wiki/IS_instance_catalog

is the most up-to-date on what phoSim requires


Lets also rename the obshistIds.  They will be 

 XXXXXXXXXXXXXX

 A00B00C:
 A = g,r,i 1,2,3
 B = mjd   0..4
 C = seeing 0=template; 1,2,3 for seeing

python python/generateTrimFilesDcr.py sims5/randomStars.2.seeing.0.6.trim
python python/generateTrimFilesDcr.py sims5/randomStars.2.seeing.0.88.trim
python python/generateTrimFilesDcr.py sims5/randomStars.2.seeing.1.2.trim
python python/generateTrimFilesDcr.py sims5/randomStars.2.template.trim

mkdir sims6
mv *trim sims6/

> diff 1000000.trim 2000000.trim
Opsim_obshistid 1000000					      |	Opsim_obshistid 2000000
Opsim_filter 1						      |	Opsim_filter 2


# on ncsa-dev
cd sims6
cp ../sims5/clean.params.beta .
cp ../sims5/makeCommands.py .

edited makeCommands.py to use the "-p" option for phosim.  Running it now.


OK, comparing these sims to previous sims the stars are generally in
the same place and orientation.  One worry is that the M-stars are
fainter in the g-band, and the A-stars are fainter in the i-band.
Going to be tough to figure out DCR with this in the way.  Might have
to try and do a magnitude correction to each trimfile to make them
approximately the same brightness in each.  This would then require a
separate astrometry_net file for each passband.  Hmm...

Also, according to Simon, the magnitude in the trim-files is an
effective magnitude in a thin passband at 500nm, so something around
g-band.  I thought it was the integrated r-band mag but it is not.

Anyways, I clearly need to tweak the magnitudes in the input trim
files.  I then need to create the astrometry.net index from the main
master trim file that I am using as inputs to the derived trim file.

##################
########## SIMS7
##################

Edited generateTrimFilesDcr.py to include per-passband magnitude offset.

python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.0.6.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.0.88.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.1.2.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.template.trim

# g-band:
UWacb238:grep object 1000001.trim | head
object 0    79.509107   -29.6669514173 19.2991330594 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.5443320176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 20.6118560176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 19.8435050176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.3501060176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 21.0187110127 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.5650780176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.1912090176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.4975330176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 19.8628970176 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
UWacb239:grep object ../sims6/1000001.trim | head
object 0    79.509107   -29.6669514173 19.05993 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.850707 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 20.918231 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 20.14988 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.656481 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 22.37292 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.871453 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.497584 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.803908 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 20.169272 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none

# r-band:
UWacb240:grep object 2000001.trim | head
object 0    79.509107   -29.6669514173 19.05993 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.850707 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 20.918231 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 20.14988 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.656481 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 22.37292 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.871453 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.497584 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.803908 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 20.169272 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
UWacb241:grep object ../sims6/2000001.trim | head
object 0    79.509107   -29.6669514173 19.05993 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.850707 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 20.918231 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 20.14988 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.656481 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 22.37292 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.871453 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.497584 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.803908 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 20.169272 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none

# i-band:
UWacb243:grep object 3000001.trim | head
object 0    79.509107   -29.6669514173 18.8262897545 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.952281784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 21.019805784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 20.251454784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.758055784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 23.3903018086 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.973027784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.599158784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.905482784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 20.270846784 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
UWacb244:grep object ../sims6/3000001.trim | head
object 0    79.509107   -29.6669514173 19.05993 starSED/kurucz/kp01_9750.fits_g45_9830.gz 0. 0. 0. 0. 0. 0. star none none
object 1    79.173911   -29.8841081173 20.850707 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 2    79.402141    -29.2055233173 20.918231 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 3     80.18331   -29.4803621173 20.14988 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 4    80.237691   -29.1792504173 20.656481 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 5    79.583418   -29.6499921173 22.37292 starSED/mlt/m2.0Full.dat.gz 0. 0. 0. 0. 0. 0. star none none
object 6    79.606731   -29.8872526173 19.871453 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 7    79.978131   -29.5046809173 20.497584 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 8     79.92972   -30.1349893173 19.803908 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none
object 9    79.842407   -29.9741643173 20.169272 starSED/kurucz/km20_6000.fits_g30_6020.gz 0. 0. 0. 0. 0. 0. star none none

So the A-star is gotten fainter by 19.2991330594-19.05993 = 0.24 mags
and the M-star is rendered brighter by 1.35 mags, in the g-band.  In
the i-band, the A-star is 0.233 brighter and the M-star is 1.01 mags
fainter.  So things look to be going in the correct direction.

Somewhat worried that the stars are going to be generally fainter in
the g-band or i-band compared to r-band, based on the color of
km20_6000.  Assume its not an issue for now.  

# Back at NCSA:
python makeCommands.py > SOURCE_ME

Lets run a single sensor in g,r,i to make sure the stars look correct.

python $PHOSIM_DIR/phosim.py $PWD/1001001.trim -w $PWD/1001001.work -o $PWD/1001001.out -c $PWD/clean.params.beta -s R22_S00 &
python $PHOSIM_DIR/phosim.py $PWD/2001001.trim -w $PWD/2001001.work -o $PWD/2001001.out -c $PWD/clean.params.beta -s R22_S00 &
python $PHOSIM_DIR/phosim.py $PWD/3001001.trim -w $PWD/3001001.work -o $PWD/3001001.out -c $PWD/clean.params.beta -s R22_S00 &

The stars relative brightness look consistent across the 3 images,
certainly more so compared to the sim6 results:

  ds9 /lsst/home/becker/Winter2014/sims7/*.out/lsst_e_*_R22_S00_E000.fits.gz

 vs.
  
  ds9 /lsst/home/becker/Winter2014/sims6/*.out/lsst_e_*_R22_S00_E000.fits.gz

So lets move forward with this.

One issue is the compute time.  The templates take 1-2 days I believe
per CCD.  We have 3 passbands, 5 airmasses, which is 15 templates.  We
then have 3 seeings, which is 135 science visits

Lets put together 2 jobs that run the templates all CCDs as
a single job.  Then we'll have a third doing all the CCDs from a visit
at once using "-p".  This will give us 9 * 3 = 27 jobs running.  We
have 32 at our disposal.

Script 1 has half the templates, with 
  -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -p 9

Script 2 has half the templates, with 
  -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -p 9

Script 3 has all the science images, with 
  -s "R22_S00|R22_S01|R22_S02|R22_S10|R22_S11|R22_S12|R22_S20|R22_S21|R22_S22" -p 9

# Here are templtes numbers left:
grep "000.work" SOURCE_ME | grep -v \# | wc -l
14

grep "000.work" SOURCE_ME | grep -v \# | head -7 > SOURCE_ME_A
grep "000.work" SOURCE_ME | grep -v \# | tail -7 > SOURCE_ME_B
 
# Here are the science images left
grep -v "000.work" SOURCE_ME | grep -v \# | wc -l
37

grep -v "000.work" SOURCE_ME | grep -v \#  > SOURCE_ME_C

# Go for it!!!
source SOURCE_ME_A &; source SOURCE_ME_B &; source SOURCE_ME_C &
[1] 10396
[2] 10397
[3] 10398

##################
########## SIMS8
##################

Making sure I put these at the correct zenith distance.  If I want ZD
of 30 and 50, I want altitude of 60 and 40.

51130.1117188 40.1354639235
51130.1763021 59.9391390204
51130.2728299 89.8994905241
51130.3686632 59.9557484613
51130.4332466 40.1516734543

python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.0.6.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.0.88.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.seeing.1.2.trim
python ../python/generateTrimFilesDcr.py ../sims5/randomStars.2.template.trim

python makeCommands.py > SOURCE_ME_ALL
grep "000.work" SOURCE_ME_ALL | head -8 > SOURCE_ME_A
grep "000.work" SOURCE_ME_ALL | tail -7 > SOURCE_ME_B
grep -v "000.work" SOURCE_ME_ALL > SOURCE_ME_C

# Go for it (again)!!!
source SOURCE_ME_A &; source SOURCE_ME_B &; source SOURCE_ME_C &
[1] 4510
[2] 4511
[3] 4512

Lets prep these for analysis:

mkdir inputs8
cd sims8/
foreach i (*.out)
 cd $i
 python ../../python/rename_images.py ../../inputs8 *E000.fits.gz
 cd ../ 
 end
cd inputs8/
python $OBS_LSSTSIM_DIR/bin/genInputRegistry.py .
cp ../inputs5/_mapper .
$OBS_LSSTSIM_DIR/bin/processEimage.py . -j 10
  # Hmm, you have to tell it visits...
$OBS_LSSTSIM_DIR/bin/processEimage.py . --id visit=1000000^1001000^1002000^1003000^1004000^2000000^2001000^2002000^2003000^2004000^3000000^3001000^3002000^3003000^3004000^1000001^1001001^1002001^1003001^1004001^2000001^2001001^2002001^2003001^2004001^3000001^3001001^3002001^3003001^3004001^1000002^1001002^1002002^1003002^1004002^2000002^2001002^2002002^2003002^2004002^3000002^3001002^3002002^3003002^3004002^1000003^1001003^1002003^1003003^1004003^2000003^2001003^2002003^2003003^2004003^3000003^3001003^3002003^3003003^3004003 -j 20
  # RuntimeError: Unable to match sources with catalog.

# Ruh roh, astrometry issues time...
echo $ASTROMETRY_NET_DATA_DIR/
/nfs/lsst/home/becker/Winter2014/astrometry_net_data/

I suppose this makes sense, I had to rotate the field to go through
zenith.  Fine, lets try and fix this then...  Which trim file shall we
use?  It really should not matter.  I hope...  Use r-band at zenith,
template image.

mkdir astrometry_net_data8
python python/trim_to_ref.py sims8/2002000.trim > astrometry_net_data8/2002000.ref
cd astrometry_net_data8

eups list astrometry_net
   0.30       	Summer2012 Summer2012_prod v7_3 current beta v7_1 v7_2 stable v5_2 v5_1 v6_1 v6_3 v6_2 setup
setup -r /lsst/home/krughoff/lsst/lsst_devel/Linux64/astrometry.net-0.38/astrometry
text2fits.py 2002000.ref 2002000.fits
setenv P 1402120
build-index -i 2002000.fits -o index-${P}00.fits -I ${P}00 -P 0 -S r -n 100 -L 20 -E -j 0.4 -r 1
build-index -1 index-${P}00.fits -o index-${P}01.fits -I ${P}01 -P 1 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}02.fits -I ${P}02 -P 2 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}03.fits -I ${P}03 -P 3 -S r -L 20 -E -M -j 0.4 
build-index -1 index-${P}00.fits -o index-${P}04.fits -I ${P}04 -P 4 -S r -L 20 -E -M -j 0.4 
ls index-1402120* | awk '{printf("modhead %s+7 REFCAT '2002000'\n",$1)}' | sh     
setup astrometry_net 0.30  
cp -r /nfs/lsst/home/becker/Winter2014/astrometry_net_data/ups .
setup -k -r .

# WOrks!  After a bit of rejiggering of andConfig.py  

Make the commands with python/makeV8Commands.py.  Have a bunch of directories like:

  outputs8EB_doPreConvolveFalse

  Where EB are idx1,idx2 and idx1 is the mjd of the template A-E
  and idx2 is the mjd of the science image A-E.

Make sure when you run this you set up the v8 astrometry directory!
setup -k -r astrometry_net_data8/

##################
########## SIMS5 analysis
##################

#g
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3

#r
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3

#i
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config -j 3


########## WARNING: 
lsst.ip.diffim.DiaCatalogSourceSelector WARNING: Cannot cut on color info; fields 'g' and 'r' do not exist

I need to fix this since I'll be cutting on source color.  This
requires code development.  Good chance to merge #2822 back to master
now that Pauls' review is back, and time to check out new tickets for
W14 dev.  "Out of scopes" for #2822 filed as #3125.

#### MERGE OF 2822 BACK TO MASTER
To merge #2822 back to master:

cd /nfs/lsst/home/becker/LSST/DMS/ip_diffim
git pull
git checkout master
git pull
git merge --no-ff tickets/2822
git push

cd /nfs/lsst/home/becker/LSST/DMS/obs_lsstSim/
...
cd /nfs/lsst/home/becker/LSST/DMS/pipe_tasks/
...

# And of course I need to rebuild
setup obs_lsstSim -t v7_3

cd /nfs/lsst/home/becker/LSST/DMS/obs_lsstSim/
setup -k -r .
scons opt=3

cd /nfs/lsst/home/becker/LSST/DMS/ip_diffim/
setup -k -r .
scons opt=3
# Note the dipole issue remains here, but I don't have updated
  versions of meas_XXXX to test this.  If buildbot complains I fix.

cd /nfs/lsst/home/becker/LSST/DMS/pipe_tasks
setup -k -r .
scons opt=3

# Now lets have a look at the DiaCatalogSourceSelector issue.  I
probably need to use the results of #3106 which are to allow easier
extraction of magnitudes from the astrometry.net files.  This requires
I also work with master of meas_astrom

cd /nfs/lsst/home/becker/LSST/DMS/meas_astrom/
git pull
setup -k -r .
scons opt=3

# This might be enough than, since A) the allFluxes option has been
  moved to the config, and B) is True by default.  Run one by hand.

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866602 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]"  --clobber-config 

# Running on lsst5, there is a *HUGE* lag in getting this to run.  Disks again...?

# Also, lets give some thought to the catalog selection.  We have in
  the config:

    grMin = pexConfig.Field(
        doc = "Minimum g-r color for selection (inclusive)",
        dtype = float,
        default = 0.0
    )
    grMax = pexConfig.Field(
        doc = "Maximum g-r color for selection (inclusive)",
        dtype = float,
        default = 3.0
    )

 Assuming we want to have the bulk of the stars (G stars) used to fit
 the kernel, which have g-r of 0.3.  The A stars have g-r of -0.2 and
 the M stars of 1.3.  So we want say grMin = 0.0 and grMax = 0.5.
 NOW, we *do* want them for the control sample though!  Will have to
 think about how to do this...

[becker@lsst5 ~/Winter2014]$ $PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866602 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfig.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" --clobber-config
: Config override file does not exist: '/nfs/lsst/home/becker/LSST/DMS/obs_lsstSim/config/winter2013ImageDifference.py'
: Config override file does not exist: '/nfs/lsst/home/becker/LSST/DMS/obs_lsstSim/config/lsstSim/winter2013ImageDifference.py'
: input=/nfs/lsst/home/becker/Winter2014/inputs5
: calib=None
: output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue
CameraMapper: Loading registry registry from /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue/_parent/registry.sqlite3
winter2013ImageDifference: Processing {'filter': 'i', 'raft': '2,2', 'sensor': '1,1', 'visit': 6866602}
winter2013ImageDifference WARNING: USING WINTER2013 : DEEP CALEXP AS TEMPLATE
winter2013ImageDifference: Source selection via src product
winter2013ImageDifference: Selected 614 / 866 sources for Psf matching (154 for control sample)
winter2013ImageDifference: Registering images
winter2013ImageDifference.register: Matching within 1.0 arcsec: 825 matches
winter2013ImageDifference.register: Registration WCS: final WCS RMS=0.024354 pixels from 810 matches
winter2013ImageDifference: Subtracting images
winter2013ImageDifference.subtract: Template Wcs : 1.389584,-0.166862 -> 1.392098,-0.171813
winter2013ImageDifference.subtract: Science Wcs : 1.389584,-0.166862 -> 1.392098,-0.171813
winter2013ImageDifference.subtract: Growing 614 kernel candidate stars by 25 pixels
winter2013ImageDifference.subtract: Selected 600 / 614 sources for KernelCandidacy
winter2013ImageDifference.subtract: Matching Psf FWHM 4.67 -> 6.66 pix
winter2013ImageDifference.subtract: Final spatial kernel sum 0.050
winter2013ImageDifference.subtract: Spatial model condition number 3.931e+09
winter2013ImageDifference.subtract: Doing stats of kernel candidates used in the spatial fit.
winter2013ImageDifference.subtract: 600 candidates total, 0 rejected, 595 used
winter2013ImageDifference.subtract: Spatial kernel model well constrained; 595 candidates, 21 terms, 33 bases
winter2013ImageDifference.subtract: Spatial background model appears well constrained; 595 candidates, 3 terms
winter2013ImageDifference: Running diaSource detection
winter2013ImageDifference.detection: Detected 0 positive sources to 5 sigma.
winter2013ImageDifference.detection: Detected 6 negative sources to 5 sigma
winter2013ImageDifference: Merging detections into 6 sources
winter2013ImageDifference: Running diaSource measurement
winter2013ImageDifference.dipoleMeasurement: Measuring 6 sources
winter2013ImageDifference.dipoleMeasurement: Classifying 6 sources
winter2013ImageDifference: Matched 0 / 6 diaSources to sources
winter2013ImageDifference WARNING: No diaSource matches with reference catalog
winter2013ImageDifference: Evaluating metrics and control sample
winter2013ImageDifference: Growing 154 kernel candidate stars by 25 pixels
winter2013ImageDifference: Selected 147 / 154 sources for KernelCandidacy

# To enact changes, we need to modify.  Put in 

root.sourceSelector['diacatalog'].grMax=0.5
root.sourceSelector['diacatalog'].grMin=0.0

# New config file
cp imageDifferenceConfig.py imageDifferenceConfigGstar.py

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866602 raft=2,2 sensor=1,1 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" --clobber-config

# Big difference is:
...
winter2013ImageDifference: Selected 555 / 866 sources for Psf matching (139 for control sample)
...

# So great, we get rid of the other sources, but we *still* need to
  find a way to assess them.  Add them to the control sample, etc.
  Think on this over lunch.

Probably the best way forward is to ask for dcrCatalog (and perhaps
variablesCatalog) in the code.  For now make them part of the control
sample.  Address in #3128.  Will be on pipe_tasks.  And hmm...  I have
an afw work-around in there.  Do I bite the bullet and go full rebuild
or just stash?  Will stash for now.  Diff below.

diff --git a/python/lsst/pipe/tasks/processImage.py b/python/lsst/pipe/tasks/processImage.py
index 88ed86b..ec2921b 100644
--- a/python/lsst/pipe/tasks/processImage.py
+++ b/python/lsst/pipe/tasks/processImage.py
@@ -196,8 +196,8 @@ class ProcessImageTask(pipeBase.CmdLineTask):
             self.propagateCalibFlags(calib.sources, sources)
 
         if sources is not None and self.config.doWriteSources:
-            sourceWriteFlags = (0 if self.config.doWriteHeavyFootprintsInSources
-                                else afwTable.SOURCE_IO_NO_HEAVY_FOOTPRINTS)
+            sourceWriteFlags = 0# (0 if self.config.doWriteHeavyFootprintsInSources
+                                #else afwTable.SOURCE_IO_NO_HEAVY_FOOTPRINTS)
             if enableWriteSources:
                 dataRef.put(sources, self.dataPrefix + 'src', flags=sourceWriteFlags)

# Adding 2 new options to imageDifference:

self.config.doSelectDcrCatalog:
self.config.doSelectVariableCatalog:

# Lets try this:
# Normal
winter2013ImageDifference: Selected 555 / 866 sources for Psf matching (139 for control sample)

# With doSelectDcrCatalog=True
winter2013ImageDifference: Selected 555 / 866 sources for Psf matching (290 for control sample)

# BOOM!  Re-run them all...


#g
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse/imageDifferenceWinter2013.out4
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue/imageDifferenceWinter2013.out4

#r
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse/imageDifferenceWinter2013.out5
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue/imageDifferenceWinter2013.out5

#i
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse/imageDifferenceWinter2013.out6
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue/imageDifferenceWinter2013.out6

# make sure they are all regenerated:
ls -latr outputs5_doPreConvolve*/deepDiff/*/*/metadata-*boost  | wc -l
162

# and we should have 3 filters times 3 visits times 2 prefilter options times 9 sensors = 162
worked!

So just to reiterate, I have run the code to *only* use the Gstars to
create the image subtraction kernel.  And the A/Mstars are being used
as part of the control sample.  One minor issue is that I am only
using 555 stars vs. 647 for fitting since the pot of candidates for
fitting the kernel is smaller (I've left out the A/Mstars).  

# AH, BUG.  I did not use imageDifferenceConfigGstar.py.  I can check this by
grep control outputs5_doPreConvolveFalse/imageDifferenceWinter2013.out | grep Sel
 winter2013ImageDifference: Selected 665 / 938 sources for Psf matching (240 for control sample)
 winter2013ImageDifference: Selected 652 / 934 sources for Psf matching (255 for control sample)
 winter2013ImageDifference: Selected 574 / 817 sources for Psf matching (218 for control sample)

I should be getting far fewer sources...  Par for course.  Run and then re-run and then re-run....

Just to make sure; 

  rm -rf outputs5_doPreConvolveFalse outputs5_doPreConvolveTrue

# And double check:
winter2013ImageDifference: Selected 588 / 938 sources for Psf matching (317 for control sample)
winter2013ImageDifference: Selected 548 / 894 sources for Psf matching (313 for control sample)
winter2013ImageDifference: Selected 564 / 913 sources for Psf matching (325 for control sample)

# I could use a smaller fraction of the sources for the control
  sample, but go with this for now...

# Copy to darkstar
tar cf - outputs5_doPreConvolve*/deepDiff/*/*/diaSrc*fits | ssh acbecker@darkstar.astro.washington.edu "(cd LSST/Winter2014; tar xvfBp -)"
tar cf - outputs5_doPreConvolve*/deepDiff/*/*/kernelSrc*fits | ssh acbecker@darkstar.astro.washington.edu "(cd LSST/Winter2014; tar xvfBp -)" 

python python/countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1
  outputs5_doPreConvolveFalse No mapper provided and no _mapper available

echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> outputs5_doPreConvolveTrue/_mapper
echo "lsst.obs.lsstSim.lsstSimMapper.LsstSimMapper" >> outputs5_doPreConvolveFalse/_mapper

python python/countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1
  outputs5_doPreConvolveFalse : No module named lsstSim.lsstSimMapper

setup obs_lsstSim -t v7_3

python python/countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1
  outputs5_doPreConvolveFalse : libboost_regex.so.1.47.0: cannot open shared object file: No such file or directory

echo $BOOST_DIR/
  /local/acbecker/winter2012/Linux64/external/boost/1.51.0+4/

eups list boost
   1.47.0+3   	current
   1.47.0+6   	Summer2012 Summer2012_prod v5_2 S12a v5_1
   1.51.0+2   
   1.51.0+3   	v6_2 v7_1 v7_2 v6_1 v6_3
   1.51.0+4   	Summer2013 v7_3_1 v7_3 beta stable setup

# Uhh...  What wants 1.47?  Somethign bolloxed.  Try NCSA.
# OK then...  Works.

[becker@lsst-dev ~/Winter2014]$ python python/countDiaSources.py --id visit=6866601 raft=2,2 sensor=1,1
: Config override file does not exist: '/lsst/home/becker/LSST/DMS/obs_lsstSim/config/getTaskData.py'
: Config override file does not exist: '/lsst/home/becker/LSST/DMS/obs_lsstSim/config/lsstSim/getTaskData.py'
: input=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse
: calib=None
: output=None
CameraMapper: Loading registry registry from /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse/_parent/registry.sqlite3
outputs5_doPreConvolveFalse : OK
: Config override file does not exist: '/lsst/home/becker/LSST/DMS/obs_lsstSim/config/getTaskData.py'
: Config override file does not exist: '/lsst/home/becker/LSST/DMS/obs_lsstSim/config/lsstSim/getTaskData.py'
: input=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue
: calib=None
: output=None
CameraMapper: Loading registry registry from /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveTrue/_parent/registry.sqlite3
outputs5_doPreConvolveTrue : OK
python/countDiaSources.py:89: RuntimeWarning: invalid value encountered in greater
  (visit > 0) & np.isfinite(x1) & np.isfinite(y1) & (x1>0.) & (y1>0.) & (srcMatchId > 0)
python/countDiaSources.py:91: RuntimeWarning: invalid value encountered in greater
  (visit > 0) & np.isfinite(x1) & np.isfinite(y1) & (x1>0.) & (y1>0.) & (srcMatchId == 0)
False 39867 501 39024
True 18 0 18

# USEFUL!
To turn off logging above, say:

import lsst.pex.logging as pexLog
pexLog.Trace_setVerbosity("CameraMapper", -100) # No logging info please
pexLog.Trace_setVerbosity("", -100) # No logging info please

And the numpy warnings:
import warnings
warnings.simplefilter("ignore", RuntimeWarning)


# RESULTS (initial)
outputs5_doPreConvolveFalse 4866601 2,2 0,0 : OK 8
outputs5_doPreConvolveFalse 4866601 2,2 0,1 : OK 0
outputs5_doPreConvolveFalse 4866601 2,2 0,2 : OK 2
outputs5_doPreConvolveFalse 4866601 2,2 1,0 : OK 2
outputs5_doPreConvolveFalse 4866601 2,2 1,1 : OK 3
outputs5_doPreConvolveFalse 4866601 2,2 1,2 : OK 1
outputs5_doPreConvolveFalse 4866601 2,2 2,0 : OK 1
outputs5_doPreConvolveFalse 4866601 2,2 2,1 : OK 1
outputs5_doPreConvolveFalse 4866601 2,2 2,2 : OK 2
outputs5_doPreConvolveFalse 4866602 2,2 0,0 : OK 6
outputs5_doPreConvolveFalse 4866602 2,2 0,1 : OK 6
outputs5_doPreConvolveFalse 4866602 2,2 0,2 : OK 7
outputs5_doPreConvolveFalse 4866602 2,2 1,0 : OK 7
outputs5_doPreConvolveFalse 4866602 2,2 1,1 : OK 5
outputs5_doPreConvolveFalse 4866602 2,2 1,2 : OK 6
outputs5_doPreConvolveFalse 4866602 2,2 2,0 : OK 3
outputs5_doPreConvolveFalse 4866602 2,2 2,1 : OK 6
outputs5_doPreConvolveFalse 4866602 2,2 2,2 : OK 8
outputs5_doPreConvolveFalse 4866603 2,2 0,0 : OK 2
outputs5_doPreConvolveFalse 4866603 2,2 0,1 : OK 5
outputs5_doPreConvolveFalse 4866603 2,2 0,2 : OK 4
outputs5_doPreConvolveFalse 4866603 2,2 1,0 : OK 1
outputs5_doPreConvolveFalse 4866603 2,2 1,1 : OK 4
outputs5_doPreConvolveFalse 4866603 2,2 1,2 : OK 3
outputs5_doPreConvolveFalse 4866603 2,2 2,0 : OK 7
outputs5_doPreConvolveFalse 4866603 2,2 2,1 : OK 4
outputs5_doPreConvolveFalse 4866603 2,2 2,2 : OK 4
outputs5_doPreConvolveFalse 5866601 2,2 0,0 : OK 52257
outputs5_doPreConvolveFalse 5866601 2,2 0,1 : OK 61495
outputs5_doPreConvolveFalse 5866601 2,2 0,2 : OK 52737
outputs5_doPreConvolveFalse 5866601 2,2 1,0 : OK 44653
outputs5_doPreConvolveFalse 5866601 2,2 1,1 : OK 48721
outputs5_doPreConvolveFalse 5866601 2,2 1,2 : OK 62262
outputs5_doPreConvolveFalse 5866601 2,2 2,0 : OK 58765
outputs5_doPreConvolveFalse 5866601 2,2 2,1 : OK 59605
outputs5_doPreConvolveFalse 5866601 2,2 2,2 : OK 58483
outputs5_doPreConvolveFalse 5866602 2,2 0,0 : OK 4
outputs5_doPreConvolveFalse 5866602 2,2 0,1 : OK 9
outputs5_doPreConvolveFalse 5866602 2,2 0,2 : OK 6
outputs5_doPreConvolveFalse 5866602 2,2 1,0 : OK 9
outputs5_doPreConvolveFalse 5866602 2,2 1,1 : OK 9
outputs5_doPreConvolveFalse 5866602 2,2 1,2 : OK 7
outputs5_doPreConvolveFalse 5866602 2,2 2,0 : OK 8
outputs5_doPreConvolveFalse 5866602 2,2 2,1 : OK 4
outputs5_doPreConvolveFalse 5866602 2,2 2,2 : OK 4
outputs5_doPreConvolveFalse 5866603 2,2 0,0 : OK 5
outputs5_doPreConvolveFalse 5866603 2,2 0,1 : OK 2
outputs5_doPreConvolveFalse 5866603 2,2 0,2 : OK 2
outputs5_doPreConvolveFalse 5866603 2,2 1,0 : OK 5
outputs5_doPreConvolveFalse 5866603 2,2 1,1 : OK 6
outputs5_doPreConvolveFalse 5866603 2,2 1,2 : OK 6
outputs5_doPreConvolveFalse 5866603 2,2 2,0 : OK 1
outputs5_doPreConvolveFalse 5866603 2,2 2,1 : OK 6
outputs5_doPreConvolveFalse 5866603 2,2 2,2 : OK 4
outputs5_doPreConvolveFalse 6866601 2,2 0,0 : OK 49330
outputs5_doPreConvolveFalse 6866601 2,2 0,1 : OK 51140
outputs5_doPreConvolveFalse 6866601 2,2 0,2 : OK 48952
outputs5_doPreConvolveFalse 6866601 2,2 1,0 : OK 33119
outputs5_doPreConvolveFalse 6866601 2,2 1,1 : OK 39867
outputs5_doPreConvolveFalse 6866601 2,2 1,2 : OK 53586
outputs5_doPreConvolveFalse 6866601 2,2 2,0 : OK 49164
outputs5_doPreConvolveFalse 6866601 2,2 2,1 : OK 51474
outputs5_doPreConvolveFalse 6866601 2,2 2,2 : OK 44422
outputs5_doPreConvolveFalse 6866602 2,2 0,0 : OK 6
outputs5_doPreConvolveFalse 6866602 2,2 0,1 : OK 8
outputs5_doPreConvolveFalse 6866602 2,2 0,2 : OK 7
outputs5_doPreConvolveFalse 6866602 2,2 1,0 : OK 5
outputs5_doPreConvolveFalse 6866602 2,2 1,1 : OK 7
outputs5_doPreConvolveFalse 6866602 2,2 1,2 : OK 3
outputs5_doPreConvolveFalse 6866602 2,2 2,0 : OK 7
outputs5_doPreConvolveFalse 6866602 2,2 2,1 : OK 6
outputs5_doPreConvolveFalse 6866602 2,2 2,2 : OK 2
outputs5_doPreConvolveFalse 6866603 2,2 0,0 : OK 1
outputs5_doPreConvolveFalse 6866603 2,2 0,1 : OK 4
outputs5_doPreConvolveFalse 6866603 2,2 0,2 : OK 3
outputs5_doPreConvolveFalse 6866603 2,2 1,0 : OK 5
outputs5_doPreConvolveFalse 6866603 2,2 1,1 : OK 3
outputs5_doPreConvolveFalse 6866603 2,2 1,2 : OK 5
outputs5_doPreConvolveFalse 6866603 2,2 2,0 : OK 3
outputs5_doPreConvolveFalse 6866603 2,2 2,1 : OK 5
outputs5_doPreConvolveFalse 6866603 2,2 2,2 : OK 2
outputs5_doPreConvolveTrue 4866601 2,2 0,0 : OK 16
outputs5_doPreConvolveTrue 4866601 2,2 0,1 : OK 11
outputs5_doPreConvolveTrue 4866601 2,2 0,2 : OK 18
outputs5_doPreConvolveTrue 4866601 2,2 1,0 : OK 14
outputs5_doPreConvolveTrue 4866601 2,2 1,1 : OK 14
outputs5_doPreConvolveTrue 4866601 2,2 1,2 : OK 9
outputs5_doPreConvolveTrue 4866601 2,2 2,0 : OK 13
outputs5_doPreConvolveTrue 4866601 2,2 2,1 : OK 15
outputs5_doPreConvolveTrue 4866601 2,2 2,2 : OK 9
outputs5_doPreConvolveTrue 4866602 2,2 0,0 : OK 9
outputs5_doPreConvolveTrue 4866602 2,2 0,1 : OK 4
outputs5_doPreConvolveTrue 4866602 2,2 0,2 : OK 10
outputs5_doPreConvolveTrue 4866602 2,2 1,0 : OK 4
outputs5_doPreConvolveTrue 4866602 2,2 1,1 : OK 4
outputs5_doPreConvolveTrue 4866602 2,2 1,2 : OK 4
outputs5_doPreConvolveTrue 4866602 2,2 2,0 : OK 4
outputs5_doPreConvolveTrue 4866602 2,2 2,1 : OK 7
outputs5_doPreConvolveTrue 4866602 2,2 2,2 : OK 2
outputs5_doPreConvolveTrue 4866603 2,2 0,0 : OK 1
outputs5_doPreConvolveTrue 4866603 2,2 0,1 : OK 4
outputs5_doPreConvolveTrue 4866603 2,2 0,2 : OK 3
outputs5_doPreConvolveTrue 4866603 2,2 1,0 : OK 1
outputs5_doPreConvolveTrue 4866603 2,2 1,1 : OK 3
outputs5_doPreConvolveTrue 4866603 2,2 1,2 : OK 2
outputs5_doPreConvolveTrue 4866603 2,2 2,0 : OK 6
outputs5_doPreConvolveTrue 4866603 2,2 2,1 : OK 4
outputs5_doPreConvolveTrue 4866603 2,2 2,2 : OK 3
outputs5_doPreConvolveTrue 5866601 2,2 0,0 : OK 8
outputs5_doPreConvolveTrue 5866601 2,2 0,1 : OK 9
outputs5_doPreConvolveTrue 5866601 2,2 0,2 : OK 13
outputs5_doPreConvolveTrue 5866601 2,2 1,0 : OK 6
outputs5_doPreConvolveTrue 5866601 2,2 1,1 : OK 5
outputs5_doPreConvolveTrue 5866601 2,2 1,2 : OK 10
outputs5_doPreConvolveTrue 5866601 2,2 2,0 : OK 11
outputs5_doPreConvolveTrue 5866601 2,2 2,1 : OK 7
outputs5_doPreConvolveTrue 5866601 2,2 2,2 : OK 3
outputs5_doPreConvolveTrue 5866602 2,2 0,0 : OK 6
outputs5_doPreConvolveTrue 5866602 2,2 0,1 : OK 5
outputs5_doPreConvolveTrue 5866602 2,2 0,2 : OK 5
outputs5_doPreConvolveTrue 5866602 2,2 1,0 : OK 6
outputs5_doPreConvolveTrue 5866602 2,2 1,1 : OK 5
outputs5_doPreConvolveTrue 5866602 2,2 1,2 : OK 4
outputs5_doPreConvolveTrue 5866602 2,2 2,0 : OK 7
outputs5_doPreConvolveTrue 5866602 2,2 2,1 : OK 6
outputs5_doPreConvolveTrue 5866602 2,2 2,2 : OK 5
outputs5_doPreConvolveTrue 5866603 2,2 0,0 : OK 4
outputs5_doPreConvolveTrue 5866603 2,2 0,1 : OK 1
outputs5_doPreConvolveTrue 5866603 2,2 0,2 : OK 3
outputs5_doPreConvolveTrue 5866603 2,2 1,0 : OK 7
outputs5_doPreConvolveTrue 5866603 2,2 1,1 : OK 4
outputs5_doPreConvolveTrue 5866603 2,2 1,2 : OK 3
outputs5_doPreConvolveTrue 5866603 2,2 2,0 : OK 1
outputs5_doPreConvolveTrue 5866603 2,2 2,1 : OK 2
outputs5_doPreConvolveTrue 5866603 2,2 2,2 : OK 3
outputs5_doPreConvolveTrue 6866601 2,2 0,0 : OK 12
outputs5_doPreConvolveTrue 6866601 2,2 0,1 : OK 8
outputs5_doPreConvolveTrue 6866601 2,2 0,2 : OK 10
outputs5_doPreConvolveTrue 6866601 2,2 1,0 : OK 5
outputs5_doPreConvolveTrue 6866601 2,2 1,1 : OK 18
outputs5_doPreConvolveTrue 6866601 2,2 1,2 : OK 8
outputs5_doPreConvolveTrue 6866601 2,2 2,0 : OK 12
outputs5_doPreConvolveTrue 6866601 2,2 2,1 : OK 9
outputs5_doPreConvolveTrue 6866601 2,2 2,2 : OK 11
outputs5_doPreConvolveTrue 6866602 2,2 0,0 : OK 6
outputs5_doPreConvolveTrue 6866602 2,2 0,1 : OK 6
outputs5_doPreConvolveTrue 6866602 2,2 0,2 : OK 3
outputs5_doPreConvolveTrue 6866602 2,2 1,0 : OK 5
outputs5_doPreConvolveTrue 6866602 2,2 1,1 : OK 6
outputs5_doPreConvolveTrue 6866602 2,2 1,2 : OK 2
outputs5_doPreConvolveTrue 6866602 2,2 2,0 : OK 6
outputs5_doPreConvolveTrue 6866602 2,2 2,1 : OK 6
outputs5_doPreConvolveTrue 6866602 2,2 2,2 : OK 1
outputs5_doPreConvolveTrue 6866603 2,2 0,0 : OK 1
outputs5_doPreConvolveTrue 6866603 2,2 0,1 : OK 1
outputs5_doPreConvolveTrue 6866603 2,2 0,2 : OK 3
outputs5_doPreConvolveTrue 6866603 2,2 1,0 : OK 2
outputs5_doPreConvolveTrue 6866603 2,2 1,1 : OK 2
outputs5_doPreConvolveTrue 6866603 2,2 1,2 : OK 1
outputs5_doPreConvolveTrue 6866603 2,2 2,0 : OK 3
outputs5_doPreConvolveTrue 6866603 2,2 2,1 : OK 2
outputs5_doPreConvolveTrue 6866603 2,2 2,2 : OK 0
False 7 0 6
False 0 0 0
False 1 0 0
False 2 0 2
False 3 0 3
False 1 0 1
False 0 0 0
False 0 0 0
False 2 0 2
False 5 0 5
False 6 0 6
False 7 0 6
False 7 0 7
False 5 0 4
False 6 0 6
False 3 0 3
False 6 0 5
False 8 0 8
False 2 0 2
False 5 0 5
False 4 0 4
False 1 0 1
False 4 0 4
False 3 0 3
False 7 0 5
False 4 0 4
False 4 0 4
False 52257 431 51407
False 61495 443 60508
False 52737 464 51827
False 44653 569 43718
False 48721 455 47853
False 62262 477 61214
False 58765 436 57826
False 59605 607 58503
False 58483 442 57549
False 4 0 4
False 9 0 9
False 6 0 6
False 9 0 9
False 9 0 9
False 7 0 7
False 7 0 7
False 4 0 4
False 4 0 4
False 5 0 5
False 2 0 2
False 2 0 2
False 5 0 5
False 6 0 6
False 6 0 6
False 1 0 1
False 6 0 6
False 4 0 4
False 49330 505 48387
False 51140 572 50116
False 48952 503 48050
False 33119 464 32386
False 39867 501 39024
False 53586 511 52606
False 49164 453 48300
False 51474 550 50511
False 44422 491 43576
False 6 0 6
False 8 0 7
False 7 0 7
False 5 0 5
False 7 0 7
False 3 0 3
False 6 0 6
False 5 0 5
False 2 0 2
False 1 0 1
False 4 0 4
False 3 0 3
False 5 0 5
False 3 0 3
False 5 0 5
False 3 0 3
False 5 0 5
False 2 0 2
True 15 0 15
True 11 0 11
True 17 0 16
True 14 0 14
True 14 0 14
True 9 0 9
True 11 4 7
True 14 0 14
True 9 0 9
True 7 0 6
True 4 0 4
True 10 0 9
True 4 0 4
True 4 0 3
True 4 0 4
True 3 0 3
True 5 0 5
True 2 0 2
True 1 0 1
True 4 0 4
True 3 0 3
True 1 0 1
True 3 0 3
True 2 0 2
True 5 0 5
True 4 0 4
True 3 0 3
True 7 0 7
True 9 0 9
True 12 0 12
True 6 0 6
True 5 0 5
True 10 0 9
True 10 0 10
True 7 0 7
True 3 0 3
True 4 0 4
True 5 0 5
True 5 0 5
True 6 0 6
True 5 0 5
True 4 0 4
True 5 0 5
True 5 0 5
True 5 0 5
True 4 0 4
True 1 0 1
True 3 0 3
True 6 0 6
True 4 0 4
True 3 0 3
True 1 0 1
True 2 0 2
True 3 0 2
True 12 0 12
True 8 0 8
True 10 0 9
True 5 0 5
True 18 0 18
True 8 0 8
True 11 0 11
True 9 0 9
True 11 0 11
True 5 0 5
True 6 0 6
True 3 0 3
True 5 0 5
True 6 0 6
True 2 0 2
True 5 0 5
True 4 0 4
True 1 0 1
True 1 0 0
True 1 0 1
True 3 0 3
True 2 0 2
True 2 0 2
True 1 0 1
True 3 0 3
True 2 0 2
True 0 0 0

# Have a look at FWHM of Psf using python/getMetadata.py
# Also, need to grab metadata:

tar cf - outputs5_doPreConvolve*/deepDiff/*/*/metadata*boost | ssh acbecker@darkstar.astro.washington.edu "(cd LSST/Winter2014; tar xvfBp -)"

Error: RuntimeError: No registry for lookup
Soln : scp outputs5_doPreConvolveTrue/_parent/registry.sqlite3 acbecker@darkstar.astro.washington.edu:/astro/store/shared-scratch1/acbecker/LSST/Winter2014/outputs5_doPreConvolveTrue/
       scp outputs5_doPreConvolveFalse/_parent/registry.sqlite3 acbecker@darkstar.astro.washington.edu:/astro/store/shared-scratch1/acbecker/LSST/Winter2014/outputs5_doPreConvolveFalse/


# TO get the FWHM I think I need the .fits files, unfortunately...  Just run this at NCSA then.

Script python/readRepository.py creates the figures:
  figures/outputs5_doPreConvolveFalse_fp.png
  figures/outputs5_doPreConvolveTrue_fp.png

Strangely, the prefilter=False g-band data did not get a massive
number of false positives like the r,i-band.

  ds9 outputs5_doPreConvolveFalse/deepDiff/v*1-f*/R22/diffexp-S11.fits

Shows that its not particularly deconvolved at all...  Should check
the PSF FWHM of the templates?  Because the FWHM of the science images
look basically the same across passbands.  Call python/readFwhm.py.

g 4866601 1.54
g 4866602 2.15
g 4866603 2.83
g 48868666 2.15

r 5866601 1.50
r 5866602 2.05
r 5866603 2.71
r 58868666 2.05

i 6866601 1.42
i 6866602 2.00
i 6866603 2.63
i 68868666 1.98

# Hmm, nothing obvious sticks out.  Perhaps somehow a better basis set
  got chosen for the g-band deconvolution?  Will have to look into
  this...

The kernel sizes for the deconvolution are def different:

 g 4866601 0 0 (3, 3, 3) 3 (1.061952119373826, 1.679093731632156, 3.096095861348896) 21
 r 5866601 0 0 (3, 3, 3) 3 (1.966236059888755, 3.108892183401854, 5.732513939560749) 33
 i 6866601 0 0 (3, 3, 3) 3 (1.950371507896025, 3.083808124224259, 5.686261219809308) 33


So the algorithm perhaps is poor.  Wonder if I can fix r,i by fixing the basis functions:

# Test1
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=False subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1/imageDifferenceWinter2013.out5
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=False subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1/imageDifferenceWinter2013.out6

# WORKED!
[becker@lsst-dev ~/Winter2014]$ python python/examineDeconvolution.py
# /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1
g 5866601 0 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 0 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 0 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 1 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 1 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 1 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 2 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 2 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
g 5866601 2 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 0 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 0 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 0 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 1 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 1 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 1 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 2 0 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 2 1 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21
r 6866601 2 2 (3, 3, 3) 3 (1.06, 1.68, 3.19) 21

# Counting the nubmers of false positives

# /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test1
r 5866601 0 0 1.50 8.61 1 0 0
r 5866601 0 1 1.51 8.50 0 0 0
r 5866601 0 2 1.50 8.57 0 0 0
r 5866601 1 0 1.50 8.53 0 0 0
r 5866601 1 1 1.50 8.58 0 0 0
r 5866601 1 2 1.50 8.58 0 0 0
r 5866601 2 0 1.50 8.57 1 0 0
r 5866601 2 1 1.50 8.58 0 0 0
r 5866601 2 2 1.50 8.58 0 0 0

i 6866601 0 0 1.42 9.56 1 0 0
i 6866601 0 1 1.43 9.40 0 0 0
i 6866601 0 2 1.42 9.52 1 0 0
i 6866601 1 0 1.43 9.43 0 0 0
i 6866601 1 1 1.42 9.54 1 0 0
i 6866601 1 2 1.42 9.51 0 0 0
i 6866601 2 0 1.42 9.50 1 0 0
i 6866601 2 1 1.42 9.52 0 0 0
i 6866601 2 2 1.43 9.49 0 0 0

# VS:
# /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse

r 5866601 0 0 1.50 8.61 52257 431 51407
r 5866601 0 1 1.51 8.50 61495 443 60508
r 5866601 0 2 1.50 8.57 52737 464 51827
r 5866601 1 0 1.50 8.53 44653 569 43718
r 5866601 1 1 1.50 8.58 48721 455 47853
r 5866601 1 2 1.50 8.58 62262 477 61214
r 5866601 2 0 1.50 8.57 58765 436 57826
r 5866601 2 1 1.50 8.58 59605 607 58503
r 5866601 2 2 1.50 8.58 58483 442 57549

i 6866601 0 0 1.42 9.56 49330 505 48387
i 6866601 0 1 1.43 9.40 51140 572 50116
i 6866601 0 2 1.42 9.52 48952 503 48050
i 6866601 1 0 1.43 9.43 33119 464 32386
i 6866601 1 1 1.42 9.54 39867 501 39024
i 6866601 1 2 1.42 9.51 53586 511 52606
i 6866601 2 0 1.42 9.50 49164 453 48300
i 6866601 2 1 1.42 9.52 51474 550 50511
i 6866601 2 2 1.43 9.49 44422 491 43576

# HUGE DIFFERENCE!  So the kernel config is really quite important
  here, and the default for deconv is poor.  It is surprising that we
  are getting no false positives though, we may have inflated the
  variance by deconvolving.  Have a look at these numbers.

Ah, we were running up against the minSigma term, which doesn't get
used in the deconvolution case.  We were hitting a value of 0.68 for
r,i-band and the limit was 0.7.  Knock this down to 0.5 for g,i and
re-run:

# Test2
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test2 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True subtract.kernel.active.alardMinSig=0.5 --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test2/imageDifferenceWinter2013.out5
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test2 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True subtract.kernel.active.alardMinSig=0.5 --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test2/imageDifferenceWinter2013.out6

OK, these look decent, and few false positives.

r 5866601 0 0 1.50 8.61 3 0 0
r 5866601 0 1 1.51 8.50 2 0 2
r 5866601 0 2 1.50 8.57 1 0 0
r 5866601 1 0 1.50 8.53 3 0 2
r 5866601 1 1 1.50 8.58 2 0 1
r 5866601 1 2 1.50 8.58 1 0 1
r 5866601 2 0 1.50 8.57 2 0 1
r 5866601 2 1 1.50 8.58 0 0 0
r 5866601 2 2 1.50 8.58 2 0 1
i 6866601 0 0 1.42 9.56 1 0 0
i 6866601 0 1 1.43 9.40 0 0 0
i 6866601 0 2 1.42 9.52 2 0 2
i 6866601 1 0 1.43 9.43 0 0 0
i 6866601 1 1 1.42 9.54 1 0 1
i 6866601 1 2 1.42 9.51 0 0 0
i 6866601 2 0 1.42 9.50 3 0 1
i 6866601 2 1 1.42 9.52 1 0 1
i 6866601 2 2 1.43 9.49 1 0 1

Still way below expectations, so I need to check the variance.
Perhaps we can't fix this aspect of the problem.

# Made some minor changes to make sure the min sig value is different during deconvolution:
# Test3
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test3 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test3/imageDifferenceWinter2013.out5
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601 --output=/nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test3 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[3,3,3]" subtract.kernel.active.alardSigGauss="[1.06,1.68,3.19]" doSelectDcrCatalog=True --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5_doPreConvolveFalse_test3/imageDifferenceWinter2013.out6

# Worked.
r 5866601 0 0 1.50 8.61 3 0 0
r 5866601 0 1 1.51 8.50 2 0 2
r 5866601 0 2 1.50 8.57 1 0 0
r 5866601 1 0 1.50 8.53 3 0 2
r 5866601 1 1 1.50 8.58 2 0 1
r 5866601 1 2 1.50 8.58 1 0 1
r 5866601 2 0 1.50 8.57 2 0 1
r 5866601 2 1 1.50 8.58 0 0 0
r 5866601 2 2 1.50 8.58 2 0 1
i 6866601 0 0 1.42 9.56 1 0 0
i 6866601 0 1 1.43 9.40 0 0 0
i 6866601 0 2 1.42 9.52 2 0 2
i 6866601 1 0 1.43 9.43 0 0 0
i 6866601 1 1 1.42 9.54 1 0 1
i 6866601 1 2 1.42 9.51 0 0 0
i 6866601 2 0 1.42 9.50 3 0 1
i 6866601 2 1 1.42 9.52 1 0 1
i 6866601 2 2 1.43 9.49 1 0 1

# Re run all data to make sure this works, and then move on.

#g
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse/imageDifferenceWinter2013.out4
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=4866601^4866602^4866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=48868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue/imageDifferenceWinter2013.out4

#r
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse/imageDifferenceWinter2013.out5
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=5866601^5866602^5866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=58868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue/imageDifferenceWinter2013.out5

#i
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse/imageDifferenceWinter2013.out6
$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs5 --id visit=6866601^6866602^6866603 --output=/nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=68868666 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config -j 9 >& /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue/imageDifferenceWinter2013.out6


# /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveTrue
g 4866601 0 0 1.53 8.18 16 0 3
g 4866601 0 1 1.55 8.05 11 0 0
g 4866601 0 2 1.54 8.14 18 0 4
g 4866601 1 0 1.54 8.10 14 0 2
g 4866601 1 1 1.54 8.11 14 0 2
g 4866601 1 2 1.54 8.17 9 0 1
g 4866601 2 0 1.54 8.16 13 2 0
g 4866601 2 1 1.53 8.21 15 0 2
g 4866601 2 2 1.54 8.15 9 0 2
g 4866602 0 0 2.13 4.23 9 0 3
g 4866602 0 1 2.16 4.12 4 0 0
g 4866602 0 2 2.15 4.18 10 0 3
g 4866602 1 0 2.15 4.16 4 0 2
g 4866602 1 1 2.15 4.16 4 0 1
g 4866602 1 2 2.15 4.17 4 0 0
g 4866602 2 0 2.15 4.16 4 0 1
g 4866602 2 1 2.15 4.17 7 0 3
g 4866602 2 2 2.15 4.18 2 0 1
g 4866603 0 0 2.81 2.44 1 0 0
g 4866603 0 1 2.82 2.42 4 0 0
g 4866603 0 2 2.82 2.42 3 0 1
g 4866603 1 0 2.82 2.42 1 0 1
g 4866603 1 1 2.83 2.40 3 0 1
g 4866603 1 2 2.83 2.40 2 0 0
g 4866603 2 0 2.84 2.39 6 0 1
g 4866603 2 1 2.84 2.39 4 0 3
g 4866603 2 2 2.85 2.38 3 0 0
r 5866601 0 0 1.50 8.61 8 0 0
r 5866601 0 1 1.51 8.50 9 0 4
r 5866601 0 2 1.50 8.57 13 0 2
r 5866601 1 0 1.50 8.53 6 0 1
r 5866601 1 1 1.50 8.58 5 0 3
r 5866601 1 2 1.50 8.58 10 0 1
r 5866601 2 0 1.50 8.57 11 0 4
r 5866601 2 1 1.50 8.58 7 0 0
r 5866601 2 2 1.50 8.58 3 0 1
r 5866602 0 0 2.04 4.64 6 0 0
r 5866602 0 1 2.07 4.50 5 0 2
r 5866602 0 2 2.05 4.58 5 0 0
r 5866602 1 0 2.06 4.56 6 0 3
r 5866602 1 1 2.05 4.57 5 0 1
r 5866602 1 2 2.05 4.58 4 0 2
r 5866602 2 0 2.06 4.55 7 0 1
r 5866602 2 1 2.06 4.56 6 0 1
r 5866602 2 2 2.05 4.58 5 0 1
r 5866603 0 0 2.69 2.66 4 0 2
r 5866603 0 1 2.70 2.65 1 0 0
r 5866603 0 2 2.70 2.65 3 0 2
r 5866603 1 0 2.70 2.65 7 0 3
r 5866603 1 1 2.71 2.62 4 0 0
r 5866603 1 2 2.72 2.60 3 0 1
r 5866603 2 0 2.72 2.61 1 0 0
r 5866603 2 1 2.72 2.60 2 0 1
r 5866603 2 2 2.72 2.60 3 0 0
i 6866601 0 0 1.42 9.56 12 0 1
i 6866601 0 1 1.43 9.40 8 0 0
i 6866601 0 2 1.42 9.52 10 0 2
i 6866601 1 0 1.43 9.43 5 0 1
i 6866601 1 1 1.42 9.54 18 0 2
i 6866601 1 2 1.42 9.51 8 0 3
i 6866601 2 0 1.42 9.50 12 0 3
i 6866601 2 1 1.42 9.52 9 0 1
i 6866601 2 2 1.43 9.49 11 0 1
i 6866602 0 0 1.99 4.86 6 0 0
i 6866602 0 1 2.02 4.74 6 0 0
i 6866602 0 2 2.00 4.81 3 0 1
i 6866602 1 0 2.00 4.81 5 0 1
i 6866602 1 1 2.00 4.80 6 0 0
i 6866602 1 2 2.00 4.80 2 0 0
i 6866602 2 0 2.01 4.78 6 0 2
i 6866602 2 1 2.00 4.81 6 0 0
i 6866602 2 2 2.00 4.80 1 0 0
i 6866603 0 0 2.62 2.82 1 0 0
i 6866603 0 1 2.63 2.79 1 0 0
i 6866603 0 2 2.63 2.80 3 0 3
i 6866603 1 0 2.62 2.80 2 0 0
i 6866603 1 1 2.64 2.77 2 0 0
i 6866603 1 2 2.65 2.75 1 0 0
i 6866603 2 0 2.64 2.76 3 0 0
i 6866603 2 1 2.65 2.75 2 0 1
i 6866603 2 2 2.65 2.75 0 0 0
# /nfs/lsst/home/becker/Winter2014/outputs5b_doPreConvolveFalse
g 4866601 0 0 1.53 8.18 8 0 1
g 4866601 0 1 1.55 8.05 0 0 0
g 4866601 0 2 1.54 8.14 2 0 0
g 4866601 1 0 1.54 8.10 2 0 1
g 4866601 1 1 1.54 8.11 3 0 1
g 4866601 1 2 1.54 8.17 1 0 0
g 4866601 2 0 1.54 8.16 1 0 0
g 4866601 2 1 1.53 8.21 1 0 0
g 4866601 2 2 1.54 8.15 2 0 2
g 4866602 0 0 2.13 4.23 12 0 1
g 4866602 0 1 2.16 4.12 6 0 1
g 4866602 0 2 2.15 4.18 7 0 3
g 4866602 1 0 2.15 4.16 7 0 4
g 4866602 1 1 2.15 4.16 9 0 1
g 4866602 1 2 2.15 4.17 11 0 0
g 4866602 2 0 2.15 4.16 3 0 2
g 4866602 2 1 2.15 4.17 8 0 2
g 4866602 2 2 2.15 4.18 6 0 1
g 4866603 0 0 2.81 2.44 2 0 0
g 4866603 0 1 2.82 2.42 5 0 0
g 4866603 0 2 2.82 2.42 4 0 1
g 4866603 1 0 2.82 2.42 1 0 1
g 4866603 1 1 2.83 2.40 4 0 1
g 4866603 1 2 2.83 2.40 3 0 1
g 4866603 2 0 2.84 2.39 7 0 1
g 4866603 2 1 2.84 2.39 4 0 3
g 4866603 2 2 2.85 2.38 4 0 0
r 5866601 0 0 1.50 8.61 3 0 0
r 5866601 0 1 1.51 8.50 2 0 2
r 5866601 0 2 1.50 8.57 1 0 0
r 5866601 1 0 1.50 8.53 3 0 2
r 5866601 1 1 1.50 8.58 2 0 1
r 5866601 1 2 1.50 8.58 1 0 1
r 5866601 2 0 1.50 8.57 2 0 1
r 5866601 2 1 1.50 8.58 0 0 0
r 5866601 2 2 1.50 8.58 2 0 1
r 5866602 0 0 2.04 4.64 4 0 1
r 5866602 0 1 2.07 4.50 9 0 6
r 5866602 0 2 2.05 4.58 6 0 1
r 5866602 1 0 2.06 4.56 9 0 5
r 5866602 1 1 2.05 4.57 9 0 6
r 5866602 1 2 2.05 4.58 5 0 2
r 5866602 2 0 2.06 4.55 8 0 3
r 5866602 2 1 2.06 4.56 9 0 1
r 5866602 2 2 2.05 4.58 5 0 1
r 5866603 0 0 2.69 2.66 5 0 2
r 5866603 0 1 2.70 2.65 2 0 1
r 5866603 0 2 2.70 2.65 2 0 1
r 5866603 1 0 2.70 2.65 5 0 3
r 5866603 1 1 2.71 2.62 6 0 0
r 5866603 1 2 2.72 2.60 6 0 1
r 5866603 2 0 2.72 2.61 1 0 0
r 5866603 2 1 2.72 2.60 6 0 0
r 5866603 2 2 2.72 2.60 4 0 0
i 6866601 0 0 1.42 9.56 1 0 0
i 6866601 0 1 1.43 9.40 0 0 0
i 6866601 0 2 1.42 9.52 2 0 2
i 6866601 1 0 1.43 9.43 0 0 0
i 6866601 1 1 1.42 9.54 1 0 1
i 6866601 1 2 1.42 9.51 0 0 0
i 6866601 2 0 1.42 9.50 3 0 1
i 6866601 2 1 1.42 9.52 1 0 1
i 6866601 2 2 1.43 9.49 1 0 1
i 6866602 0 0 1.99 4.86 6 0 2
i 6866602 0 1 2.02 4.74 8 0 2
i 6866602 0 2 2.00 4.81 7 0 4
i 6866602 1 0 2.00 4.81 5 0 2
i 6866602 1 1 2.00 4.80 7 0 2
i 6866602 1 2 2.00 4.80 3 0 1
i 6866602 2 0 2.01 4.78 7 0 2
i 6866602 2 1 2.00 4.81 6 0 2
i 6866602 2 2 2.00 4.80 2 0 1
i 6866603 0 0 2.62 2.82 1 0 1
i 6866603 0 1 2.63 2.79 4 0 0
i 6866603 0 2 2.63 2.80 3 0 3
i 6866603 1 0 2.62 2.80 5 0 1
i 6866603 1 1 2.64 2.77 3 0 0
i 6866603 1 2 2.65 2.75 5 0 1
i 6866603 2 0 2.64 2.76 3 0 0
i 6866603 2 1 2.65 2.75 5 0 2
i 6866603 2 2 2.65 2.75 2 0 0

# OK, so things basically are working here.  Lets look at variance, as
I expect that this is causing the small numbers of false positives in
the deconvolution.  python/examineVariance.py

Some numbers:
Visit  sx sy V      W       W/V      X      V     W     W/V       X     V       W       W/V       X     V     W     W/V     Y     Z
-----------------------------------------------------------------------------------------------------------------------------------------
4866601 0 0 105.000 106.185 1.011: T -0.023 4.053 4.094 1.010 : F 0.689 173.815 175.767 1.011 : C 0.781 4.199 3.016 0.718 : 0.737 1.036


V   = the propogated variance (median of variance plane)
W   = the empirical variance (0.741 IQR of image plane)
X   = the median of the image plane
W/V = how much the variance plane underestimates the true variance
Y   = ratio of the empirical varince in C to the empirical variance in T
Z   = ratio of the median variance in C to the median variance in T

I do this for the image first, then preconvolve=T, preconvolve=F, and
then I go ahead and convolve the normal difference image by its Psf,
called C, and look at those results as well.

# First, look at the v5 results with the misconfigured deconvolution:
5866601 0 0 136.000 135.582 0.997: T -0.002 5.461 5.511 1.009 : F -5.861 142.373 144.731 1.017 : C -5.526 3.693 4.530 1.226 : 0.822 0.676
5866601 0 1 137.000 137.285 1.002: T  0.015 5.446 5.490 1.008 : F -6.158 142.495 144.739 1.016 : C -5.728 3.723 4.576 1.229 : 0.833 0.684
5866601 0 2 136.000 136.471 1.003: T -0.034 5.494 5.522 1.005 : F -5.916 142.297 144.147 1.013 : C -5.850 3.741 3.974 1.062 : 0.720 0.681
5866601 1 0 137.000 135.987 0.993: T -0.022 5.418 5.446 1.005 : F -5.658 142.409 144.890 1.017 : C -5.468 3.709 4.023 1.085 : 0.739 0.685
5866601 1 1 137.000 137.258 1.002: T -0.076 5.509 5.566 1.010 : F -5.785 142.345 144.486 1.015 : C -5.695 3.725 4.082 1.096 : 0.733 0.676
5866601 1 2 137.000 135.846 0.992: T -0.005 5.480 5.522 1.008 : F -6.216 142.346 144.333 1.014 : C -5.758 3.744 4.527 1.209 : 0.820 0.683
5866601 2 0 136.000 135.948 1.000: T  0.002 5.473 5.494 1.004 : F -6.104 142.389 143.845 1.010 : C -5.974 3.697 4.385 1.186 : 0.798 0.675
5866601 2 1 136.000 135.913 0.999: T -0.072 5.477 5.518 1.008 : F -6.103 142.275 144.329 1.014 : C -5.851 3.716 4.378 1.178 : 0.793 0.679
5866601 2 2 137.000 136.543 0.997: T -0.064 5.463 5.505 1.008 : F -6.061 142.409 144.632 1.016 : C -5.598 3.709 5.274 1.422 : 0.958 0.679
6866601 0 0 130.000 130.145 1.001: T -0.030 5.856 5.875 1.003 : F -5.764 136.340 138.423 1.015 : C -5.645 3.866 4.386 1.135 : 0.747 0.660
6866601 0 1 130.000 129.595 0.997: T -0.042 5.838 5.878 1.007 : F -5.826 136.366 138.205 1.013 : C -5.748 3.847 4.192 1.090 : 0.713 0.659
6866601 0 2 130.000 130.794 1.006: T -0.066 5.882 5.909 1.005 : F -5.779 136.319 138.234 1.014 : C -5.804 3.877 3.941 1.017 : 0.667 0.659
6866601 1 0 130.000 128.877 0.991: T -0.020 5.822 5.862 1.007 : F -5.284 136.387 138.878 1.018 : C -5.225 3.864 4.160 1.077 : 0.710 0.664
6866601 1 1 130.000 129.000 0.992: T -0.077 5.912 5.934 1.004 : F -5.544 136.282 138.147 1.014 : C -5.583 3.888 3.995 1.028 : 0.673 0.658
6866601 1 2 130.000 129.133 0.993: T -0.028 5.880 5.908 1.005 : F -5.903 136.297 138.123 1.013 : C -5.939 3.865 4.130 1.069 : 0.699 0.657
6866601 2 0 130.000 131.401 1.011: T -0.027 5.861 5.897 1.006 : F -5.804 136.305 137.398 1.008 : C -5.823 3.868 3.968 1.026 : 0.673 0.660
6866601 2 1 130.000 128.903 0.992: T -0.044 5.868 5.916 1.008 : F -5.827 136.268 138.376 1.015 : C -5.732 3.877 4.064 1.048 : 0.687 0.661
6866601 2 2 130.000 130.610 1.005: T -0.032 5.843 5.877 1.006 : F -5.625 136.336 138.336 1.015 : C -5.511 3.865 4.059 1.050 : 0.691 0.662

                                   Precovolution                Deconvolution                    Deconvolution Convolved      DC/P
4866601 0 0 105.000 106.185 1.011: T -0.023 4.053 4.094 1.010 : F  0.689 173.815 175.767 1.011 : C  0.781 4.199 3.016 0.718 : 0.737 1.036
4866601 0 1 105.000 105.197 1.002: T -0.058 4.051 4.076 1.006 : F  0.578 175.584 177.336 1.010 : C  0.665 4.256 3.006 0.706 : 0.738 1.050
4866601 0 2 105.000 105.841 1.008: T -0.087 4.067 4.091 1.006 : F  0.515 175.637 178.238 1.015 : C  0.601 4.294 3.022 0.704 : 0.739 1.056
4866601 1 0 105.000 105.217 1.002: T -0.051 4.027 4.066 1.010 : F  0.740 172.129 173.939 1.011 : C  0.833 4.183 3.023 0.723 : 0.744 1.039
4866601 1 1 105.000 104.227 0.993: T -0.094 4.105 4.128 1.006 : F  0.471 178.726 180.636 1.011 : C  0.558 4.409 3.063 0.695 : 0.742 1.074
4866601 1 2 105.000 105.476 1.005: T -0.004 4.096 4.130 1.008 : F  0.709 175.174 177.036 1.011 : C  0.797 4.343 3.083 0.710 : 0.747 1.060
4866601 2 0 105.000 105.914 1.009: T -0.081 4.090 4.122 1.008 : F  0.507 177.031 178.889 1.010 : C  0.594 4.373 3.056 0.699 : 0.741 1.069
4866601 2 1 105.000 104.571 0.996: T -0.013 4.104 4.148 1.011 : F  0.525 176.736 179.186 1.014 : C  0.612 4.385 3.088 0.704 : 0.744 1.069
4866601 2 2 105.000 104.548 0.996: T -0.089 4.073 4.102 1.007 : F  0.584 174.431 176.152 1.010 : C  0.677 4.252 3.015 0.709 : 0.735 1.044
4866602 0 0 105.000 105.718 1.007: T -0.038 1.907 1.926 1.010 : F -0.369 107.375 108.202 1.008 : C -0.206 1.424 1.483 1.041 : 0.770 0.747
4866602 0 1 105.000 105.037 1.000: T -0.068 1.885 1.900 1.008 : F -0.080 107.509 108.044 1.005 : C  0.080 1.406 1.465 1.042 : 0.771 0.746
4866602 0 2 105.000 106.082 1.010: T -0.049 1.893 1.913 1.010 : F -0.009 106.978 107.975 1.009 : C  0.153 1.419 1.481 1.043 : 0.774 0.750
4866602 1 0 105.000 105.032 1.000: T -0.000 1.873 1.890 1.009 : F -0.050 107.389 108.016 1.006 : C  0.110 1.403 1.468 1.046 : 0.777 0.749
4866602 1 1 105.000 104.739 0.998: T -0.022 1.918 1.941 1.012 : F -0.394 107.671 108.351 1.006 : C -0.234 1.438 1.503 1.045 : 0.774 0.750
4866602 1 2 105.000 105.213 1.002: T -0.027 1.913 1.932 1.010 : F -0.406 107.600 108.188 1.005 : C -0.243 1.430 1.492 1.043 : 0.772 0.748
4866602 2 0 105.000 105.428 1.004: T -0.028 1.898 1.917 1.010 : F  0.025 107.496 108.025 1.005 : C  0.186 1.422 1.483 1.043 : 0.774 0.749
4866602 2 1 105.000 104.496 0.995: T  0.070 1.916 1.939 1.012 : F -0.306 107.630 108.345 1.007 : C -0.145 1.433 1.495 1.043 : 0.771 0.748
4866602 2 2 105.000 105.688 1.007: T -0.012 1.923 1.933 1.005 : F -0.342 107.686 108.106 1.004 : C -0.184 1.438 1.493 1.038 : 0.772 0.748
4866603 0 0 105.000 105.874 1.008: T -0.028 1.097 1.115 1.016 : F -0.186 105.344 106.503 1.011 : C -0.025 0.866 0.910 1.052 : 0.816 0.789
4866603 0 1 105.000 105.233 1.002: T -0.029 1.093 1.102 1.008 : F -0.195 106.192 106.775 1.005 : C -0.029 0.864 0.901 1.043 : 0.817 0.790
4866603 0 2 105.000 105.529 1.005: T -0.000 1.085 1.097 1.011 : F -0.168 106.166 106.603 1.004 : C -0.004 0.860 0.900 1.047 : 0.821 0.792
4866603 1 0 105.000 105.334 1.003: T -0.005 1.085 1.106 1.019 : F -0.182 106.184 106.776 1.006 : C -0.017 0.860 0.906 1.054 : 0.819 0.792
4866603 1 1 105.000 103.306 0.984: T -0.004 1.075 1.089 1.013 : F -0.181 106.181 106.895 1.007 : C -0.016 0.850 0.887 1.044 : 0.815 0.791
4866603 1 2 105.000 104.632 0.996: T -0.021 1.064 1.086 1.021 : F -0.168 106.175 106.896 1.007 : C -0.001 0.851 0.896 1.052 : 0.825 0.800
4866603 2 0 105.000 105.070 1.001: T -0.029 1.074 1.085 1.011 : F -0.175 106.161 106.594 1.004 : C -0.012 0.856 0.892 1.043 : 0.822 0.797
4866603 2 1 105.000 104.769 0.998: T  0.036 1.074 1.095 1.019 : F -0.152 106.165 106.766 1.006 : C  0.014 0.857 0.898 1.049 : 0.821 0.798
4866603 2 2 105.000 106.062 1.010: T -0.014 1.064 1.081 1.016 : F -0.206 106.153 106.603 1.004 : C -0.037 0.841 0.881 1.048 : 0.815 0.791
5866601 0 0 136.000 135.582 0.997: T -0.002 5.461 5.511 1.009 : F  1.498 204.161 206.195 1.010 : C  1.606 5.297 4.146 0.783 : 0.752 0.970
5866601 0 1 137.000 137.285 1.002: T  0.015 5.446 5.490 1.008 : F  1.607 207.050 209.103 1.010 : C  1.710 5.375 4.148 0.772 : 0.756 0.987
5866601 0 2 136.000 136.471 1.003: T -0.034 5.494 5.522 1.005 : F  1.308 209.883 212.148 1.011 : C  1.412 5.518 4.163 0.754 : 0.754 1.004
5866601 1 0 137.000 135.987 0.993: T -0.022 5.418 5.446 1.005 : F  1.518 203.435 205.266 1.009 : C  1.626 5.298 4.134 0.780 : 0.759 0.978
5866601 1 1 137.000 137.258 1.002: T -0.076 5.509 5.566 1.010 : F  1.263 210.229 212.212 1.009 : C  1.367 5.488 4.180 0.762 : 0.751 0.996
5866601 1 2 137.000 135.846 0.992: T -0.005 5.480 5.522 1.008 : F  1.409 209.295 211.191 1.009 : C  1.510 5.485 4.168 0.760 : 0.755 1.001
5866601 2 0 136.000 135.948 1.000: T  0.002 5.473 5.494 1.004 : F  1.528 208.501 210.061 1.007 : C  1.631 5.414 4.104 0.758 : 0.747 0.989
5866601 2 1 136.000 135.913 0.999: T -0.072 5.477 5.518 1.008 : F  1.295 209.813 212.267 1.012 : C  1.393 5.473 4.146 0.758 : 0.751 0.999
5866601 2 2 137.000 136.543 0.997: T -0.064 5.463 5.505 1.008 : F  1.437 207.840 209.652 1.009 : C  1.534 5.400 4.123 0.763 : 0.749 0.988
5866602 0 0 136.000 136.041 1.000: T  0.000 2.707 2.717 1.004 : F  0.047 139.057 139.842 1.006 : C  0.208 2.024 2.093 1.034 : 0.770 0.748
5866602 0 1 137.000 136.822 0.999: T  0.071 2.679 2.700 1.008 : F  0.111 139.091 139.812 1.005 : C  0.271 2.011 2.093 1.041 : 0.775 0.750
5866602 0 2 136.000 135.705 0.998: T  0.012 2.691 2.724 1.012 : F  0.014 139.049 139.746 1.005 : C  0.175 2.022 2.112 1.045 : 0.775 0.751
5866602 1 0 137.000 136.322 0.995: T  0.034 2.663 2.688 1.009 : F  0.066 139.011 139.861 1.006 : C  0.225 2.000 2.089 1.044 : 0.777 0.751
5866602 1 1 137.000 137.618 1.005: T -0.009 2.714 2.747 1.012 : F  0.062 139.226 140.072 1.006 : C  0.221 2.039 2.132 1.046 : 0.776 0.751
5866602 1 2 137.000 137.176 1.001: T -0.018 2.715 2.743 1.011 : F -0.267 139.336 140.199 1.006 : C -0.106 2.033 2.116 1.041 : 0.771 0.749
5866602 2 0 136.000 136.028 1.000: T  0.014 2.694 2.720 1.010 : F  0.082 139.064 139.806 1.005 : C  0.241 2.026 2.119 1.046 : 0.779 0.752
5866602 2 1 136.000 135.432 0.996: T  0.003 2.714 2.748 1.012 : F -0.272 139.257 140.076 1.006 : C -0.113 2.041 2.128 1.043 : 0.774 0.752
5866602 2 2 137.000 136.912 0.999: T -0.072 2.730 2.746 1.006 : F -0.339 139.417 140.058 1.005 : C -0.175 2.046 2.121 1.036 : 0.772 0.750
5866603 0 0 136.000 134.462 0.989: T -0.014 1.555 1.569 1.009 : F -0.190 137.277 137.847 1.004 : C -0.022 1.224 1.280 1.046 : 0.816 0.787
5866603 0 1 137.000 136.454 0.996: T  0.012 1.547 1.560 1.008 : F -0.135 137.293 138.050 1.006 : C  0.034 1.209 1.260 1.042 : 0.808 0.782
5866603 0 2 136.000 135.507 0.996: T -0.010 1.538 1.553 1.010 : F -0.120 137.256 137.972 1.005 : C  0.046 1.215 1.267 1.043 : 0.816 0.790
5866603 1 0 137.000 136.641 0.997: T -0.021 1.538 1.551 1.008 : F -0.134 137.290 138.424 1.008 : C  0.029 1.208 1.262 1.044 : 0.813 0.785
5866603 1 1 137.000 135.880 0.992: T -0.045 1.528 1.552 1.015 : F -0.216 137.290 138.395 1.008 : C -0.044 1.203 1.260 1.047 : 0.812 0.787
5866603 1 2 137.000 137.190 1.001: T -0.022 1.515 1.532 1.011 : F -0.261 137.278 138.242 1.007 : C -0.098 1.197 1.251 1.045 : 0.817 0.790
5866603 2 0 136.000 136.242 1.002: T  0.028 1.519 1.536 1.011 : F -0.153 137.248 138.096 1.006 : C  0.009 1.207 1.262 1.046 : 0.822 0.794
5866603 2 1 136.000 135.730 0.998: T  0.013 1.515 1.538 1.015 : F -0.253 137.231 138.168 1.007 : C -0.089 1.203 1.257 1.045 : 0.817 0.794
5866603 2 2 136.000 136.170 1.001: T -0.035 1.512 1.520 1.006 : F -0.260 137.235 137.977 1.005 : C -0.094 1.197 1.240 1.036 : 0.816 0.792
6866601 0 0 130.000 130.145 1.001: T -0.030 5.856 5.875 1.003 : F  1.406 205.833 207.684 1.009 : C  1.510 5.840 4.343 0.744 : 0.739 0.997
6866601 0 1 130.000 129.595 0.997: T -0.042 5.838 5.878 1.007 : F  1.440 205.997 207.440 1.007 : C  1.541 5.817 4.335 0.745 : 0.737 0.996
6866601 0 2 130.000 130.794 1.006: T -0.066 5.882 5.909 1.005 : F  1.311 209.790 212.171 1.011 : C  1.402 5.973 4.358 0.730 : 0.737 1.015
6866601 1 0 130.000 128.877 0.991: T -0.020 5.822 5.862 1.007 : F  1.488 202.661 204.064 1.007 : C  1.589 5.759 4.363 0.758 : 0.744 0.989
6866601 1 1 130.000 129.000 0.992: T -0.077 5.912 5.934 1.004 : F  1.211 208.238 210.052 1.009 : C  1.311 5.940 4.374 0.736 : 0.737 1.005
6866601 1 2 130.000 129.133 0.993: T -0.028 5.880 5.908 1.005 : F  1.382 208.034 210.060 1.010 : C  1.481 5.899 4.355 0.738 : 0.737 1.003
6866601 2 0 130.000 131.401 1.011: T -0.027 5.861 5.897 1.006 : F  1.368 208.455 210.284 1.009 : C  1.463 5.938 4.352 0.733 : 0.738 1.013
6866601 2 1 130.000 128.903 0.992: T -0.044 5.868 5.916 1.008 : F  1.354 207.862 210.199 1.011 : C  1.448 5.921 4.384 0.740 : 0.741 1.009
6866601 2 2 130.000 130.610 1.005: T -0.032 5.843 5.877 1.006 : F  1.381 203.756 205.233 1.007 : C  1.482 5.807 4.355 0.750 : 0.741 0.994
6866602 0 0 130.000 130.739 1.006: T -0.065 2.723 2.747 1.009 : F -0.015 132.537 133.283 1.006 : C  0.147 2.036 2.121 1.042 : 0.772 0.748
6866602 0 1 130.000 128.827 0.991: T -0.017 2.685 2.701 1.006 : F  0.014 132.777 133.140 1.003 : C  0.176 2.006 2.085 1.040 : 0.772 0.747
6866602 0 2 130.000 130.844 1.006: T -0.039 2.702 2.725 1.009 : F -0.029 132.291 133.240 1.007 : C  0.132 2.028 2.114 1.042 : 0.776 0.751
6866602 1 0 130.000 128.997 0.992: T -0.027 2.678 2.698 1.007 : F  0.025 132.729 133.256 1.004 : C  0.187 2.014 2.096 1.041 : 0.777 0.752
6866602 1 1 130.000 128.747 0.990: T -0.044 2.726 2.747 1.008 : F -0.053 132.874 133.299 1.003 : C  0.106 2.040 2.121 1.040 : 0.772 0.748
6866602 1 2 130.000 130.649 1.005: T -0.018 2.716 2.736 1.007 : F  0.006 132.820 133.364 1.004 : C  0.164 2.024 2.107 1.041 : 0.770 0.745
6866602 2 0 130.000 131.050 1.008: T  0.011 2.696 2.718 1.008 : F -0.036 132.162 133.154 1.008 : C  0.124 2.010 2.092 1.041 : 0.770 0.746
6866602 2 1 130.000 128.814 0.991: T -0.030 2.725 2.753 1.011 : F -0.048 132.903 133.363 1.003 : C  0.114 2.042 2.129 1.042 : 0.773 0.750
6866602 2 2 130.000 129.886 0.999: T -0.043 2.727 2.748 1.008 : F -0.044 132.643 133.163 1.004 : C  0.116 2.041 2.124 1.041 : 0.773 0.748
6866603 0 0 130.000 130.606 1.005: T -0.005 1.570 1.589 1.012 : F -0.166 130.574 131.497 1.007 : C -0.001 1.236 1.293 1.046 : 0.814 0.787
6866603 0 1 130.000 128.721 0.990: T -0.041 1.564 1.572 1.005 : F -0.253 131.264 131.673 1.003 : C -0.094 1.236 1.283 1.038 : 0.816 0.791
6866603 0 2 130.000 131.641 1.013: T  0.041 1.551 1.565 1.009 : F -0.123 130.475 131.648 1.009 : C  0.043 1.228 1.278 1.041 : 0.816 0.791
6866603 1 0 130.000 128.607 0.989: T -0.025 1.555 1.563 1.005 : F -0.170 131.265 131.828 1.004 : C -0.007 1.231 1.279 1.038 : 0.818 0.792
6866603 1 1 130.000 129.296 0.995: T -0.029 1.543 1.561 1.012 : F -0.215 131.240 131.731 1.004 : C -0.053 1.221 1.273 1.043 : 0.815 0.791
6866603 1 2 130.000 128.584 0.989: T -0.009 1.528 1.537 1.006 : F -0.188 131.231 131.679 1.003 : C -0.024 1.216 1.260 1.036 : 0.820 0.796
6866603 2 0 130.000 129.457 0.996: T  0.004 1.532 1.546 1.009 : F -0.168 131.215 131.668 1.003 : C -0.010 1.216 1.264 1.039 : 0.818 0.794
6866603 2 1 130.000 129.187 0.994: T -0.006 1.533 1.558 1.016 : F -0.260 131.229 131.873 1.005 : C -0.090 1.221 1.277 1.046 : 0.820 0.796
6866603 2 2 130.000 130.043 1.000: T  0.021 1.516 1.531 1.010 : F -0.137 130.566 131.562 1.008 : C  0.029 1.195 1.242 1.040 : 0.811 0.788

##################
########## SIMS8 analysis
##################

output directories are called : outputs8XY
 X = template airmass ABCDE
 Y = science image airmass ABCDE

A quick check shows that we are indeed getting lots of false positives
for the off-diagonal diffs.  Will need to quantify and then start to
think about workarounds.

Need to wrap my head around the DCR some more.

imhead inputs8/calexp/v100?001-fg/R22/S11.fits -e 0 -K AZIMUTH,ZENITH,AIRMASS,ROTANG,SPIDANG
 inputs8/calexp/v1000001-fg/R22/S11.fits[0]:           105.3   49.86  1.551   251.06 145.71 
 inputs8/calexp/v1001001-fg/R22/S11.fits[0]:           98.79   30.06  1.155   251.06 152.27 
 inputs8/calexp/v1002001-fg/R22/S11.fits[0]:           269.9   0.100  1.000   251.06 341.09 
 inputs8/calexp/v1003001-fg/R22/S11.fits[0]:           261.2   30.04  1.155   251.06 349.86 
 inputs8/calexp/v1004001-fg/R22/S11.fits[0]:           254.6   49.84  1.550   251.06 356.41

OK, so the ZENITH and AIRMASS terms seem as-designed.  Good for me.

The ROTANG = rotskypos = 251 degrees.  I really should have made this
0 for sanity's sake, but I used the value in the W13 sims.  So be it.
I think this means that in a North-up coordinate system, the pole is
251 degrees counterclockwise from "up", so 20 degrees below the
x-axis.

The AZIMUTH seem to wrap around at 90 <-> 270.  I think I understand
this as a change in convention when you pass through the meridian.  As
Simon says: "you will necessarily have a discontinuity at 270--90
since in one case you are measuring azimuth to the East and in the
other you are measuring [...] to the West."

For SPIDANG, which is supposed to represent the rotTelPos and thus the
angle that DCR should take along the y-axis.  Now this is where it
gets funky.  At airmass 1.5, after passing through zenith, we have DCR
basically along the y-axis (360 degrees).  I can at least imagine
that.  What does bother me though is the discontinuity at 160 <-> 340.
Not a discontinuity, really.  I need to write a script to plot this
up... plotDcr.py.

###########3

OK, after wrestling through this for an entire week, I think I have
figured this out.  First off, the orientation of the skypos/telpos was
opposite the analysis above.  I guess its counterclockwise in teh
camera coordinate system, so clockwise in the image coordinate system.
Basically, I need to rotate all the vectors clockwise to deal with
this.  See script dcrSchematic.py to outline how all of this should
look.  The lines A, B, D, E, point to zenith in each of the 4 epochs.
P points to pole.  The angle PB and PD are the same, as you expect, as
are PA and PE.  For completeness, these angles are (skip C since its
right at zenith and az is changing wildly)

P: 251.068956606
A: 145.713981089
B: 152.270840596
D: 349.861933453
E: 356.418112888

Next up, look at the directions to zenith implied by the Wcs.  I do
this in scriptcompareDcrFromSims.py .  Basically, I find the Ra,Dec of
the center of the image, and find the Ra,Dec axes by taking small
setps along each dimension.  This matches up nicely with the N,E
schematic in the upper right hand corner of ds9 when I Wcs->Wcs it.

Next up, go to topocentric coordintes using 
  lsst = afwCoord.Observatory(-70.7494167 * afwGeom.degrees, -30.2446389 * afwGeom.degrees, 2662)
and 
  obsDate  = dafBase.DateTime(mjdI, dafBase.DateTime.MJD, dafBase.DateTime.TAI)
  epoch    = obsDate.get(dafBase.DateTime.EPOCH)

AND NOTE! I need to use this epoch for all the positions on the image;
I was not using this initially and was getting non-orthagonal looking
coordinate systems.

Anyways, go to topocentric coords (Az, Alt) and then do the same
thing, taking small steps along each axis to figure out its
orientation.  Convert back to Fk5 and the sky2xy.  

NOTE NOTE: seriously need to keep epoch straight, e.g. 
  off2   = altoff.toFk5(epoch)

Use it everywhere.

Anyways, I find the dx and dy offsets when moving 0.003 degrees in
altitude, to get the vector pointing along increasing altutude.  

For image A, this is dx = 30.9911671363 pixels, dy = -44.1538055818
pixels, or np.arctan(30.9911671363/-44.1538055818) * 180 / np.pi =
-35.0646785559.  So this is the angle counterclockwise from y-axis.
Or 90-35.0646785559 = 54.9353214441 degrees downward from the x-axis,
and 144.9353214441 from "up".  Compare to rotTelPos = 145.713981089.

Or duh, use dy/dx : np.arctan(44.1538055818/30.9911671363) * 180 /
np.pi + 90 = 144.93532144495424.  Same diff.

For image D, this is dx = 2.72619957337, dy = -53.8747993858.
np.arctan(-2.72619957337/53.8747993858) * 180 / np.pi is
2.8968388475727358 degrees counterclockwise from vertical.  Or
357.1031611524273 clockwise.  Compare to 356.418112888.

OK, so this is basically makging sense.  

ALSO, A VERY IMPORTANT POINT: refraction is in the direction of
zenith.  That is, things seem higher in the atmosphere than they are
(e.g. you can see the sun after it has set).  So I need to make the
DCR vectors in the direction of increasing altitude, not decreasing.

The MJDs of all 5 obs:
sims8/1000000.trim:Opsim_expmjd 51130.111719
sims8/1001000.trim:Opsim_expmjd 51130.176302
sims8/1002000.trim:Opsim_expmjd 51130.272830
sims8/1003000.trim:Opsim_expmjd 51130.368663
sims8/1004000.trim:Opsim_expmjd 51130.433247

From compareDcrFromSims.py, the axis angles should be (lets see if
there is any band dependnece to this; basically this should tell us
about the Wcs fitting)

# g
         Ra      Decl    Az     Alt
ANGLES A -18.929 251.067 54.939 144.935
ANGLES B -18.932 251.070 61.094 151.088
ANGLES D -18.930 251.069 260.970 -9.031
ANGLES E -18.932 251.072 267.104 -2.897

# r
         Ra      Decl    Az     Alt
ANGLES A -18.929 251.067 54.939 144.935
ANGLES B -18.932 251.071 61.095 151.089
ANGLES D -18.930 251.069 260.970 -9.031
ANGLES E -18.932 251.072 267.104 -2.896

# Doublechecking visidId {'filter': 'r', 'raft': '2,2', 'sensor': '1,1', 'visit': 2004002}

# i
         Ra      Decl    Az     Alt
ANGLES A -18.929 251.068 54.939 144.936
ANGLES B -18.932 251.070 61.094 151.089
ANGLES D -18.930 251.069 260.970 -9.031
ANGLES E -18.932 251.071 267.103 -2.897
[
# Compare to rotTelPos
A: 145.713981089
B: 152.270840596
D: 349.861933453 = -10.138066547
E: 356.418112888 = -3.581887112

# Now to compare the actual dipole angles!!!!!  This should be
# interesting...  Hopefully they all got processed instead of skipped
# because there were too many

First lets count the dipoles
prefilter=True
g A A [1, 0, 6, 1, 2, 1, 0, 3, 0]
g A B [214, 222, 202, 242, 142, 223, 200, 234, 215]
g A C [277, 321, 268, 324, 261, 302, 259, 335, 263]
g A D [204, 245, 222, 258, 200, 211, 222, 247, 225]
g A E [207, 219, 216, 229, 196, 198, 202, 218, 203]
g B A [130, 115, 132, 236, 115, 128, 124, 200, 117]
g B B [0, 3, 3, 0, 0, 0, 3, 4, 1]
g B C [199, 201, 217, 224, 163, 200, 201, 214, 201]
g B D [200, 217, 214, 230, 187, 191, 198, 215, 208]
g B E [204, 219, 212, 226, 185, 201, 205, 215, 201]
g C A [202, 229, 221, 237, 202, 202, 207, 231, 202]
g C B [155, 206, 211, 225, 143, 154, 151, 195, 196]
g C C [4, 2, 6, 2, 3, 5, 6, 10, 3]
g C D [159, 201, 163, 213, 154, 158, 143, 166, 195]
g C E [207, 220, 215, 230, 197, 202, 200, 215, 201]
g D A [202, 211, 212, 226, 188, 199, 199, 220, 200]
g D B [201, 210, 214, 231, 187, 202, 205, 219, 204]
g D C [169, 209, 207, 222, 155, 205, 168, 216, 158]
g D D [2, 2, 2, 2, 5, 3, 0, 4, 0]
g D E [130, 118, 127, 206, 128, 127, 130, 128, 121]
g E A [191, 214, 210, 226, 186, 190, 198, 222, 199]
g E B [215, 234, 222, 233, 204, 211, 208, 233, 224]
g E C [264, 277, 299, 261, 224, 237, 286, 280, 239]
g E D [154, 206, 208, 227, 145, 154, 150, 213, 146]
g E E [1, 1, 0, 1, 2, 0, 3, 3, 2]
g 1 [[   1.  215.  277.  222.  207.]
 [ 128.    1.  201.  208.  205.]
 [ 207.  195.    4.  163.  207.]
 [ 202.  205.  205.    2.  128.]
 [ 199.  222.  264.  154.    1.]]
r A A [2, 2, 5, 1, 1, 2, 1, 0, 1]
r A B [13, 9, 12, 8, 7, 13, 12, 10, 10]
r A C [63, 65, 61, 71, 57, 64, 75, 66, 61]
r A D [113, 93, 99, 135, 95, 104, 107, 106, 94]
r A E [121, 113, 125, 141, 109, 127, 115, 125, 115]
r B A [3, 11, 9, 8, 4, 4, 6, 5, 3]
r B B [3, 1, 4, 1, 0, 2, 3, 2, 3]
r B C [9, 12, 14, 7, 7, 11, 7, 10, 7]
r B D [58, 45, 59, 62, 48, 50, 59, 53, 51]
r B E [90, 71, 89, 104, 75, 86, 86, 82, 74]
r C A [31, 40, 46, 47, 29, 39, 49, 34, 31]
r C B [7, 11, 13, 9, 5, 8, 8, 4, 7]
r C C [3, 1, 3, 2, 1, 4, 2, 1, 2]
r C D [6, 5, 8, 6, 8, 10, 2, 5, 5]
r C E [31, 29, 28, 40, 33, 34, 28, 34, 26]
r D A [94, 86, 99, 104, 77, 97, 80, 78, 82]
r D B [51, 49, 62, 59, 47, 52, 64, 48, 43]
r D C [7, 6, 10, 10, 6, 7, 16, 7, 3]
r D D [0, 1, 1, 4, 0, 1, 1, 2, 1]
r D E [2, 3, 2, 2, 4, 5, 1, 4, 1]
r E A [129, 117, 135, 147, 116, 128, 116, 119, 114]
r E B [105, 93, 112, 121, 97, 100, 94, 96, 87]
r E C [60, 61, 74, 58, 46, 64, 61, 54, 47]
r E D [12, 11, 6, 7, 3, 6, 5, 7, 3]
r E E [2, 4, 0, 2, 1, 0, 0, 1, 0]
r 1 [[   1.   10.   64.  104.  121.]
 [   5.    2.    9.   53.   86.]
 [  39.    8.    2.    6.   31.]
 [  86.   51.    7.    1.    2.]
 [ 119.   97.   60.    6.    1.]]
i A A [3, 2, 3, 1, 1, 0, 1, 6, 1]
i A B [1, 4, 7, 3, 5, 2, 5, 6, 1]
i A C [7, 12, 5, 7, 8, 7, 7, 9, 7]
i A D [5, 10, 11, 12, 10, 12, 5, 7, 8]
i A E [13, 8, 11, 19, 11, 16, 19, 25, 13]
i B A [0, 1, 3, 2, 0, 0, 1, 5, 0]
i B B [1, 2, 1, 0, 5, 1, 4, 1, 1]
i B C [1, 1, 0, 2, 6, 4, 3, 3, 1]
i B D [2, 3, 2, 3, 2, 2, 4, 5, 2]
i B E [2, 3, 5, 9, 5, 7, 2, 11, 4]
i C A [3, 3, 5, 3, 1, 1, 1, 3, 0]
i C B [1, 4, 2, 1, 2, 2, 4, 2, 1]
i C C [0, 3, 2, 2, 3, 1, 2, 1, 1]
i C D [2, 1, 2, 1, 4, 2, 2, 2, 1]
i C E [4, 1, 3, 4, 3, 1, 1, 2, 0]
i D A [4, 6, 9, 5, 6, 5, 6, 6, 3]
i D B [3, 2, 5, 3, 2, 2, 5, 1, 2]
i D C [2, 2, 2, 1, 1, 2, 3, 2, 2]
i D D [3, 2, 2, 0, 1, 2, 3, 3, 1]
i D E [2, 0, 1, 4, 3, 0, 2, 1, 0]
i E A [11, 19, 16, 14, 10, 12, 18, 11, 16]
i E B [9, 9, 10, 9, 7, 9, 7, 8, 4]
i E C [8, 12, 5, 8, 5, 3, 8, 3, 8]
i E D [7, 4, 2, 3, 2, 1, 3, 5, 3]
i E E [4, 0, 1, 3, 1, 1, 0, 5, 0]
i 1 [[  1.   4.   7.  10.  13.]
 [  1.   1.   2.   2.   5.]
 [  3.   2.   2.   2.   2.]
 [  6.   2.   2.   2.   1.]
 [ 14.   9.   8.   3.   1.]]
g A A [2, 0, 1, 2, 2, 2, 2, 7, 2]
g A B [114, 114, 193, 225, 116, 119, 105, 119, 108]
g A C [207, 225, 219, 236, 184, 186, 211, 224, 209]
g A D [196, 211, 210, 225, 186, 190, 197, 220, 204]
g A E [188, 205, 206, 218, 183, 188, 187, 201, 195]
g B A [67, 62, 73, 96, 65, 71, 77, 74, 62]
g B B [2, 1, 1, 3, 3, 5, 3, 0, 0]
g B C [132, 115, 131, 203, 113, 124, 128, 121, 122]
g B D [206, 229, 230, 238, 205, 206, 210, 229, 218]
g B E [210, 228, 233, 238, 205, 209, 204, 223, 209]
g C A [234, 248, 230, 267, 224, 239, 229, 248, 238]
g C B [112, 98, 112, 210, 96, 111, 100, 107, 89]
g C C [1, 1, 0, 4, 0, 0, 8, 0, 0]
g C D [110, 97, 107, 197, 94, 106, 102, 102, 97]
g C E [221, 227, 232, 255, 219, 219, 223, 248, 229]
g D A [217, 241, 233, 246, 212, 215, 206, 245, 225]
g D B [207, 233, 233, 240, 202, 208, 211, 228, 213]
g D C [135, 114, 123, 201, 125, 130, 119, 126, 121]
g D D [1, 1, 2, 1, 2, 2, 2, 1, 1]
g D E [77, 71, 72, 97, 67, 79, 74, 71, 66]
g E A [192, 210, 200, 221, 183, 191, 186, 208, 198]
g E B [198, 210, 206, 228, 186, 199, 198, 210, 196]
g E C [197, 212, 211, 226, 196, 188, 200, 217, 201]
g E D [118, 108, 124, 203, 106, 122, 119, 117, 110]
g E E [2, 1, 0, 0, 1, 0, 1, 1, 0]
g 2 [[   2.  116.  211.  204.  195.]
 [  71.    2.  124.  218.  210.]
 [ 238.  107.    0.  102.  227.]
 [ 225.  213.  125.    1.   72.]
 [ 198.  199.  201.  118.    1.]]
r A A [0, 1, 2, 0, 0, 3, 0, 3, 0]
r A B [5, 1, 2, 3, 0, 4, 3, 6, 2]
r A C [30, 21, 34, 26, 24, 37, 38, 26, 29]
r A D [55, 54, 67, 72, 56, 60, 62, 67, 48]
r A E [71, 61, 70, 83, 62, 75, 73, 67, 64]
r B A [0, 4, 5, 3, 0, 2, 1, 5, 1]
r B B [2, 0, 2, 1, 1, 5, 1, 2, 3]
r B C [3, 0, 4, 4, 3, 3, 2, 3, 5]
r B D [11, 18, 20, 17, 16, 15, 11, 23, 13]
r B E [36, 29, 33, 44, 31, 38, 35, 36, 30]
r C A [5, 10, 13, 11, 8, 11, 9, 19, 8]
r C B [4, 1, 4, 3, 2, 6, 1, 2, 1]
r C C [0, 0, 2, 1, 2, 2, 2, 0, 2]
r C D [1, 2, 0, 1, 5, 1, 1, 1, 0]
r C E [8, 3, 9, 8, 9, 10, 6, 8, 4]
r D A [29, 33, 45, 44, 23, 35, 47, 37, 28]
r D B [22, 14, 26, 21, 13, 21, 25, 13, 9]
r D C [2, 1, 4, 7, 3, 3, 7, 2, 2]
r D D [1, 0, 2, 1, 1, 0, 0, 0, 1]
r D E [1, 0, 2, 1, 3, 2, 1, 1, 0]
r E A [59, 55, 86, 88, 63, 78, 77, 70, 68]
r E B [67, 55, 65, 64, 59, 65, 69, 55, 47]
r E C [31, 24, 30, 43, 26, 31, 37, 23, 13]
r E D [2, 4, 2, 1, 1, 2, 2, 2, 0]
r E E [2, 0, 1, 1, 1, 2, 0, 0, 1]
r 2 [[  0.   3.  29.  60.  70.]
 [  2.   2.   3.  16.  35.]
 [ 10.   2.   2.   1.   8.]
 [ 35.  21.   3.   1.   1.]
 [ 70.  64.  30.   2.   1.]]
i A A [1, 1, 2, 1, 1, 2, 0, 2, 0]
i A B [0, 1, 2, 0, 1, 1, 3, 1, 1]
i A C [2, 0, 1, 0, 1, 4, 0, 2, 2]
i A D [4, 2, 4, 3, 1, 1, 3, 3, 3]
i A E [1, 0, 3, 2, 2, 2, 2, 1, 2]
i B A [1, 0, 0, 1, 3, 1, 2, 4, 1]
i B B [1, 1, 3, 0, 2, 2, 2, 1, 4]
i B C [2, 0, 2, 0, 2, 1, 1, 1, 1]
i B D [3, 1, 1, 2, 3, 0, 3, 1, 2]
i B E [1, 0, 4, 2, 1, 1, 1, 0, 1]
i C A [1, 0, 2, 1, 3, 1, 1, 4, 0]
i C B [1, 1, 2, 0, 0, 2, 0, 0, 1]
i C C [1, 0, 1, 1, 2, 0, 1, 0, 2]
i C D [2, 0, 4, 1, 3, 2, 2, 1, 2]
i C E [2, 0, 2, 2, 1, 1, 1, 0, 1]
i D A [2, 2, 2, 1, 3, 1, 0, 6, 1]
i D B [1, 1, 2, 2, 1, 2, 1, 3, 2]
i D C [1, 0, 2, 1, 0, 1, 3, 1, 1]
i D D [4, 1, 3, 0, 0, 0, 4, 0, 1]
i D E [1, 0, 6, 0, 2, 0, 1, 0, 0]
i E A [1, 2, 5, 1, 3, 1, 2, 8, 1]
i E B [1, 3, 2, 2, 3, 1, 3, 3, 2]
i E C [2, 5, 1, 0, 3, 2, 6, 1, 4]
i E D [1, 0, 3, 2, 1, 1, 3, 1, 1]
i E E [1, 0, 2, 1, 1, 1, 1, 1, 0]
i 2 [[ 1.  1.  1.  3.  2.]
 [ 1.  2.  1.  2.  1.]
 [ 1.  1.  1.  2.  1.]
 [ 2.  2.  1.  1.  0.]
 [ 2.  2.  2.  1.  1.]]
g A A [0, 3, 0, 0, 2, 2, 0, 0, 0]
g A B [64, 61, 68, 84, 55, 76, 62, 71, 51]
g A C [224, 244, 243, 271, 226, 219, 234, 254, 239]
g A D [220, 254, 252, 257, 225, 214, 235, 256, 227]
g A E [234, 269, 256, 260, 230, 230, 235, 260, 246]
g B A [29, 29, 33, 35, 28, 33, 39, 39, 23]
g B B [0, 0, 3, 2, 0, 2, 1, 1, 0]
g B C [83, 70, 81, 92, 68, 88, 71, 76, 66]
g B D [220, 220, 216, 250, 200, 230, 213, 229, 219]
g B E [243, 254, 237, 275, 237, 240, 228, 259, 240]
g C A [234, 220, 240, 280, 217, 237, 210, 222, 211]
g C B [43, 48, 60, 68, 50, 58, 53, 54, 49]
g C C [1, 0, 1, 1, 0, 1, 2, 4, 0]
g C D [55, 53, 63, 60, 51, 57, 58, 56, 49]
g C E [230, 203, 217, 271, 210, 229, 215, 225, 99]
g D A [246, 246, 250, 283, 244, 245, 227, 259, 246]
g D B [223, 223, 216, 256, 209, 231, 210, 227, 223]
g D C [77, 74, 83, 86, 78, 77, 87, 77, 65]
g D D [1, 2, 1, 1, 3, 1, 1, 0, 0]
g D E [34, 36, 31, 33, 29, 39, 32, 32, 23]
g E A [241, 258, 253, 266, 232, 229, 237, 261, 250]
g E B [218, 247, 236, 250, 219, 213, 224, 237, 231]
g E C [216, 226, 225, 247, 213, 217, 216, 240, 219]
g E D [72, 63, 72, 85, 58, 74, 72, 68, 54]
g E E [0, 1, 1, 1, 0, 1, 0, 0, 0]
g 3 [[   0.   64.  239.  235.  246.]
 [  33.    1.   76.  220.  240.]
 [ 222.   53.    1.   56.  217.]
 [ 246.  223.   77.    1.   32.]
 [ 250.  231.  219.   72.    0.]]
r A A [1, 1, 0, 0, 1, 0, 0, 0, 1]
r A B [2, 3, 1, 3, 1, 1, 1, 2, 1]
r A C [12, 3, 10, 11, 6, 15, 8, 1, 6]
r A D [22, 21, 23, 23, 20, 20, 23, 19, 19]
r A E [29, 24, 29, 36, 24, 28, 29, 25, 23]
r B A [0, 1, 0, 2, 1, 0, 0, 1, 1]
r B B [0, 0, 2, 3, 0, 0, 0, 1, 0]
r B C [0, 0, 2, 2, 3, 4, 2, 0, 0]
r B D [2, 7, 4, 2, 4, 5, 4, 3, 5]
r B E [9, 7, 7, 10, 5, 9, 8, 4, 6]
r C A [1, 7, 4, 5, 1, 0, 2, 6, 0]
r C B [1, 0, 3, 1, 1, 1, 1, 0, 0]
r C C [2, 1, 1, 1, 1, 1, 2, 1, 1]
r C D [1, 2, 1, 0, 1, 3, 0, 2, 1]
r C E [2, 2, 0, 3, 1, 1, 0, 0, 4]
r D A [12, 13, 10, 11, 7, 10, 13, 8, 4]
r D B [3, 5, 6, 5, 4, 4, 1, 2, 4]
r D C [3, 0, 1, 2, 2, 1, 2, 1, 2]
r D D [1, 3, 0, 0, 0, 2, 0, 1, 2]
r D E [3, 1, 0, 2, 0, 0, 0, 0, 2]
r E A [31, 28, 32, 34, 27, 32, 33, 27, 29]
r E B [23, 19, 28, 26, 22, 29, 22, 12, 12]
r E C [13, 5, 18, 9, 7, 11, 12, 8, 4]
r E D [1, 4, 0, 0, 0, 1, 0, 2, 2]
r E E [4, 0, 0, 1, 0, 0, 0, 0, 1]
r 3 [[  0.   1.   8.  21.  28.]
 [  1.   0.   2.   4.   7.]
 [  2.   1.   1.   1.   1.]
 [ 10.   4.   2.   1.   0.]
 [ 31.  22.   9.   1.   0.]]
i A A [2, 0, 3, 2, 2, 0, 0, 0, 0]
i A B [1, 2, 0, 2, 0, 1, 2, 0, 0]
i A C [1, 1, 1, 0, 0, 0, 1, 1, 3]
i A D [1, 2, 1, 1, 2, 1, 0, 1, 5]
i A E [2, 1, 2, 1, 0, 3, 0, 4, 1]
i B A [1, 0, 1, 1, 2, 1, 0, 1, 0]
i B B [0, 1, 0, 0, 0, 1, 2, 0, 0]
i B C [0, 1, 2, 1, 0, 0, 3, 1, 4]
i B D [3, 1, 1, 0, 1, 1, 0, 1, 3]
i B E [1, 0, 1, 0, 0, 2, 0, 2, 0]
i C A [2, 0, 2, 2, 3, 1, 1, 2, 1]
i C B [0, 2, 0, 0, 0, 2, 1, 0, 1]
i C C [0, 1, 2, 0, 0, 0, 4, 0, 4]
i C D [1, 1, 2, 1, 0, 1, 0, 1, 2]
i C E [2, 0, 1, 0, 2, 2, 0, 2, 1]
i D A [1, 0, 3, 2, 3, 2, 1, 1, 1]
i D B [0, 0, 1, 1, 1, 1, 1, 1, 0]
i D C [3, 0, 2, 1, 0, 0, 1, 1, 2]
i D D [1, 2, 2, 0, 1, 1, 0, 0, 3]
i D E [1, 0, 0, 0, 2, 1, 0, 2, 0]
i E A [1, 0, 3, 2, 2, 0, 3, 0, 1]
i E B [0, 1, 1, 0, 0, 3, 2, 2, 0]
i E C [0, 1, 2, 0, 0, 0, 1, 3, 3]
i E D [2, 2, 0, 1, 0, 1, 0, 1, 2]
i E E [2, 1, 1, 0, 2, 2, 0, 4, 0]
i 3 [[ 0.  1.  1.  1.  1.]
 [ 1.  0.  1.  1.  0.]
 [ 2.  0.  0.  1.  1.]
 [ 1.  1.  1.  1.  0.]
 [ 1.  1.  1.  1.  1.]]

prefilter=False:
g A A [0, 0, 3, 3, 1, 1, 0, 2, 0]
g A B [2108, 2503, 2431, 2161, 2028, 2629, 2161, 2560, 2205]
g A C [30804, 40327, 23242, 31329, 20021, 47344, 29154, 42396, 31997]
g A D [1855, 2006, 1998, 2155, 1867, 2256, 1797, 2139, 2017]
g A E [379, 345, 364, 433, 346, 328, 343, 364, 325]
g B A [128, 112, 131, 235, 114, 129, 122, 198, 118]
g B B [0, 1, 1, 0, 0, 0, 0, 0, 0]
g B C [620, 599, 799, 654, 558, 619, 718, 711, 667]
g B D [192, 206, 210, 223, 188, 188, 190, 208, 195]
g B E [207, 218, 215, 227, 197, 202, 200, 212, 200]
g C A [205, 238, 231, 239, 206, 205, 208, 231, 200]
g C B [226, 233, 255, 255, 207, 253, 217, 281, 256]
g C C [1, 0, 0, 0, 0, 0, 1, 0, 0]
g C D [223, 271, 230, 239, 224, 236, 225, 267, 227]
g C E [210, 222, 219, 235, 200, 202, 198, 220, 202]
g D A [198, 214, 215, 227, 187, 190, 190, 215, 201]
g D B [192, 206, 209, 226, 186, 188, 192, 207, 196]
g D C [1036, 945, 1103, 1114, 1028, 1070, 1127, 1142, 996]
g D D [1, 0, 1, 2, 0, 0, 0, 0, 0]
g D E [128, 117, 125, 207, 124, 126, 123, 132, 123]
g E A [432, 439, 453, 482, 414, 416, 402, 474, 394]
g E B [1574, 1547, 1646, 1561, 1511, 1573, 1532, 1679, 1562]
g E C [6423, 7120, 6700, 4719, 4667, 7639, 6546, 8031, 6585]
g E D [1789, 1747, 1937, 1856, 1832, 1865, 1682, 1906, 1812]
g E E [1, 1, 0, 0, 1, 1, 3, 2, 1]
g 1 [[  1.00000000e+00   2.20500000e+03   3.13290000e+04   2.00600000e+03
    3.46000000e+02]
 [  1.28000000e+02   0.00000000e+00   6.54000000e+02   1.95000000e+02
    2.07000000e+02]
 [  2.08000000e+02   2.53000000e+02   0.00000000e+00   2.30000000e+02
    2.10000000e+02]
 [  2.01000000e+02   1.96000000e+02   1.07000000e+03   0.00000000e+00
    1.25000000e+02]
 [  4.32000000e+02   1.56200000e+03   6.58500000e+03   1.83200000e+03
    1.00000000e+00]]
r A A [2, 0, 2, 4, 1, 1, 0, 0, 0]
r A B [306, 415, 443, 310, 321, 447, 456, 434, 322]
r A C [2255, 2347, 2401, 2289, 2145, 2332, 2005, 2785, 2142]
r A D [559, 384, 402, 463, 405, 432, 667, 732, 573]
r A E [119, 116, 129, 140, 102, 123, 114, 118, 112]
r B A [5, 14, 8, 9, 5, 7, 8, 9, 2]
r B B [2, 0, 1, 1, 0, 0, 3, 1, 3]
r B C [3, 1, 7, 4, 1, 3, 2, 3, 0]
r B D [42, 28, 34, 32, 30, 24, 34, 29, 26]
r B E [91, 72, 86, 102, 73, 85, 85, 83, 76]
r C A [37, 43, 48, 47, 33, 42, 52, 36, 31]
r C B [21, 25, 17, 30, 22, 31, 23, 30, 26]
r C C [0, 0, 0, 1, 0, 0, 1, 0, 0]
r C D [27, 25, 40, 31, 19, 38, 24, 35, 23]
r C E [40, 35, 32, 49, 34, 40, 33, 39, 37]
r D A [93, 85, 106, 107, 77, 101, 89, 89, 83]
r D B [27, 20, 38, 35, 27, 28, 27, 20, 22]
r D C [1, 2, 9, 4, 3, 3, 18, 4, 3]
r D D [0, 0, 1, 2, 0, 0, 0, 0, 0]
r D E [2, 2, 1, 1, 3, 4, 1, 4, 1]
r E A [125, 111, 129, 142, 105, 124, 108, 112, 109]
r E B [444, 440, 565, 757, 441, 462, 548, 520, 486]
r E C [2182, 2226, 2443, 1980, 2102, 2045, 2101, 2547, 2202]
r E D [516, 496, 666, 579, 605, 545, 596, 625, 312]
r E E [5, 6, 3, 4, 1, 3, 1, 3, 3]
r 1 [[  1.00000000e+00   4.15000000e+02   2.28900000e+03   4.63000000e+02
    1.18000000e+02]
 [  8.00000000e+00   1.00000000e+00   3.00000000e+00   3.00000000e+01
    8.50000000e+01]
 [  4.20000000e+01   2.50000000e+01   0.00000000e+00   2.70000000e+01
    3.70000000e+01]
 [  8.90000000e+01   2.70000000e+01   3.00000000e+00   0.00000000e+00
    2.00000000e+00]
 [  1.12000000e+02   4.86000000e+02   2.18200000e+03   5.79000000e+02
    3.00000000e+00]]
i A A [2, 0, 2, 3, 0, 0, 1, 2, 0]
i A B [5, 7, 12, 4, 5, 12, 18, 13, 5]
i A C [226, 245, 303, 302, 226, 268, 300, 327, 221]
i A D [6, 3, 5, 15, 8, 5, 7, 7, 7]
i A E [11, 9, 12, 21, 5, 10, 13, 16, 12]
i B A [5, 7, 7, 2, 1, 3, 2, 8, 1]
i B B [7, 4, 1, 4, 3, 4, 4, 2, 3]
i B C [0, 0, 1, 2, 0, 1, 3, 1, 0]
i B D [8, 7, 11, 2, 2, 4, 8, 6, 8]
i B E [2, 3, 6, 8, 2, 6, 4, 11, 7]
i C A [0, 2, 7, 2, 0, 1, 0, 1, 0]
i C B [10, 15, 12, 9, 7, 16, 11, 15, 9]
i C C [10, 17, 11, 15, 6, 19, 10, 9, 13]
i C D [16, 9, 18, 4, 10, 11, 13, 16, 13]
i C E [5, 1, 3, 4, 1, 2, 1, 4, 0]
i D A [7, 10, 11, 7, 8, 9, 9, 7, 4]
i D B [3, 4, 3, 2, 2, 4, 5, 2, 2]
i D C [0, 2, 1, 1, 0, 1, 1, 0, 0]
i D D [12, 4, 6, 0, 6, 6, 5, 7, 4]
i D E [2, 1, 0, 4, 1, 1, 2, 1, 0]
i E A [10, 17, 14, 12, 4, 9, 10, 10, 9]
i E B [7, 7, 15, 4, 11, 10, 17, 7, 8]
i E C [197, 90, 325, 204, 92, 79, 276, 281, 102]
i E D [3, 3, 5, 9, 4, 4, 5, 1, 4]
i E E [9, 2, 5, 7, 3, 1, 1, 9, 1]
i 1 [[   1.    7.  268.    7.   12.]
 [   3.    4.    1.    7.    6.]
 [   1.   11.   11.   13.    2.]
 [   8.    3.    1.    6.    1.]
 [  10.    8.  197.    4.    3.]]
g A A [0, 0, 2, 2, 3, 2, 2, 9, 4]
g A B [123, 127, 203, 231, 122, 206, 117, 204, 122]
g A C [352, 341, 359, 392, 331, 318, 328, 340, 320]
g A D [211, 218, 223, 241, 200, 206, 211, 239, 214]
g A E [190, 209, 209, 224, 185, 189, 195, 210, 197]
g B A [68, 68, 81, 102, 67, 74, 81, 75, 64]
g B B [2, 4, 1, 4, 5, 7, 3, 0, 0]
g B C [131, 117, 129, 210, 112, 120, 202, 196, 121]
g B D [206, 225, 233, 234, 207, 207, 210, 229, 224]
g B E [211, 230, 242, 240, 203, 206, 206, 228, 211]
g C A [231, 254, 238, 271, 230, 237, 231, 250, 244]
g C B [115, 101, 114, 220, 100, 114, 106, 111, 93]
g C C [2, 4, 0, 7, 0, 2, 10, 1, 4]
g C D [112, 99, 113, 201, 98, 110, 104, 106, 101]
g C E [223, 233, 241, 264, 219, 215, 230, 256, 238]
g D A [215, 240, 240, 248, 215, 211, 208, 247, 225]
g D B [209, 231, 238, 238, 205, 205, 210, 229, 210]
g D C [214, 109, 202, 215, 118, 229, 119, 215, 115]
g D D [1, 4, 2, 0, 3, 2, 2, 1, 2]
g D E [82, 73, 76, 105, 70, 81, 80, 75, 73]
g E A [192, 215, 210, 227, 185, 189, 201, 219, 200]
g E B [192, 209, 209, 227, 191, 194, 192, 208, 195]
g E C [277, 291, 304, 404, 320, 314, 345, 336, 301]
g E D [134, 115, 138, 206, 117, 132, 132, 131, 123]
g E E [0, 0, 0, 0, 0, 1, 2, 1, 0]
g 2 [[   2.  127.  340.  214.  197.]
 [  74.    3.  129.  224.  211.]
 [ 238.  111.    2.  106.  233.]
 [ 225.  210.  202.    2.   76.]
 [ 201.  195.  314.  132.    0.]]
r A A [0, 2, 7, 3, 0, 4, 0, 5, 1]
r A B [5, 2, 4, 2, 0, 3, 2, 6, 2]
r A C [42, 54, 55, 39, 34, 68, 46, 56, 35]
r A D [56, 56, 68, 73, 54, 61, 64, 70, 48]
r A E [79, 64, 79, 84, 64, 78, 74, 69, 65]
r B A [0, 4, 6, 3, 0, 2, 1, 6, 1]
r B B [4, 0, 2, 2, 2, 5, 3, 6, 3]
r B C [3, 1, 3, 2, 1, 2, 1, 3, 2]
r B D [12, 21, 26, 17, 18, 17, 18, 25, 21]
r B E [37, 31, 34, 45, 33, 40, 37, 36, 34]
r C A [6, 11, 13, 11, 9, 11, 14, 23, 8]
r C B [4, 1, 4, 3, 2, 6, 2, 2, 1]
r C C [0, 1, 1, 1, 1, 1, 0, 0, 0]
r C D [1, 2, 0, 2, 3, 1, 1, 2, 0]
r C E [8, 3, 7, 7, 11, 10, 5, 9, 4]
r D A [31, 33, 50, 42, 27, 41, 50, 41, 32]
r D B [26, 18, 27, 25, 15, 21, 28, 14, 10]
r D C [1, 1, 3, 6, 4, 3, 8, 1, 0]
r D D [1, 1, 4, 1, 1, 0, 0, 0, 1]
r D E [1, 1, 2, 1, 3, 2, 2, 2, 1]
r E A [62, 59, 91, 89, 65, 77, 78, 74, 69]
r E B [67, 53, 63, 65, 55, 67, 70, 54, 45]
r E C [58, 54, 46, 52, 40, 50, 49, 72, 35]
r E D [2, 4, 1, 1, 2, 2, 4, 2, 3]
r E E [1, 1, 4, 0, 1, 2, 0, 0, 1]
r 2 [[  2.   2.  46.  61.  74.]
 [  2.   3.   2.  18.  36.]
 [ 11.   2.   1.   1.   7.]
 [ 41.  21.   3.   1.   2.]
 [ 74.  63.  50.   2.   1.]]
i A A [3, 2, 5, 0, 2, 1, 0, 2, 0]
i A B [0, 1, 1, 0, 0, 1, 4, 1, 1]
i A C [12, 22, 18, 26, 18, 22, 18, 27, 24]
i A D [4, 3, 3, 3, 1, 1, 3, 1, 4]
i A E [5, 3, 5, 4, 2, 3, 3, 1, 4]
i B A [0, 0, 1, 1, 3, 1, 3, 4, 1]
i B B [4, 1, 2, 1, 3, 4, 2, 3, 5]
i B C [5, 3, 6, 3, 3, 5, 2, 4, 4]
i B D [5, 3, 4, 2, 1, 3, 5, 5, 3]
i B E [1, 0, 4, 2, 1, 1, 1, 0, 1]
i C A [0, 0, 5, 0, 3, 1, 3, 7, 0]
i C B [2, 1, 2, 0, 3, 2, 3, 0, 3]
i C C [1, 0, 5, 1, 4, 2, 5, 5, 2]
i C D [2, 0, 4, 1, 1, 2, 4, 2, 2]
i C E [2, 1, 2, 2, 2, 1, 3, 0, 1]
i D A [2, 2, 4, 1, 3, 1, 1, 7, 1]
i D B [1, 3, 1, 2, 2, 3, 1, 5, 3]
i D C [3, 1, 6, 2, 1, 8, 5, 6, 4]
i D D [6, 2, 3, 1, 0, 1, 4, 0, 2]
i D E [2, 0, 7, 2, 2, 1, 1, 2, 1]
i E A [2, 4, 8, 1, 3, 1, 3, 8, 2]
i E B [1, 2, 1, 2, 3, 3, 3, 3, 2]
i E C [10, 16, 16, 14, 17, 15, 19, 22, 26]
i E D [1, 0, 2, 0, 1, 1, 1, 1, 1]
i E E [1, 1, 1, 3, 1, 2, 1, 3, 1]
i 2 [[  2.   1.  22.   3.   3.]
 [  1.   3.   4.   3.   1.]
 [  1.   2.   2.   2.   2.]
 [  2.   2.   4.   2.   2.]
 [  3.   2.  16.   1.   1.]]
g A A [0, 2, 0, 3, 3, 1, 0, 0, 0]
g A B [67, 62, 68, 88, 57, 75, 64, 72, 57]
g A C [229, 245, 248, 275, 228, 227, 241, 257, 247]
g A D [220, 256, 251, 258, 226, 219, 231, 257, 228]
g A E [235, 266, 257, 261, 230, 231, 237, 262, 249]
g B A [30, 30, 35, 41, 30, 31, 43, 39, 25]
g B B [0, 1, 3, 2, 1, 1, 1, 1, 0]
g B C [86, 78, 88, 99, 72, 90, 75, 77, 69]
g B D [215, 230, 229, 257, 204, 233, 215, 236, 232]
g B E [241, 257, 238, 277, 240, 239, 229, 263, 245]
g C A [236, 222, 242, 280, 221, 238, 209, 223, 209]
g C B [51, 49, 62, 68, 53, 57, 56, 63, 50]
g C C [1, 2, 1, 1, 0, 1, 2, 4, 2]
g C D [57, 53, 66, 66, 54, 59, 60, 59, 49]
g C E [228, 208, 221, 269, 206, 232, 214, 230, 105]
g D A [244, 249, 256, 283, 240, 245, 230, 265, 247]
g D B [227, 238, 226, 262, 212, 235, 217, 234, 226]
g D C [80, 79, 88, 93, 82, 78, 89, 80, 70]
g D D [0, 3, 1, 3, 1, 1, 1, 1, 0]
g D E [38, 37, 35, 35, 28, 42, 36, 34, 27]
g E A [241, 258, 247, 268, 230, 230, 238, 266, 250]
g E B [223, 249, 235, 257, 221, 213, 232, 244, 227]
g E C [221, 237, 235, 249, 222, 224, 223, 244, 225]
g E D [75, 68, 81, 87, 61, 76, 72, 72, 57]
g E E [0, 1, 1, 1, 2, 0, 0, 1, 0]
g 3 [[   0.   67.  245.  231.  249.]
 [  31.    1.   78.  230.  241.]
 [ 223.   56.    1.   59.  221.]
 [ 247.  227.   80.    1.   35.]
 [ 247.  232.  225.   72.    1.]]
r A A [1, 1, 0, 1, 2, 0, 0, 1, 2]
r A B [2, 3, 0, 3, 0, 1, 1, 2, 1]
r A C [13, 3, 10, 11, 7, 13, 8, 6, 9]
r A D [25, 23, 24, 24, 19, 21, 23, 20, 20]
r A E [32, 27, 32, 36, 25, 28, 28, 28, 22]
r B A [1, 1, 0, 2, 1, 0, 1, 1, 1]
r B B [0, 0, 2, 2, 0, 0, 1, 1, 1]
r B C [3, 0, 2, 3, 2, 4, 2, 0, 1]
r B D [2, 7, 4, 1, 3, 6, 4, 3, 6]
r B E [9, 7, 8, 8, 5, 13, 10, 5, 7]
r C A [1, 7, 5, 5, 1, 1, 3, 6, 0]
r C B [1, 0, 3, 1, 1, 1, 2, 0, 0]
r C C [2, 1, 1, 1, 1, 0, 1, 1, 1]
r C D [1, 2, 1, 0, 0, 3, 0, 2, 2]
r C E [2, 3, 0, 2, 1, 1, 1, 0, 4]
r D A [13, 13, 11, 13, 6, 13, 16, 10, 6]
r D B [4, 6, 6, 6, 4, 5, 4, 2, 5]
r D C [3, 0, 1, 2, 2, 1, 1, 2, 3]
r D D [1, 3, 0, 0, 1, 1, 0, 1, 2]
r D E [2, 2, 0, 1, 0, 0, 0, 0, 2]
r E A [30, 29, 37, 38, 31, 33, 36, 31, 33]
r E B [25, 19, 31, 25, 25, 27, 24, 14, 13]
r E C [12, 6, 18, 10, 8, 11, 14, 9, 3]
r E D [1, 4, 0, 1, 1, 0, 2, 1, 2]
r E E [3, 1, 0, 1, 0, 0, 1, 0, 2]
r 3 [[  1.   1.   9.  23.  28.]
 [  1.   1.   2.   4.   8.]
 [  3.   1.   1.   1.   1.]
 [ 13.   5.   2.   1.   0.]
 [ 33.  25.  10.   1.   1.]]
i A A [2, 0, 3, 2, 2, 0, 2, 2, 0]
i A B [1, 2, 0, 2, 0, 0, 3, 0, 0]
i A C [3, 2, 1, 0, 0, 0, 4, 4, 3]
i A D [1, 3, 1, 1, 3, 2, 0, 1, 6]
i A E [1, 1, 3, 1, 1, 3, 1, 5, 1]
i B A [1, 0, 1, 1, 2, 0, 2, 2, 1]
i B B [0, 2, 0, 0, 1, 2, 3, 0, 0]
i B C [0, 2, 1, 2, 1, 0, 3, 1, 4]
i B D [2, 3, 1, 2, 1, 1, 1, 1, 5]
i B E [1, 1, 2, 0, 1, 2, 0, 4, 0]
i C A [2, 1, 2, 2, 3, 1, 0, 2, 1]
i C B [2, 2, 0, 0, 2, 1, 1, 0, 1]
i C C [1, 2, 2, 0, 0, 0, 4, 0, 4]
i C D [1, 1, 2, 1, 0, 1, 1, 1, 3]
i C E [1, 0, 2, 0, 2, 2, 1, 3, 1]
i D A [1, 0, 2, 2, 3, 2, 1, 1, 1]
i D B [0, 1, 1, 1, 0, 3, 2, 1, 0]
i D C [2, 0, 1, 1, 1, 0, 1, 1, 3]
i D D [0, 2, 3, 0, 1, 1, 1, 0, 4]
i D E [0, 0, 0, 0, 2, 1, 0, 2, 0]
i E A [1, 0, 2, 2, 2, 0, 3, 1, 2]
i E B [1, 2, 1, 0, 0, 2, 2, 2, 1]
i E C [1, 2, 1, 1, 3, 0, 2, 3, 4]
i E D [3, 2, 0, 1, 1, 1, 0, 1, 3]
i E E [1, 1, 1, 0, 3, 2, 0, 4, 0]
i 3 [[ 2.  0.  2.  1.  1.]
 [ 1.  0.  1.  1.  1.]
 [ 2.  1.  1.  1.  1.]
 [ 1.  1.  1.  1.  0.]
 [ 2.  1.  2.  1.  1.]]

OK, heat maps anlsysis is basically done, though there are many
unanswered questions about the values in tehre.

Moving on to the dipole analysis with diaSourceDipoles.py. And ugh,
the measurements are quite poor!  The lobes of the dipoles are not
even being connected.  I need to really dig into this, sigh...

E.g. C A {'raft': '2,2', 'sensor': '2,2', 'visit': 1000001}
Note that this is prefilter=True 

The clear dipole at visual location:
  neg: 3223, 3203
  pos: 3226, 3198
Has naive measurements at:
  neg = (3225, 3196.1) 
  pos = (3225.9, 3171.9) 

This is going to take some digging in to...

Lets recreate the diffim command:

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs8 --id visit=1000001 raft=2,2 sensor=2,2 --output=/nfs/lsst/home/becker/Winter2014/outputs8CA_doPreConvolveTrue_test --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=1002000 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True  --clobber-config

ds9 outputs8CA_doPreConvolveTrue_test/deepDiff/v1000001-fg/R22/diffexp-S22.fits 

Yep, thats it.

Time to dig in...

So we do merge positive/negative guys.  
 winter2013ImageDifference.detection: Detected 198 positive sources to 5 sigma.
 winter2013ImageDifference.detection: Detected 199 negative sources to 5 sigma
 winter2013ImageDifference: Merging detections into 208 sources


# Ah, I bet this is the problem...  Not being triggered..?

            if self.config.doMeasurement:
                self.log.info("Running diaSource measurement")
                if len(diaSources) < self.config.maxDiaSourcesToMeasure:
                    self.dipoleMeasurement.run(subtractedExposure, diaSources)
                else:
                    self.measurement.run(subtractedExposure, diaSources)

grep maxDiaSourcesToMeasure outputs8CA_doPreConvolveTrue_test/config/deepDiff.py
   root.maxDiaSourcesToMeasure=200

Rerun with maxDiaSourcesToMeasure=300 and see what happens

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs8 --id visit=1000001 raft=2,2 sensor=2,2 --output=/nfs/lsst/home/becker/Winter2014/outputs8CA_doPreConvolveTrue_test --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=1002000 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True maxDiaSourcesToMeasure=300 --clobber-config
 
Actually, it looks like all the prefilter=True g-band ones have
between 200 and 300 false positives.  So I'll need to re-run the
g-band with this turned on.  r and i-band shoudl be fine since there
are so few false positives...

Just do it for these guys, don't bother with the prefilter=False ones.
Since we are just trying to characterize the angle and separation of
the dipoles.

Commands are in:
  SOURCE_ME_v8_redo_g
This has 25 lines, for each of 5 x 5 permutations of template and science image.  So this make sense.  Make it so!


While this is running, dig into that particular dipole to see whats up

New naive centroids are:
 (3222, 3202) (3225, 3197) 3.04475365955 -4.97916257859

Nice!  Taking into account that ds9 coords are -1 different than LSST
coords, this is exacly as I measured it by hand.  Now I can look at
the Psf centroids as well...

And jeez, the names of these fields are just horrible:

      (Field['PointD'](name="flux.dipole.psf.pos.centroid", doc="psf fitted center of positive lobe", units="pixels"), Key<PointD>(offset=424, nElements=2)),

Means centroid?  Who designed this...  Oh, me...

centPosNaive, centNegNaive, centPosPsf, centNegPsf 
 
(3225, 3197) (3222, 3202) (3225.5, 3197) (3222, 3202)

# Little more info
centPosNaive, centNegNaive, fluxPosNaive, fluxNegNaive, ":", centPosPsf, centNegPsf, fluxPosPsf, fluxNegPsf
(3225, 3197) (3222, 3202) 1989.26564687 -2150.14538127 : (3225.5, 3197) (3222, 3202) 2266.84624316 -2287.68371608


# Nice, we're actually getting decent answers out of the dipole
  fitting, at least in regards to flux.  A bit worried that because we
  are stepping in discrete units in the centroid, its going to impact
  the accuracy of our orientation vectors.  And frankly offset vectors.

Code says: $IP_DIFFIM_DIR/src/dipoleAlgorithm.cc
    int nStepsPer  = 10; // Total steps is nStepsPer**4
    float offset   = 0.5 * fwhm; // Maximum distance to search on either side of initial centroid
    float stepsize = 2 * offset / nStepsPer;

    for (float dnx = negativePeak->getFx() - offset;
         dnx <= negativePeak->getFx() + offset; dnx += stepsize) {

Just put a check in python/diaSourceDipoles.py indicates that this is
0.48 pixels for this image.  Going to limit the effectiveness of this.
Ah well...  Clear that the fitting is a limitation, needed to wrap it
in a minimzer in W13 but resource limited.  Here too.  I suppose that
using a large set of offsets from all the objects will allow me to
average over this quantization.

Averaging over all the dipoles, I find:
                                           Amp:          Angle:
 DX POSITIVE: 3.54609696944 -5.12843138307 6.23503104784 -55.337754208
 DX NEGAGIVE: -3.46931037124 5.12032092347 6.18496570818 -55.8801132742

And note that I am looking at CA, so template = zenith, science image
visit A.  Am measuring Dcr at an angle of 145.337754208.  VERY CLOSE
to expectations!  Sweet...  

Also the Blue stars are refracting down and to the right, and red
stars up and to the left here.  So DX POSITIVE are the blue stars, and
DX NEGATIVE are the red stars.  The amplitude of the blue stars is
slightly larger than that of the red stars, 1.247 arcseconds.  And for
the red stars its 1.237 arcseconds.  This is, frankly, a lot larger
than it should be...

I think part of the problem is the coarse step sizes in the centroid
fitter.  We really should place this in a minimizer...

Opening #3161 to address this issue.  Otherwise we simply will not
have very trustworthy dipole measurements.

OK, I need an upated meas-deblender because of #3112.

Which means I need an updated afw.  Here we go... :(

Note: I had to git pull and scons my own versions of the packages below:

 setup boost 1.55.0+1
 setup -k -r ~/LSST/DMS/base
 setup -k -r ~/LSST/DMS/utils
 setup -k -r ~/LSST/DMS/daf_base
 setup -k -r ~/LSST/DMS/pex_logging
 setup -k -r ~/LSST/DMS/pex_policy
 setup -k -r ~/LSST/DMS/daf_persistence
 setup -k -r ~/LSST/DMS/afw
 setup -k -r ~/LSST/DMS/meas_algorithms
 setup -k -r ~/LSST/DMS/meas_astrom
 setup -k -r ~/LSST/DMS/meas_deblender
 setup -k -r ~/LSST/DMS/ip_diffim_3161

OK, so I have the core changes implemented.  Try re-running 1 image and look at centroids:

# Make sure I have correct ip_diffim

[becker@lsst-dev ip_diffim_3161]$ echo $IP_DIFFIM_DIR/
/lsst/home/becker/LSST/DMS/ip_diffim_3161/

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs8 --id visit=1000001 raft=2,2 sensor=2,2 --output=/nfs/lsst/home/becker/Winter2014/outputs8CA_doPreConvolveTrue_test2 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=1002000 doPreConvolve=True subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True maxDiaSourcesToMeasure=300 --clobber-config

# Grr, and apparently I need to rebuild the rest of the world too,
  e.g. Isr even though I don't use it.

Ok, just ip_isr and coadd_utils.  Aaanyways, have a look at our dipole of interest:
print centNegPsf, centPosPsf, dx, dy, totalFlux, sigmaFlux 

(3222, 3201.8) (3225.2, 3197.1) 3.19099987461 -4.76768293033 -65.0522557941 -1.18400911132

vs previous:

(3222, 3202) (3225.5, 3197) 3.47583007812 -5.0 -20.8374729162 -0.998003238391


Still getting large offsets:
DX POSITIVE: 3.43571063182 -5.0423490684 6.10158927438 -55.7306157226
DX NEGAGIVE: -3.45315427988 5.02123037791 6.0940158343 -55.4832769685

Print out chi2/dof for these guys to see how the fits are going?
Perhaps its using the wrong Psf!?  I.e. the non-preconvolved one?

chi2dof = 4.52701854706

Suspicious...  Do I need a special algorithm to deblend prefiltered
dipoles?!  Perhaps...  Have a look at the post-filtered version.

ds9 outputs8CA_doPreConvolveFalse/deepDiff/v1000001-fg/R22/diffexp-S22.fits

Well, it looks reasonable.  Diff and examine:

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs8 --id visit=1000001 raft=2,2 sensor=2,2 --output=/nfs/lsst/home/becker/Winter2014/outputs8CA_doPreConvolveFalse_test2 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=1002000 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True maxDiaSourcesToMeasure=300 --clobber-config

This same guy is at:

# centNegPsf,    centPosPsf,    dx,             dy,            totalFlux,    sigmaFlux       chi2dof
(3223.3, 3199.9) (3223.9, 3199) 0.607663042198 -0.87289742889 -174.82037492 -0.0150162198269 1.05915951729

OK, so nice fit.  I trust this one.  Must be the deblending of
prefiltered sources.  Will make sure to only validate on the post
filtered data.

DX NEGAGIVE: -0.496835826997 0.709918266284 0.891893323592 -55.1122341925 # Red stars
DX POSITIVE: 0.465562610534 -0.694678880843 0.856425082116 -55.1564929567 # Blue stars

Empirical angles are 145.1 degrees!  And amplitudes are 0.89 pixels or so.

And from my DCR.py analysis:
dcr50["g"]["A"] = 55.7405440 diff=0.049"=0.246pixels
dcr50["g"]["G"] = 55.6911709
dcr50["g"]["M"] = 55.5859005 diff=0.105"=0.526pixels

dcr50["r"]["A"] = 55.1207659 diff=0.015"=0.075pixels
dcr50["r"]["G"] = 55.1057127
dcr50["r"]["M"] = 55.0806588 diff=0.025"=0.125pixels

dcr50["i"]["A"] = 54.8355931
dcr50["i"]["G"] = 54.8307703
dcr50["i"]["M"] = 54.8156433

We are seeing both objects with offsets of 0.8-0.9 pixels.  Hmm...
Not quite right.  This says to me that we are seeing Dcr at a level
3.5 larger for the blue star and 1.7 bigger for the red star.

What do things looks like in the r-band?

$PIPE_TASKS_DIR/bin/imageDifferenceWinter2013.py inputs8 --id visit=2000001 raft=2,2 sensor=2,2 --output=/nfs/lsst/home/becker/Winter2014/outputs8CA_doPreConvolveFalse_test2 --configfile imageDifferenceConfigGstar.py --config diaSourceMatchRadius=2.0 doAddCalexpBackground=False winter2013TemplateId=2002000 doPreConvolve=False subtract.kernel.active.singleKernelClipping=False subtract.kernel.active.kernelSumClipping=False subtract.kernel.active.spatialKernelClipping=False subtract.kernel.active.scaleByFwhm=True subtract.kernel.active.spatialKernelOrder=5 subtract.kernel.active.alardNGauss=3 subtract.kernel.active.alardDegGauss="[5,2,2]" subtract.kernel.active.alardSigGauss="[1.0,1.0,1.0]" doSelectDcrCatalog=True maxDiaSourcesToMeasure=300 --clobber-config

DX NEGAGIVE: -0.102892737342 0.238052539601 0.259337477061 -66.6246953357 # Red stars
DX POSITIVE: 0.117428376846 -0.159540712589 0.190471915626 -49.0136295024 # Blue stars

Obs getting into the noise here, only 10 measurements.  Will have to
do this in bulk with all 9 CCDs.  Quickie shows that we are still
getting too large of an offset.  Factor of 2 for red stars, and 2.5
for blue stars.

I updated DCR.py to include the phoSim values.  They agree with mine
on a per-wavelength basis.  However, when I look at the overall
refraction of an object with an SED, I see significant offsets.  Which
you DO expect, since the phoSim analysis is w.r.t. 500 nm.  This sets
the reference refraction of a field.  And since John refracts things
photon by photon (wavelength by wavelength) I don't see anything
obviously wrong with this approach.  But the as-realized results are
in fact different.  Let me take a step back and look at the
astrometric residuals...

imageDifferenceWinter2013.py ... doDebugRegister=True

Log the information in metadata, and also log (r-band)
 winter2013ImageDifference: Blue star offsets (long, lat in arcsec): 0.012 0.005, 0.004 0.003
 winter2013ImageDifference: Green star offsets (long, lat in arcsec): 0.000 0.004, 0.000 0.004
 winter2013ImageDifference: Red star offsets (long, lat in arcsec): -0.019 0.006, -0.005 0.006

 Corresponds to 0.013" and 0.020" for blue,red stars

And for g-band:
winter2013ImageDifference: Blue star offsets (long, lat in arcsec): 0.040 0.005, 0.012 0.003
winter2013ImageDifference: Green star offsets (long, lat in arcsec): 0.001 0.006, 0.000 0.004
winter2013ImageDifference: Red star offsets (long, lat in arcsec): -0.073 0.007, -0.022 0.005

 Corresponds to 0.042" and 0.076" for blue,red stars

So blue stars seem to be doing well, compared to theory.  And red
stars are *underrefracted" compared to theory.  Need to run this on
more images.  And I need to understand why the diffim dipoles are so
much different.

Make this a new pipeline run.  Only look at post filtered data since
dipole measurement is reasonable on this.  And add in
doDebugRegister=True to the commands.

And just look at template=C.  Ah, and also maxDiaSourcesToMeasure=???  Lets make it 1000.

Call this outputs8bCB.  Lookin like the DC3b PT1.2 days...

grep outputs8C SOURCE_ME_v8 | grep doPreConvolveFalse | wc -l
 15
 This makes sense; 3 filters, and 5 science image airmasses

grep outputs8C SOURCE_ME_v8 | grep doPreConvolveFalse > SOURCE_ME_v8b

##### Running

Hmm, my connection to NCSA got lost during the batch job
Did all the images get processed?
grep Red outputs8b*out | wc -l
 135
This is 15 * 9.  OK...

##### Looking at hopefully the final analyses!  Using 8b.

# Note, that these are the final analyses from the Wcs
ANGLES A -18.929 251.067 54.939 144.935
ANGLES B -18.932 251.070 61.094 151.088
ANGLES D -18.930 251.069 260.970 -9.031
ANGLES E -18.932 251.072 267.104 -2.897

##### From Dcr.py
g-band
# A-star Offsets at 30, 50 = 0.0239190067373 0.0493730820471
# G-star Offsets at 30, 50 = 0.0 0.0
# M-star Offsets at 30, 50 = -0.0509987215627 -0.105270427474

r-band
# A-star Offsets at 30, 50 = 0.00729258200544 0.0150531856803
# G-star Offsets at 30, 50 = 0.0 0.0
# M-star Offsets at 30, 50 = -0.0121374488206 -0.0250538520691

i-band
# A-star Offsets at 30, 50 = 0.0023364041907 0.00482275359795
# G-star Offsets at 30, 50 = 0.0 0.0
# M-star Offsets at 30, 50 = -0.00732835967789 -0.0151270371558


##### And lets get the residuals from the Wcs fits:
             blue   green  red  (in arcseconds)
# MEANS
g CA 1000001 0.0419 0.0022 0.0759
g CA 1000002 0.0420 0.0022 0.0771
g CA 1000003 0.0423 0.0024 0.0787
g CB 1001001 0.0204 0.0011 0.0378
g CB 1001002 0.0204 0.0009 0.0388
g CB 1001003 0.0206 0.0014 0.0393
g CC 1002001 0.0004 0.0001 0.0006
g CC 1002002 0.0006 0.0002 0.0008
g CC 1002003 0.0008 0.0002 0.0009
g CD 1003001 0.0199 0.0010 0.0374
g CD 1003002 0.0197 0.0010 0.0389
g CD 1003003 0.0199 0.0014 0.0389
g CE 1004001 0.0422 0.0025 0.0761
g CE 1004002 0.0422 0.0025 0.0775
g CE 1004003 0.0421 0.0025 0.0784

r CA 2000001 0.0126 0.0004 0.0202
r CA 2000002 0.0128 0.0005 0.0198
r CA 2000003 0.0129 0.0006 0.0203
r CB 2001001 0.0065 0.0004 0.0098
r CB 2001002 0.0062 0.0003 0.0098
r CB 2001003 0.0066 0.0004 0.0101
r CC 2002001 0.0004 0.0002 0.0010
r CC 2002002 0.0004 0.0001 0.0008
r CC 2002003 0.0005 0.0002 0.0012
r CD 2003001 0.0061 0.0003 0.0096
r CD 2003002 0.0060 0.0002 0.0092
r CD 2003003 0.0062 0.0004 0.0101
r CE 2004001 0.0126 0.0004 0.0198
r CE 2004002 0.0127 0.0004 0.0197
r CE 2004003 0.0128 0.0005 0.0200

i CA 3000001 0.0045 0.0006 0.0117
i CA 3000002 0.0047 0.0008 0.0122
i CA 3000003 0.0044 0.0006 0.0126
i CB 3001001 0.0024 0.0003 0.0051
i CB 3001002 0.0025 0.0003 0.0053
i CB 3001003 0.0021 0.0005 0.0065
i CC 3002001 0.0005 0.0002 0.0009
i CC 3002002 0.0007 0.0002 0.0008
i CC 3002003 0.0008 0.0002 0.0013
i CD 3003001 0.0025 0.0004 0.0059
i CD 3003002 0.0024 0.0004 0.0057
i CD 3003003 0.0025 0.0003 0.0062
i CE 3004001 0.0046 0.0006 0.0114
i CE 3004002 0.0049 0.0005 0.0111
i CE 3004003 0.0057 0.0006 0.0113

# MEDIANS
g CA 1000001 0.0421 0.0018 0.0761
g CA 1000002 0.0417 0.0020 0.0773
g CA 1000003 0.0422 0.0021 0.0796
g CB 1001001 0.0207 0.0010 0.0377
g CB 1001002 0.0205 0.0007 0.0383
g CB 1001003 0.0204 0.0014 0.0395
g CC 1002001 0.0004 0.0001 0.0004
g CC 1002002 0.0005 0.0002 0.0006
g CC 1002003 0.0007 0.0002 0.0010
g CD 1003001 0.0200 0.0012 0.0373
g CD 1003002 0.0200 0.0009 0.0387
g CD 1003003 0.0197 0.0011 0.0388
g CE 1004001 0.0431 0.0024 0.0754
g CE 1004002 0.0419 0.0024 0.0771
g CE 1004003 0.0432 0.0026 0.0782

r CA 2000001 0.0126 0.0004 0.0201
r CA 2000002 0.0130 0.0004 0.0195
r CA 2000003 0.0130 0.0006 0.0200
r CB 2001001 0.0066 0.0003 0.0102
r CB 2001002 0.0060 0.0003 0.0097
r CB 2001003 0.0066 0.0003 0.0100
r CC 2002001 0.0003 0.0001 0.0010
r CC 2002002 0.0004 0.0001 0.0005
r CC 2002003 0.0004 0.0002 0.0011
r CD 2003001 0.0062 0.0002 0.0099
r CD 2003002 0.0058 0.0002 0.0094
r CD 2003003 0.0065 0.0003 0.0100
r CE 2004001 0.0127 0.0004 0.0196
r CE 2004002 0.0126 0.0004 0.0197
r CE 2004003 0.0129 0.0004 0.0197

i CA 3000001 0.0043 0.0006 0.0119
i CA 3000002 0.0048 0.0008 0.0119
i CA 3000003 0.0042 0.0005 0.0126
i CB 3001001 0.0024 0.0003 0.0049
i CB 3001002 0.0023 0.0003 0.0056
i CB 3001003 0.0022 0.0005 0.0061
i CC 3002001 0.0005 0.0002 0.0007
i CC 3002002 0.0007 0.0002 0.0006
i CC 3002003 0.0007 0.0002 0.0015
i CD 3003001 0.0025 0.0004 0.0056
i CD 3003002 0.0026 0.0004 0.0057
i CD 3003003 0.0023 0.0003 0.0059
i CE 3004001 0.0046 0.0006 0.0115
i CE 3004002 0.0047 0.0004 0.0115
i CE 3004003 0.0055 0.0006 0.0116


##### And lets get the empirical dipole angles and orientations
      Note these are in pixels
      And also the angles are a bit funky
      These are w.r.t. the x-axis, dy/dx
      So -55.6 is (90 + 55.6) in our coordinate system
      # ACtually, just rerun these and get the angles right
g CA 1000001 dy<0 : dx=+0.458 dy=-0.693 d=0.834 ang=-55.698 n=840
g CA 1000001 dy>0 : dx=-0.390 dy=+0.601 d=0.722 ang=-55.627 n=847
g CB 1001001 dy<0 : dx=+0.423 dy=-0.800 d=0.916 ang=-61.678 n=540
g CB 1001001 dy>0 : dx=-0.515 dy=+0.948 d=1.109 ang=-61.756 n=603
g CD 1003001 dy<0 : dx=+0.139 dy=-0.978 d=1.005 ang=-79.572 n=616
g CD 1003001 dy>0 : dx=-0.114 dy=+0.985 d=1.006 ang=-77.625 n=566
g CE 1004001 dy<0 : dx=+0.029 dy=-0.778 d=0.788 ang=-85.395 n=878
g CE 1004001 dy>0 : dx=-0.040 dy=+0.844 d=0.846 ang=-83.252 n=832

r CA 2000001 dy<0 : dx=+0.152 dy=-0.185 d=0.245 ang=-51.882 n=80
r CA 2000001 dy>0 : dx=-0.650 dy=+0.945 d=1.148 ang=-57.964 n=16
r CB 2001001 dy<0 : dx=+0.164 dy=-0.133 d=0.211 ang=-39.046 n=5
r CB 2001001 dy>0 : dx=+1.500 dy=+4.000 d=5.608 ang=-34.099 n=4
r CD 2003001 dy<0 : dx=-4.500 dy=-3.500 d=5.854 ang=39.848 n=2
r CD 2003001 dy>0 : dx=-0.108 dy=+0.109 d=0.157 ang=-44.611 n=2
r CE 2004001 dy<0 : dx=+0.097 dy=-1.172 d=1.310 ang=-64.094 n=14
r CE 2004001 dy>0 : dx=-0.060 dy=+0.664 d=0.676 ang=-67.793 n=61

i CB 3001001 dy<0 : dx=+1.827 dy=-0.732 d=1.968 ang=-21.835 n=1
i CB 3001001 dy>0 : dx=+0.102 dy=+7.228 d=7.229 ang=89.193 n=1

g CA 1000002 dy<0 : dx=+0.708 dy=-1.039 d=1.297 ang=-55.794 n=417
g CA 1000002 dy>0 : dx=-0.559 dy=+0.840 d=1.018 ang=-55.917 n=456
g CB 1001002 dy<0 : dx=+0.546 dy=-1.084 d=1.215 ang=-62.242 n=211
g CB 1001002 dy>0 : dx=-0.605 dy=+1.179 d=1.332 ang=-62.490 n=264
g CD 1003002 dy<0 : dx=+0.197 dy=-1.242 d=1.270 ang=-78.559 n=282
g CD 1003002 dy>0 : dx=-0.182 dy=+1.226 d=1.256 ang=-77.609 n=220
g CE 1004002 dy<0 : dx=+0.041 dy=-1.056 d=1.065 ang=-84.899 n=515
g CE 1004002 dy>0 : dx=-0.052 dy=+1.162 d=1.174 ang=-82.319 n=467

g CA 1000003 dy<0 : dx=+0.539 dy=-0.890 d=1.040 ang=-55.932 n=59
g CA 1000003 dy>0 : dx=-0.850 dy=+1.170 d=1.466 ang=-56.580 n=93
g CB 1001003 dy<0 : dx=+0.476 dy=-1.392 d=1.531 ang=-62.092 n=6
g CB 1001003 dy>0 : dx=-0.680 dy=+1.282 d=1.451 ang=-62.063 n=5
g CD 1003003 dy<0 : dx=-0.009 dy=-0.935 d=0.963 ang=41.186 n=3
g CD 1003003 dy>0 : dx=-0.096 dy=+0.607 d=2.175 ang=-33.597 n=4
g CE 1004003 dy<0 : dx=+0.056 dy=-1.331 d=1.335 ang=-83.892 n=84
g CE 1004003 dy>0 : dx=-0.107 dy=+1.761 d=1.802 ang=-79.666 n=61


###########
# Actually, just rerun these and get the angles right
# And lets put the ampltidues in arcseconds not pixels.  

# Note: these results go directly into table tab:dcrang and tab:dcramp
g CA 1000001 dy<0 : dx=+0.458 dy=-0.693 d=0.167 ang=145.698 n=840
g CA 1000001 dy>0 : dx=-0.390 dy=+0.601 d=0.144 ang=325.627 n=847
g CB 1001001 dy<0 : dx=+0.423 dy=-0.800 d=0.183 ang=151.678 n=540
g CB 1001001 dy>0 : dx=-0.515 dy=+0.948 d=0.222 ang=331.779 n=603
g CD 1003001 dy<0 : dx=+0.139 dy=-0.978 d=0.201 ang=169.962 n=616
g CD 1003001 dy>0 : dx=-0.114 dy=+0.985 d=0.201 ang=349.304 n=566
g CE 1004001 dy<0 : dx=+0.029 dy=-0.778 d=0.158 ang=176.212 n=878
g CE 1004001 dy>0 : dx=-0.040 dy=+0.844 d=0.169 ang=355.229 n=832

r CA 2000001 dy<0 : dx=+0.152 dy=-0.185 d=0.049 ang=141.882 n=80
r CA 2000001 dy>0 : dx=-0.650 dy=+0.945 d=0.230 ang=327.964 n=16
r CB 2001001 dy<0 : dx=+0.164 dy=-0.133 d=0.042 ang=129.046 n=5
r CB 2001001 dy>0 : dx=+1.500 dy=+4.000 d=1.122 ang=319.581 n=4
r CD 2003001 dy<0 : dx=-4.500 dy=-3.500 d=1.171 ang=129.848 n=2
r CD 2003001 dy>0 : dx=-0.108 dy=+0.109 d=0.031 ang=314.611 n=2
r CE 2004001 dy<0 : dx=+0.097 dy=-1.172 d=0.262 ang=172.789 n=14
r CE 2004001 dy>0 : dx=-0.060 dy=+0.664 d=0.135 ang=345.908 n=61

i CB 3001001 dy<0 : dx=+1.827 dy=-0.732 d=0.394 ang=111.835 n=1
i CB 3001001 dy>0 : dx=+0.102 dy=+7.228 d=1.446 ang=359.193 n=1

g CA 1000002 dy<0 : dx=+0.708 dy=-1.039 d=0.259 ang=145.794 n=417
g CA 1000002 dy>0 : dx=-0.559 dy=+0.840 d=0.204 ang=325.926 n=456
g CB 1001002 dy<0 : dx=+0.546 dy=-1.084 d=0.243 ang=152.242 n=211
g CB 1001002 dy>0 : dx=-0.605 dy=+1.179 d=0.266 ang=332.490 n=264
g CD 1003002 dy<0 : dx=+0.197 dy=-1.242 d=0.254 ang=169.160 n=282
g CD 1003002 dy>0 : dx=-0.182 dy=+1.226 d=0.251 ang=348.742 n=220
g CE 1004002 dy<0 : dx=+0.041 dy=-1.056 d=0.213 ang=175.995 n=515
g CE 1004002 dy>0 : dx=-0.052 dy=+1.162 d=0.235 ang=355.166 n=467

g CA 1000003 dy<0 : dx=+0.539 dy=-0.890 d=0.208 ang=145.932 n=59
g CA 1000003 dy>0 : dx=-0.850 dy=+1.170 d=0.293 ang=326.638 n=93
g CB 1001003 dy<0 : dx=+0.476 dy=-1.392 d=0.306 ang=152.092 n=6
g CB 1001003 dy>0 : dx=-0.680 dy=+1.282 d=0.290 ang=332.063 n=5
g CD 1003003 dy<0 : dx=-0.009 dy=-0.935 d=0.193 ang=166.360 n=3
g CD 1003003 dy>0 : dx=-0.096 dy=+0.607 d=0.435 ang=316.879 n=4
g CE 1004003 dy<0 : dx=+0.056 dy=-1.331 d=0.267 ang=175.433 n=84
g CE 1004003 dy>0 : dx=-0.107 dy=+1.761 d=0.360 ang=352.758 n=61

#### Finally lets look at how much faster dipole measurement is:
# [becker@lsst-dev ~/Winter2014]$ python python/compareMeasurementTiming.py

g CB {'raft': '2,2', 'sensor': '0,0', 'visit': 1001002} 193 in 121 s (1.6/s) vs 193 in 8 s (23.2/s)  14.6
g CB {'raft': '2,2', 'sensor': '0,1', 'visit': 1001002} 164 in 155 s (1.1/s) vs 164 in 10 s (15.4/s)  14.6
g CB {'raft': '2,2', 'sensor': '0,2', 'visit': 1001002} 183 in 151 s (1.2/s) vs 183 in 9 s (19.4/s)  16.1
g CB {'raft': '2,2', 'sensor': '1,1', 'visit': 1001002} 164 in 111 s (1.5/s) vs 164 in 7 s (21.4/s)  14.6
g CB {'raft': '2,2', 'sensor': '1,2', 'visit': 1001002} 189 in 152 s (1.2/s) vs 189 in 9 s (20.9/s)  16.9
g CB {'raft': '2,2', 'sensor': '2,0', 'visit': 1001002} 159 in 160 s (1.0/s) vs 159 in 11 s (13.6/s)  13.7
g CB {'raft': '2,2', 'sensor': '2,1', 'visit': 1001002} 175 in 170 s (1.0/s) vs 175 in 8 s (20.5/s)  19.9
g CB {'raft': '2,2', 'sensor': '2,2', 'visit': 1001002} 166 in 126 s (1.3/s) vs 166 in 5 s (29.0/s)  22.2
g CD {'raft': '2,2', 'sensor': '0,0', 'visit': 1003002} 179 in 212 s (0.8/s) vs 179 in 10 s (16.5/s)  19.6
g CD {'raft': '2,2', 'sensor': '0,1', 'visit': 1003002} 164 in 173 s (0.9/s) vs 164 in 8 s (18.8/s)  19.9
g CD {'raft': '2,2', 'sensor': '0,2', 'visit': 1003002} 183 in 168 s (1.1/s) vs 183 in 9 s (19.4/s)  18.0
g CD {'raft': '2,2', 'sensor': '1,1', 'visit': 1003002} 164 in 183 s (0.9/s) vs 164 in 9 s (17.7/s)  19.8
g CD {'raft': '2,2', 'sensor': '1,2', 'visit': 1003002} 178 in 165 s (1.1/s) vs 178 in 7 s (23.3/s)  21.6
g CD {'raft': '2,2', 'sensor': '2,0', 'visit': 1003002} 153 in 193 s (0.8/s) vs 153 in 9 s (16.6/s)  21.1
g CD {'raft': '2,2', 'sensor': '2,1', 'visit': 1003002} 184 in 148 s (1.2/s) vs 184 in 8 s (20.5/s)  16.5
g CD {'raft': '2,2', 'sensor': '2,2', 'visit': 1003002} 167 in 122 s (1.4/s) vs 167 in 5 s (29.6/s)  21.7
g CE {'raft': '2,2', 'sensor': '2,2', 'visit': 1004003} 196 in 73 s (2.7/s) vs 196 in 2 s (91.2/s)  34.1
r CA {'raft': '2,2', 'sensor': '0,1', 'visit': 2000001} 76 in 48 s (1.6/s) vs 76 in 2 s (33.8/s)  21.7
r CA {'raft': '2,2', 'sensor': '0,2', 'visit': 2000001} 98 in 64 s (1.5/s) vs 98 in 1 s (54.7/s)  36.3
r CA {'raft': '2,2', 'sensor': '1,0', 'visit': 2000001} 98 in 37 s (2.6/s) vs 98 in 1 s (64.5/s)  24.7
r CA {'raft': '2,2', 'sensor': '1,1', 'visit': 2000001} 69 in 18 s (3.8/s) vs 69 in 1 s (60.0/s)  15.9
r CA {'raft': '2,2', 'sensor': '1,2', 'visit': 2000001} 78 in 36 s (2.1/s) vs 78 in 1 s (41.3/s)  19.2
r CA {'raft': '2,2', 'sensor': '2,0', 'visit': 2000001} 89 in 71 s (1.2/s) vs 89 in 1 s (47.8/s)  38.4
r CA {'raft': '2,2', 'sensor': '2,1', 'visit': 2000001} 76 in 41 s (1.8/s) vs 76 in 1 s (52.8/s)  29.2
r CA {'raft': '2,2', 'sensor': '2,2', 'visit': 2000001} 59 in 46 s (1.3/s) vs 59 in 2 s (24.5/s)  19.5
r CE {'raft': '2,2', 'sensor': '0,2', 'visit': 2004001} 65 in 38 s (1.7/s) vs 65 in 1 s (45.1/s)  26.8
r CE {'raft': '2,2', 'sensor': '1,0', 'visit': 2004001} 79 in 33 s (2.3/s) vs 79 in 2 s (29.2/s)  12.5
r CE {'raft': '2,2', 'sensor': '1,1', 'visit': 2004001} 59 in 36 s (1.6/s) vs 59 in 1 s (44.0/s)  27.2
r CE {'raft': '2,2', 'sensor': '1,2', 'visit': 2004001} 67 in 39 s (1.7/s) vs 67 in 1 s (42.9/s)  25.4
r CE {'raft': '2,2', 'sensor': '2,0', 'visit': 2004001} 68 in 35 s (1.9/s) vs 68 in 1 s (34.7/s)  18.3

# So this is the basic characterization.  Asked Jim and Russ to take
  care of the outstanding tickets. Need to spend a bit of time
  thinking about designing a class to handle the Dcr operations.  And
  also writing up the report on this.
